<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>LoCO by candycode</title>
    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
    <script src="javascripts/main.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

  </head>
  <body>

      <header>
        <h1>LoCO</h1>
        <p>JavaScript/C++ application framework</p>
      </header>

      <div id="banner">
        <span id="logo"></span>

        <a href="https://github.comhttp://github.com/candycode/loco" class="button fork"><strong>View On GitHub</strong></a>
        <div class="downloads">
          <span>Downloads:</span>
          <ul>
            <li><a href="https://github.comhttp://github.com/candycode/loco/zipball/master" class="button">ZIP</a></li>
            <li><a href="https://github.comhttp://github.com/candycode/loco/tarball/master" class="button">TAR</a></li>
          </ul>
        </div>
      </div><!-- end banner -->

    <div class="wrapper">
      <nav>
        <ul></ul>
      </nav>
      <section>
        <h2>LoCO - Loosely Coupled Objects</h2>

<p><em>LoCO</em> is a set of C++ classes that make it easy to create command-line and GUI
applications with any language that compiles to JavaScript.
JavaScript is used to glue together binary components, optionally loaded
at run-time, developed in C++.
Objects are connected through signals/slots or by direct reference through
a QObject pointer, giving to the objects the responsibility to check the
interface semantic or the object type.</p>

<h2>History and status</h2>

<p>This project started several years ago when I got tired of spending time
writing C/C++ code to build MVP/MVVM/MVC application logic and binding UI
events to callbacks with MOTIF/MFC/GTK/Qt/WPF... + a few mobile frameworks.
After some time spent experimenting with different scripting languages and their
bindings to GUI frameworks I settled on Qt for desktop applications simply because 
it's been and still is the fastest path to building cross-platform applications
scriptable in a widespread scripting language such as ECMAScript/JavaScript. </p>

<h3>Status</h3>

<p>The code you see here was physically extracted from a private project hosted on GitHub, so
the GitHub project you see is now what it used to be my private development branch and it is therefore a work in progress.</p>

<p>The current project is a stripped down, cleaned-up, partially rewritten
version of a larger and much garbled project which also had some Lua, 
Python, Tcl and Scheme bindings; the only additional parts I'm planning to move into the
new project are:</p>

<ul>
<li>OpenGL/OSG graphics view</li>
<li>OpenCL bindings</li>
<li>SQL and NoSQL database interfaces</li>
</ul><p>but I might make also available other pieces as brand new projects,
as I did with <a href="http://github.com/candycode/qlua">QLua</a> or code snippets as in the case of one
of my many <em><a href="http://github.com/candycode/typeless">Any type</a></em> implementation.</p>

<h2>License</h2>

<p><em>LoCO</em> is distributes under the terms of the <a href="http://github.com/candycode/loco/blob/master/license/README.md">New BSD License</a></p>

<h2>Main features</h2>

<p>Use JavaScript to invoke methods and access properties in QObject-derived
objects.</p>

<p>Connect:</p>

<ul>
<li>JavaScript signals to QObject slots</li>
<li>QObject signals to JavaScript functions</li>
<li>QObject signals to QObject slots </li>
</ul><p>Pass QObject pointers to QObject methods from JavaScript.</p>

<p>Load QObjects from binary plugins.</p>

<p>Distribute applications as a standalone executable with all the resources
stored in the executable itself.</p>

<p>Use standard Web tools to develp desktop applications.</p>

<h3>GUI</h3>

<p>The main GUI toolkit is intended to be WebKit but in order to support
native widgets a  number of wrappers are already available for 
accessing system dialogs and controls such as the MacOS drawer and top
level menu; more are being added. In the future it will be possible
to specify an entire native GUI through JSON and use <a href="http://knockoutjs.com">Knockoutjs</a>
to manage the user interface as done for web applications.</p>

<p>HUD-type interfaces are going to be supported through WebKit or 
QGraphicsWidgets layered on top of a QGraphicsView; a proof
of concept was implemented as a plugin, checkout the <em>gui.js</em>
and <em>gui.html</em> files <a href="http://github.com/candycode/loco/tree/master/modules/plugins/osgview/test">here</a>. </p>

<h3>WebKit integration</h3>

<p>WebKit is exposed to <em>LoCO</em> through a WebWindow object.</p>

<p>WebKit events are forwarded to the JavaScript context that creates
the WebKit window and can therefore be handled outside the WebKit
JavaScript context.</p>

<p>It is possible to <em>inject</em> JavaScript code and add QObject-derived types
at page loading time.</p>

<p>The page <em>DOM</em> tree is available and can be manipulated from outside
the page.</p>

<p>A custom plugin factory is available to add <em>LoCO</em> QWidgets directly into
a web page. <a href="http://github.com/candycode/loco/tree/master/modules/webplugins/osg-viewer">Example here</a>.</p>

<p><em>Note</em>: I plan to keep supporting the WebKit1 interface, not WebKit2
since it requires one additional process for each web page which is 
<strong>not</strong> something I want to have in a Desktop application. The current
version of QtWebKit based on WebKit 2.2 works well and will be supported
for quite some time anyway with commitments to fix all the high priority bugs.</p>

<p><strong>Sample code</strong>:</p>

<p>Load a webpage and change the <em>DOM</em> tree on the fly setting the background to yellow
and rotating all the <code>&lt;div&gt;</code> elements.</p>

<div class="highlight">
<pre><span class="k">try</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">print</span> <span class="o">=</span> <span class="nx">Loco</span><span class="p">.</span><span class="nx">console</span><span class="p">.</span><span class="nx">println</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">ctx</span> <span class="o">=</span> <span class="nx">Loco</span><span class="p">.</span><span class="nx">ctx</span><span class="p">;</span>

<span class="c1">// command line</span>
  <span class="kd">var</span> <span class="nx">cmdParam</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">cmdLine</span><span class="p">()[</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">cmdLine</span><span class="p">().</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
  <span class="kd">var</span> <span class="nx">WEBSITE</span> <span class="o">=</span> <span class="nx">cmdParam</span><span class="p">.</span><span class="nx">lastIndexOf</span><span class="p">(</span> <span class="s2">".js"</span> <span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span>
                <span class="nx">cmdParam</span> <span class="o">:</span> <span class="s2">"http://www.nyt.com"</span><span class="p">;</span>

<span class="c1">// create main window</span>
  <span class="kd">var</span> <span class="nx">ww</span> <span class="o">=</span> <span class="nx">Loco</span><span class="p">.</span><span class="nx">gui</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="s2">"WebWindow"</span> <span class="p">);</span>
<span class="c1">// setup main window</span>
  <span class="nx">ww</span><span class="p">.</span><span class="nx">setAttributes</span><span class="p">(</span> <span class="p">{</span><span class="nx">DeveloperExtrasEnabled</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                     <span class="nx">LocalContentCanAccessFileUrls</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                     <span class="nx">LocalContentCanAccessRemoteUrls</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
                     <span class="nx">AcceleratedCompositingEnabled</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">);</span>
  <span class="nx">ww</span><span class="p">.</span><span class="nx">setEnableContextMenu</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span>
  <span class="nx">ww</span><span class="p">.</span><span class="nx">setForwardKeyEvents</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span>
  <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nx">ww</span><span class="p">.</span><span class="nx">syncLoad</span><span class="p">(</span> <span class="nx">WEBSITE</span><span class="p">,</span> <span class="mi">5000</span> <span class="p">)</span> <span class="p">)</span> <span class="k">throw</span> <span class="s2">"Load failure"</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">elements</span> <span class="o">=</span> <span class="nx">ww</span><span class="p">.</span><span class="nx">findElements</span><span class="p">(</span> <span class="s2">"div"</span> <span class="p">);</span>
  <span class="nx">print</span><span class="p">(</span> <span class="nx">elements</span><span class="p">.</span><span class="nx">length</span> <span class="p">);</span>
  <span class="nx">print</span><span class="p">(</span> <span class="nx">elements</span><span class="p">[</span> <span class="mi">0</span> <span class="p">].</span><span class="nx">attributeNames</span><span class="p">()</span> <span class="p">);</span>
  <span class="nx">print</span><span class="p">(</span> <span class="nx">elements</span><span class="p">[</span> <span class="mi">0</span> <span class="p">].</span><span class="nb">eval</span><span class="p">(</span> <span class="s2">"this.id"</span> <span class="p">));</span>
  <span class="nx">elements</span> <span class="o">=</span> <span class="nx">ww</span><span class="p">.</span><span class="nx">forEachElement</span><span class="p">(</span> <span class="s2">"*"</span><span class="p">,</span> <span class="s2">"this.childNodes.length === 0"</span> <span class="p">);</span>
  <span class="nx">print</span><span class="p">(</span> <span class="nx">elements</span><span class="p">.</span><span class="nx">length</span> <span class="p">);</span>
  <span class="nx">elements</span> <span class="o">=</span> <span class="nx">ww</span><span class="p">.</span><span class="nx">forEachElement</span><span class="p">(</span> <span class="s2">"div"</span><span class="p">,</span> <span class="s2">"this.style.backgroundColor='yellow'; false;"</span> <span class="p">);</span>
  <span class="nx">print</span><span class="p">(</span> <span class="nx">elements</span><span class="p">.</span><span class="nx">length</span> <span class="p">);</span>
  <span class="nx">elements</span> <span class="o">=</span> <span class="nx">ww</span><span class="p">.</span><span class="nx">forEachElement</span><span class="p">(</span> <span class="s2">"div"</span><span class="p">,</span> <span class="s2">"this.style['-webkit-transform']='rotate(1deg)'; false;"</span> <span class="p">);</span>
  <span class="nx">print</span><span class="p">(</span> <span class="nx">elements</span><span class="p">.</span><span class="nx">length</span> <span class="p">);</span>
  <span class="nx">ww</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
<span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">Loco</span><span class="p">.</span><span class="nx">console</span><span class="p">.</span><span class="nx">printerrln</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
  <span class="nx">Loco</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span> <span class="o">-</span><span class="mi">1</span> <span class="p">);</span>
<span class="p">}</span>
</pre>
</div>


<h3>Filters</h3>

<p>The code/bytes passed to the <em>LoCO</em> intepreter are transformed trough
a chain of filters before the actual code is delivered to the interpreter.
This allows to e.g. load a source file and use Skulpt or CoffeeScript
to generate JavaScript code on the fly and further pass the generated
code to lint.</p>

<p><strong>Sample code</strong>: </p>

<ol>
<li>load coffeescript </li>
<li>create a filter named <em>coffeescript</em> which invokes the function <em>loco_coffeeCompile</em> defined in the last function parameter; such function takes care of the actual CoffeeScript -&gt; JavaScript translation</li>
<li>evaluate code from file telling <em>LoCO</em> that it has to be filtered with the <em>coffeescript</em> filter<br>
</li>
</ol><div class="highlight">
<pre><span class="k">try</span> <span class="p">{</span>
  <span class="nx">Loco</span><span class="p">.</span><span class="nx">console</span><span class="p">.</span><span class="nx">println</span><span class="p">(</span><span class="s2">"Interpreter: "</span> <span class="o">+</span> <span class="nx">Loco</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">jsInterpreterName</span><span class="p">()</span> <span class="p">);</span>
  <span class="kd">var</span> <span class="nx">WKIT</span> <span class="o">=</span> <span class="nx">Loco</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">jsInterpreterName</span><span class="p">().</span><span class="nx">indexOf</span><span class="p">(</span> <span class="s2">"webkit"</span> <span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="nx">Loco</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">include</span><span class="p">(</span> <span class="s2">"../../filters/coffee-script-1.2.js"</span> <span class="p">);</span>
  <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nx">WKIT</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nx">alert</span> <span class="o">=</span> <span class="nx">Loco</span><span class="p">.</span><span class="nx">console</span><span class="p">.</span><span class="nx">println</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="nx">CoffeeScript</span><span class="p">.</span><span class="nx">compile</span><span class="p">(</span> <span class="s2">"x = 32"</span><span class="p">,</span> <span class="p">{</span><span class="nx">bare</span><span class="o">:</span> <span class="kc">true</span><span class="p">}</span> <span class="p">);</span>
  <span class="nx">Loco</span><span class="p">.</span><span class="nx">console</span><span class="p">.</span><span class="nx">println</span><span class="p">(</span> <span class="s2">"COFFEE: x = 32\nJAVASCRIPT:\n"</span> <span class="o">+</span> <span class="nx">c</span> <span class="p">);</span>
  <span class="nx">Loco</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">addScriptFilter</span><span class="p">(</span> <span class="s2">"coffeescript"</span><span class="p">,</span> <span class="s2">"loco_coffeeCompile_"</span><span class="p">,</span>
                            <span class="s2">"function loco_coffeeCompile_( coffeeCode ) {"</span> <span class="o">+</span>
                            <span class="s2">" return CoffeeScript.compile( coffeeCode, {bare: true} );"</span> <span class="o">+</span>
                            <span class="s2">"}"</span> <span class="p">);</span>
  <span class="nx">Loco</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">evalFile</span><span class="p">(</span> <span class="s2">"./test5.coffee"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"coffeescript"</span><span class="p">]</span> <span class="p">);</span>
  <span class="nx">Loco</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span> <span class="mi">0</span> <span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span><span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>
  <span class="nx">Loco</span><span class="p">.</span><span class="nx">console</span><span class="p">.</span><span class="nx">printerrln</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>
  <span class="nx">Loco</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span> <span class="o">-</span><span class="mi">1</span> <span class="p">);</span>
<span class="p">}</span>
</pre>
</div>


<h3>Synchronous calls</h3>

<p>Where applicable I replaced async calls with callbacks with sync calls with
soft real-time guarantees i.e. invoke a synchronous function telling it how
long you are willing to wait for completion.</p>

<p>E.g.</p>

<div class="highlight">
<pre><span class="nx">webWindow</span><span class="p">.</span><span class="nx">syncLoad</span><span class="p">(</span> <span class="s2">"http://www.github.com"</span><span class="p">,</span> <span class="mi">5000</span> <span class="cm">/*ms*/</span> <span class="p">);</span>
</pre>
</div>


<h3>QtScript and JavaScriptCore(or V8) support</h3>

<p>JavaScript code can be run through either Qt's own script
engine or the JavaScript engine embedded in WebKit.
In both cases the code is JIT compiled before execution.</p>

<p>In case QtScript is used it is possible to remove dependencies on QtWebKit
and/or QtGUI.</p>

<p>JavaScript code can be evaluated from within JavaScript through
the <code>eval</code> function or(if exposed) <code>Context.eval</code>, in the
former case the code is interpreted, in the latter it goes through JIT
compilation.</p>

<h3>Nested contexts</h3>

<p>It is possible to create other JavaScript contexts from within
any existing JavaScript context and marshal data between parent
and child context. This allow the creation of sandboxed contexts
with only a subset of the JavaScript environment exposed to scripts.</p>

<p><strong>Sample code</strong>:</p>

<ol>
<li>create new context and install event handlers for errors or
javascript console messages</li>
<li>enable access to source code passed to the context itself
for evaluation</li>
<li>add objects to the context, including a reference to the context itself </li>
<li>evaluate the code in the new context</li>
</ol><div class="highlight">
<pre><span class="c1">//check type of current context(WebKit or QtScript)</span>
<span class="kd">var</span> <span class="nx">WEBKIT</span> <span class="o">=</span> 
  <span class="nx">Loco</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">jsInterpreterName</span><span class="p">().</span><span class="nx">indexOf</span><span class="p">(</span> <span class="s2">"webkit"</span> <span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> 
  <span class="nx">CONTEXT_TYPE</span> <span class="o">=</span> <span class="nx">WEBKIT</span> <span class="o">?</span> <span class="s2">"JavaScriptCoreContext"</span> <span class="o">:</span> <span class="s2">"QtScriptContext"</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">newCtx</span> <span class="o">=</span> <span class="nx">Loco</span><span class="p">.</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="nx">CONTEXT_TYPE</span> <span class="p">);</span>
<span class="nx">newCtx</span><span class="p">.</span><span class="nx">onError</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span> <span class="nx">err</span> <span class="p">);</span>
<span class="nx">newCtx</span><span class="p">.</span><span class="nx">javaScriptConsoleMessage</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span>
 <span class="kd">function</span><span class="p">(</span> <span class="nx">msg</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">src</span> <span class="p">)</span> <span class="p">{</span>
   <span class="nx">print</span><span class="p">(</span> <span class="nx">msg</span> <span class="o">+</span> <span class="s2">" at line "</span> <span class="o">+</span> <span class="nx">line</span> <span class="p">);</span>
 <span class="p">}</span> <span class="p">);</span>
<span class="nx">print</span><span class="p">(</span> <span class="s2">"Enable storage of source code passed for evaluation"</span> <span class="p">);</span>
<span class="nx">newCtx</span><span class="p">.</span><span class="nx">storeCode</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="nx">newCtx</span><span class="p">.</span><span class="nx">addObject</span><span class="p">(</span> <span class="nx">newCtx</span><span class="p">,</span> <span class="s2">"ctx"</span> <span class="p">);</span>
<span class="nx">print</span><span class="p">(</span> <span class="s2">"Added new context reference as 'ctx' into new context itself"</span> <span class="p">);</span>
<span class="nx">newCtx</span><span class="p">.</span><span class="nx">addObject</span><span class="p">(</span> <span class="nx">Loco</span><span class="p">.</span><span class="nx">console</span><span class="p">,</span> <span class="s2">"io"</span> <span class="p">);</span>
<span class="nx">print</span><span class="p">(</span> <span class="s2">"Added 'Loco.console' as 'io' into new context"</span> <span class="p">);</span>
<span class="kd">var</span> <span class="nx">CODE</span> <span class="o">=</span> <span class="s2">"io.println(ctx.code)"</span><span class="p">;</span>
<span class="nx">print</span><span class="p">(</span> <span class="s2">"Evaluating code '"</span> <span class="o">+</span> <span class="nx">CODE</span> <span class="o">+</span> <span class="s2">"' in new context"</span> <span class="p">);</span>
<span class="nx">newCtx</span><span class="p">.</span><span class="nb">eval</span><span class="p">(</span> <span class="nx">CODE</span> <span class="p">);</span> <span class="c1">//prints out code passed to newCtx itself!</span>
</pre>
</div>


<h3>Custom resource access manager</h3>

<p>Network and filesystem access is controlled by resource access managers
which can be configured through a regex engine or entirely replaced to:</p>

<ul>
<li>specify read/write access permissions for files and directories</li>
<li>restrict access to specific network resources</li>
<li>filter and log network requests</li>
</ul><p><strong>Sample code 1</strong>: enable file and network access from driver(C++) application</p>

<div class="highlight">
<pre><span class="p">...</span>
<span class="n">loco</span><span class="o">::</span><span class="n">App</span> <span class="n">app</span><span class="p">(</span> <span class="n">qtApp</span><span class="p">,</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argv</span> <span class="p">);</span>
<span class="cp">#ifdef ACCESS_TO_FILESYSTEM_ENABLED</span>
<span class="n">app</span><span class="p">.</span><span class="n">AddModuleToJS</span><span class="p">(</span> <span class="k">new</span> <span class="n">loco</span><span class="o">::</span><span class="n">FileSystem</span> <span class="p">);</span>
<span class="n">app</span><span class="p">.</span><span class="n">SetAllowFileAccess</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span>
<span class="n">app</span><span class="p">.</span><span class="n">SetFilterFileAccess</span><span class="p">(</span> <span class="kc">false</span> <span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef ACCESS_TO_NETWORK_ENABLED</span>
<span class="n">app</span><span class="p">.</span><span class="n">SetAllowNetAccess</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span>
<span class="n">app</span><span class="p">.</span><span class="n">SetFilterNetRequests</span><span class="p">(</span> <span class="kc">false</span> <span class="p">);</span>
<span class="n">app</span><span class="p">.</span><span class="n">AddModuleToJS</span><span class="p">(</span> <span class="k">new</span> <span class="n">loco</span><span class="o">::</span><span class="n">Network</span> <span class="p">);</span>
<span class="cp">#endif</span>

</pre>
</div>


<p><strong>Sample code 2</strong>: forbid read-write access to files with extension "<em>config</em>"</p>

<div class="highlight">
<pre><span class="p">...</span>
<span class="n">app</span><span class="p">.</span><span class="n">SetAllowFileAccess</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span>
<span class="n">app</span><span class="p">.</span><span class="n">SetFilterFileAccess</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span>
<span class="n">app</span><span class="p">.</span><span class="n">SetDenyFileRule</span><span class="p">(</span> <span class="n">QRegExp</span><span class="p">(</span> <span class="s">".*</span><span class="se">\\</span><span class="s">.config$"</span> <span class="p">),</span> <span class="n">QIODevice</span><span class="o">::</span><span class="n">ReadWrite</span> <span class="p">);</span>
</pre>
</div>


<p>Note that access control is not entirely exposed to JavaScript, to allow
for the creation of binaries that have built-in, user-configurable access
control at the interpreter level.</p>

<p>This is something I borrowed from the mobile environment, Desktop applications
are unfortunately still being developed with patterns from the 80s/90s with
no concept of security or access control, any desktop application can easily
access the file system to read and broadcast data over the internet with little control
over it, not to mention direct access to audio/video devices with no access protection
at all(this is something I'll be addessing in future releases).</p>

<h3>Custom protocols</h3>

<p>Custom protocol handlers can be installed in the web engine to allow
for addition of new schemes or filtering of requests for standard schemes.</p>

<p><strong>Sample code</strong>: create and install protocol handler</p>

<div class="highlight">
<pre><span class="kd">var</span> <span class="nx">customReqHandler</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="s2">"ProtocolHandler"</span> <span class="p">);</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nx">setEnableCustomProtocolHandlers</span><span class="p">(</span> <span class="kc">true</span> <span class="p">);</span>
<span class="nx">ctx</span><span class="p">.</span><span class="nx">addProtocolHandler</span><span class="p">(</span> <span class="s2">"myprotocol"</span><span class="p">,</span> <span class="nx">customReqHandler</span> <span class="p">);</span>
<span class="kd">function</span> <span class="nx">handleCustomRequest</span><span class="p">(</span> <span class="nx">req</span><span class="p">,</span> <span class="nx">reply</span> <span class="p">)</span> <span class="p">{</span>
  <span class="c1">//generate some text content</span>
  <span class="kd">var</span> <span class="nx">content</span> <span class="o">=</span> <span class="p">...</span>
  <span class="nx">reply</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span> <span class="s2">"ContentType"</span><span class="p">,</span> <span class="s2">"text/html; charset ASCII"</span> <span class="p">);</span>
  <span class="nx">reply</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span> <span class="s2">"ContentLength"</span><span class="p">,</span> <span class="nx">content</span><span class="p">.</span><span class="nx">length</span> <span class="p">);</span>
  <span class="nx">reply</span><span class="p">.</span><span class="nx">setContent</span><span class="p">(</span> <span class="nx">content</span> <span class="p">);</span>
  <span class="nx">reply</span><span class="p">.</span><span class="nx">setUrl</span><span class="p">(</span> <span class="s2">"file://"</span> <span class="p">);</span>
<span class="p">}</span> 
<span class="nx">customReqHandler</span><span class="p">.</span><span class="nx">handleRequest</span><span class="p">.</span><span class="nx">connect</span><span class="p">(</span> <span class="nx">handleCustomRequest</span> <span class="p">);</span>
</pre>
</div>


<p>Note that the custom protocol handler is added into the context <strong>not</strong>
the WebWindow: a scheme -&gt; network-request-handler map is stored
into the context itself, which allows to match schemes/protocols in
every WebWindow with the proper handler.</p>

<p>Overriding the standard <em>"http(s)"</em> scheme it is possible to create
proxys or embedded web applications with all the code written in
JavaScript.    </p>

<p>Example:</p>

<p><a href="http://github.com/candycode/loco/blob/master/apps/locoplay-scripts/test20-custom-protocol.js">Application</a></p>

<p><a href="http://github.com/candycode/loco/blob/master/apps/locoplay-scripts/test20-custom-protocol.html">Page</a></p>

<h3>Multithreading</h3>

<p>Scripts can be run in multiple contexts mapped to different threads.</p>

<p>Two thread objects currently available:</p>

<ul>
<li>
<em>Thread</em>: executes the code once and exits </li>
<li>
<em>Thread loop</em>: 

<ul>
<li>thread is created and put in a wait state</li>
<li>at each request for execution the code is executed and
the thread goes then back into the wait state </li>
</ul>
</li>
</ul><p>Input data are passed to threads through their parent context.</p>

<p>Results can be retrieved from the parent context/thread by:</p>

<ul>
<li>explicitly joining/sychronizing then reading whatever data shared with the thread</li>
<li>reading from the <em>thread.data</em> variable which implements future-like behavior and waits
until data become available</li>
</ul><p><a href="http://github.com/candycode/loco/blob/master/apps/locoplay-scripts/test23-thread-loop.js">A working example example</a>
is available.</p>

<h3>Network</h3>

<p>Support for tcp/udp sockets, http and ssl is included.</p>

<p>Sample code 1: http request</p>

<div class="highlight">
<pre><span class="kd">var</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">Loco</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="s2">"Http"</span> <span class="p">);</span>
<span class="kd">var</span> <span class="nx">reply</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span> <span class="s2">"http://www.marinij.com"</span><span class="p">,</span> <span class="mi">10000</span> <span class="p">);</span>
<span class="kd">var</span> <span class="nx">headers</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
<span class="k">for</span><span class="p">(</span> <span class="kd">var</span> <span class="nx">h</span> <span class="k">in</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">headers</span> <span class="p">)</span> <span class="p">{</span>
  <span class="nx">headers</span> <span class="o">+=</span> <span class="nx">h</span> <span class="o">+</span> <span class="s2">": "</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span> <span class="nx">h</span> <span class="p">]</span> <span class="p">)</span> <span class="nx">headers</span> <span class="o">+=</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span> <span class="nx">h</span> <span class="p">];</span>
  <span class="nx">headers</span> <span class="o">+=</span> <span class="s2">"\n"</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">if</span><span class="p">(</span> <span class="nx">headers</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="nx">fwrite</span><span class="p">(</span> <span class="s2">"test24-output-headers.txt"</span><span class="p">,</span> <span class="nx">headers</span> <span class="p">);</span>
<span class="nx">fwrite</span><span class="p">(</span> <span class="s2">"test24-output.html"</span><span class="p">,</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">content</span> <span class="p">);</span>
<span class="k">if</span><span class="p">(</span> <span class="nx">Loco</span><span class="p">.</span><span class="nx">gui</span> <span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">ww</span> <span class="o">=</span> <span class="nx">Loco</span><span class="p">.</span><span class="nx">gui</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="s2">"WebWindow"</span> <span class="p">);</span>
  <span class="nx">ww</span><span class="p">.</span><span class="nx">load</span><span class="p">(</span> <span class="s2">"test24-output.html"</span> <span class="p">);</span>
  <span class="nx">ww</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>
<span class="p">}</span>
</pre>
</div>


<p>Sample code 2: ssl socket</p>

<div class="highlight">
<pre><span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">Loco</span><span class="p">.</span><span class="nx">net</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="s2">"tcp-ssl-socket"</span> <span class="p">);</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">connectTo</span><span class="p">(</span> <span class="s2">"bugs.kde.org"</span><span class="p">,</span> <span class="mi">443</span><span class="p">,</span> <span class="mi">5000</span> <span class="p">);</span>
<span class="c1">//if ( !socket.waitForEncrypted( 50000 ) ) throw socket.errorMsg();</span>
<span class="nx">socket</span><span class="p">.</span><span class="nx">write</span><span class="p">(</span> <span class="s2">"GET / HTTP/1.1\r\n"</span><span class="o">+</span>
              <span class="s2">"Host: bugs.kde.org\r\n"</span><span class="o">+</span>
              <span class="s2">"Connection: Close\r\n\r\n"</span> <span class="p">);</span>
<span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>
<span class="k">while</span><span class="p">(</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">waitForReadyRead</span><span class="p">(</span> <span class="mi">5000</span> <span class="p">)</span> <span class="p">)</span> <span class="nx">data</span> <span class="o">+=</span> <span class="nx">socket</span><span class="p">.</span><span class="nx">readAll</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">suffixLength</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="nx">print</span><span class="p">(</span> <span class="nx">data</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="nx">suffixLength</span><span class="p">)</span> <span class="p">);</span> <span class="c1">//remove non printable chars</span>
<span class="nx">print</span><span class="p">(</span> <span class="s2">"done"</span> <span class="p">);</span>
</pre>
</div>


<p>A full SSL example is available as well:
 <a href="http://github.com/candycode/loco/blob/master/apps/locoplay-scripts/test28-ssl.js">encrypted fortune</a></p>

<p>It is also possible to use the WebWindow object as a headless web browser to
isssue http(s) requests, handle responses and save page snapshots to image or PDF
files from command line applications.</p>
      </section>
      <footer>
        <p>Project maintained by <a href="https://github.com/candycode">candycode</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="http://twitter.com/#!/michigangraham">mattgraham</a></small></p>
      </footer>
    </div>
    <!--[if !IE]><script>fixScale(document);</script><!--<![endif]-->
    
  </body>
</html>
