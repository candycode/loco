var BiwaScheme=BiwaScheme||{};BiwaScheme.Version="0.5.7";BiwaScheme.GitCommit="e145688f81e0844e1ff3543c69bf1612a516bf03";(function(){var root=this;var previousUnderscore=root._;var breaker={};var ArrayProto=Array.prototype,ObjProto=Object.prototype,FuncProto=Function.prototype;var slice=ArrayProto.slice,unshift=ArrayProto.unshift,toString=ObjProto.toString,hasOwnProperty=ObjProto.hasOwnProperty;var nativeForEach=ArrayProto.forEach,nativeMap=ArrayProto.map,nativeReduce=ArrayProto.reduce,nativeReduceRight=ArrayProto.reduceRight,nativeFilter=ArrayProto.filter,nativeEvery=ArrayProto.every,nativeSome=ArrayProto.some,nativeIndexOf=
ArrayProto.indexOf,nativeLastIndexOf=ArrayProto.lastIndexOf,nativeIsArray=Array.isArray,nativeKeys=Object.keys,nativeBind=FuncProto.bind;var _=function(obj){return new wrapper(obj)};if(typeof module!=="undefined"&&module.exports){module.exports=_;_._=_}else root["_"]=_;_.VERSION="1.1.7";var each=_.each=_.forEach=function(obj,iterator,context){if(obj==null)return;if(nativeForEach&&obj.forEach===nativeForEach)obj.forEach(iterator,context);else if(obj.length===+obj.length)for(var i=0,l=obj.length;i<
l;i++){if(i in obj&&iterator.call(context,obj[i],i,obj)===breaker)return}else for(var key in obj)if(hasOwnProperty.call(obj,key))if(iterator.call(context,obj[key],key,obj)===breaker)return};_.map=function(obj,iterator,context){var results=[];if(obj==null)return results;if(nativeMap&&obj.map===nativeMap)return obj.map(iterator,context);each(obj,function(value,index,list){results[results.length]=iterator.call(context,value,index,list)});return results};_.reduce=_.foldl=_.inject=function(obj,iterator,
memo,context){var initial=memo!==void 0;if(obj==null)obj=[];if(nativeReduce&&obj.reduce===nativeReduce){if(context)iterator=_.bind(iterator,context);return initial?obj.reduce(iterator,memo):obj.reduce(iterator)}each(obj,function(value,index,list){if(!initial){memo=value;initial=true}else memo=iterator.call(context,memo,value,index,list)});if(!initial)throw new TypeError("Reduce of empty array with no initial value");return memo};_.reduceRight=_.foldr=function(obj,iterator,memo,context){if(obj==null)obj=
[];if(nativeReduceRight&&obj.reduceRight===nativeReduceRight){if(context)iterator=_.bind(iterator,context);return memo!==void 0?obj.reduceRight(iterator,memo):obj.reduceRight(iterator)}var reversed=(_.isArray(obj)?obj.slice():_.toArray(obj)).reverse();return _.reduce(reversed,iterator,memo,context)};_.find=_.detect=function(obj,iterator,context){var result;any(obj,function(value,index,list){if(iterator.call(context,value,index,list)){result=value;return true}});return result};_.filter=_.select=function(obj,
iterator,context){var results=[];if(obj==null)return results;if(nativeFilter&&obj.filter===nativeFilter)return obj.filter(iterator,context);each(obj,function(value,index,list){if(iterator.call(context,value,index,list))results[results.length]=value});return results};_.reject=function(obj,iterator,context){var results=[];if(obj==null)return results;each(obj,function(value,index,list){if(!iterator.call(context,value,index,list))results[results.length]=value});return results};_.every=_.all=function(obj,
iterator,context){var result=true;if(obj==null)return result;if(nativeEvery&&obj.every===nativeEvery)return obj.every(iterator,context);each(obj,function(value,index,list){if(!(result=result&&iterator.call(context,value,index,list)))return breaker});return result};var any=_.some=_.any=function(obj,iterator,context){iterator=iterator||_.identity;var result=false;if(obj==null)return result;if(nativeSome&&obj.some===nativeSome)return obj.some(iterator,context);each(obj,function(value,index,list){if(result|=
iterator.call(context,value,index,list))return breaker});return!!result};_.include=_.contains=function(obj,target){var found=false;if(obj==null)return found;if(nativeIndexOf&&obj.indexOf===nativeIndexOf)return obj.indexOf(target)!=-1;any(obj,function(value){if(found=value===target)return true});return found};_.invoke=function(obj,method){var args=slice.call(arguments,2);return _.map(obj,function(value){return(method.call?method||value:value[method]).apply(value,args)})};_.pluck=function(obj,key){return _.map(obj,
function(value){return value[key]})};_.max=function(obj,iterator,context){if(!iterator&&_.isArray(obj))return Math.max.apply(Math,obj);var result={computed:-Infinity};each(obj,function(value,index,list){var computed=iterator?iterator.call(context,value,index,list):value;computed>=result.computed&&(result={value:value,computed:computed})});return result.value};_.min=function(obj,iterator,context){if(!iterator&&_.isArray(obj))return Math.min.apply(Math,obj);var result={computed:Infinity};each(obj,function(value,
index,list){var computed=iterator?iterator.call(context,value,index,list):value;computed<result.computed&&(result={value:value,computed:computed})});return result.value};_.sortBy=function(obj,iterator,context){return _.pluck(_.map(obj,function(value,index,list){return{value:value,criteria:iterator.call(context,value,index,list)}}).sort(function(left,right){var a=left.criteria,b=right.criteria;return a<b?-1:a>b?1:0}),"value")};_.groupBy=function(obj,iterator){var result={};each(obj,function(value,
index){var key=iterator(value,index);(result[key]||(result[key]=[])).push(value)});return result};_.sortedIndex=function(array,obj,iterator){iterator||(iterator=_.identity);var low=0,high=array.length;while(low<high){var mid=low+high>>1;iterator(array[mid])<iterator(obj)?low=mid+1:high=mid}return low};_.toArray=function(iterable){if(!iterable)return[];if(iterable.toArray)return iterable.toArray();if(_.isArray(iterable))return slice.call(iterable);if(_.isArguments(iterable))return slice.call(iterable);
return _.values(iterable)};_.size=function(obj){return _.toArray(obj).length};_.first=_.head=function(array,n,guard){return n!=null&&!guard?slice.call(array,0,n):array[0]};_.rest=_.tail=function(array,index,guard){return slice.call(array,index==null||guard?1:index)};_.last=function(array){return array[array.length-1]};_.compact=function(array){return _.filter(array,function(value){return!!value})};_.flatten=function(array){return _.reduce(array,function(memo,value){if(_.isArray(value))return memo.concat(_.flatten(value));
memo[memo.length]=value;return memo},[])};_.without=function(array){return _.difference(array,slice.call(arguments,1))};_.uniq=_.unique=function(array,isSorted){return _.reduce(array,function(memo,el,i){if(0==i||(isSorted===true?_.last(memo)!=el:!_.include(memo,el)))memo[memo.length]=el;return memo},[])};_.union=function(){return _.uniq(_.flatten(arguments))};_.intersection=_.intersect=function(array){var rest=slice.call(arguments,1);return _.filter(_.uniq(array),function(item){return _.every(rest,
function(other){return _.indexOf(other,item)>=0})})};_.difference=function(array,other){return _.filter(array,function(value){return!_.include(other,value)})};_.zip=function(){var args=slice.call(arguments);var length=_.max(_.pluck(args,"length"));var results=new Array(length);for(var i=0;i<length;i++)results[i]=_.pluck(args,""+i);return results};_.indexOf=function(array,item,isSorted){if(array==null)return-1;var i,l;if(isSorted){i=_.sortedIndex(array,item);return array[i]===item?i:-1}if(nativeIndexOf&&
array.indexOf===nativeIndexOf)return array.indexOf(item);for(i=0,l=array.length;i<l;i++)if(array[i]===item)return i;return-1};_.lastIndexOf=function(array,item){if(array==null)return-1;if(nativeLastIndexOf&&array.lastIndexOf===nativeLastIndexOf)return array.lastIndexOf(item);var i=array.length;while(i--)if(array[i]===item)return i;return-1};_.range=function(start,stop,step){if(arguments.length<=1){stop=start||0;start=0}step=arguments[2]||1;var len=Math.max(Math.ceil((stop-start)/step),0);var idx=
0;var range=new Array(len);while(idx<len){range[idx++]=start;start+=step}return range};_.bind=function(func,obj){if(func.bind===nativeBind&&nativeBind)return nativeBind.apply(func,slice.call(arguments,1));var args=slice.call(arguments,2);return function(){return func.apply(obj,args.concat(slice.call(arguments)))}};_.bindAll=function(obj){var funcs=slice.call(arguments,1);if(funcs.length==0)funcs=_.functions(obj);each(funcs,function(f){obj[f]=_.bind(obj[f],obj)});return obj};_.memoize=function(func,
hasher){var memo={};hasher||(hasher=_.identity);return function(){var key=hasher.apply(this,arguments);return hasOwnProperty.call(memo,key)?memo[key]:memo[key]=func.apply(this,arguments)}};_.delay=function(func,wait){var args=slice.call(arguments,2);return setTimeout(function(){return func.apply(func,args)},wait)};_.defer=function(func){return _.delay.apply(_,[func,1].concat(slice.call(arguments,1)))};var limit=function(func,wait,debounce){var timeout;return function(){var context=this,args=arguments;
var throttler=function(){timeout=null;func.apply(context,args)};if(debounce)clearTimeout(timeout);if(debounce||!timeout)timeout=setTimeout(throttler,wait)}};_.throttle=function(func,wait){return limit(func,wait,false)};_.debounce=function(func,wait){return limit(func,wait,true)};_.once=function(func){var ran=false,memo;return function(){if(ran)return memo;ran=true;return memo=func.apply(this,arguments)}};_.wrap=function(func,wrapper){return function(){var args=[func].concat(slice.call(arguments));
return wrapper.apply(this,args)}};_.compose=function(){var funcs=slice.call(arguments);return function(){var args=slice.call(arguments);for(var i=funcs.length-1;i>=0;i--)args=[funcs[i].apply(this,args)];return args[0]}};_.after=function(times,func){return function(){if(--times<1)return func.apply(this,arguments)}};_.keys=nativeKeys||function(obj){if(obj!==Object(obj))throw new TypeError("Invalid object");var keys=[];for(var key in obj)if(hasOwnProperty.call(obj,key))keys[keys.length]=key;return keys};
_.values=function(obj){return _.map(obj,_.identity)};_.functions=_.methods=function(obj){var names=[];for(var key in obj)if(_.isFunction(obj[key]))names.push(key);return names.sort()};_.extend=function(obj){each(slice.call(arguments,1),function(source){for(var prop in source)if(source[prop]!==void 0)obj[prop]=source[prop]});return obj};_.defaults=function(obj){each(slice.call(arguments,1),function(source){for(var prop in source)if(obj[prop]==null)obj[prop]=source[prop]});return obj};_.clone=function(obj){return _.isArray(obj)?
obj.slice():_.extend({},obj)};_.tap=function(obj,interceptor){interceptor(obj);return obj};_.isEqual=function(a,b){if(a===b)return true;var atype=typeof a,btype=typeof b;if(atype!=btype)return false;if(a==b)return true;if(!a&&b||a&&!b)return false;if(a._chain)a=a._wrapped;if(b._chain)b=b._wrapped;if(a.isEqual)return a.isEqual(b);if(b.isEqual)return b.isEqual(a);if(_.isDate(a)&&_.isDate(b))return a.getTime()===b.getTime();if(_.isNaN(a)&&_.isNaN(b))return false;if(_.isRegExp(a)&&_.isRegExp(b))return a.source===
b.source&&a.global===b.global&&a.ignoreCase===b.ignoreCase&&a.multiline===b.multiline;if(atype!=="object")return false;if(a.length&&a.length!==b.length)return false;var aKeys=_.keys(a),bKeys=_.keys(b);if(aKeys.length!=bKeys.length)return false;for(var key in a)if(!(key in b)||!_.isEqual(a[key],b[key]))return false;return true};_.isEmpty=function(obj){if(_.isArray(obj)||_.isString(obj))return obj.length===0;for(var key in obj)if(hasOwnProperty.call(obj,key))return false;return true};_.isElement=function(obj){return!!(obj&&
obj.nodeType==1)};_.isArray=nativeIsArray||function(obj){return toString.call(obj)==="[object Array]"};_.isObject=function(obj){return obj===Object(obj)};_.isArguments=function(obj){return!!(obj&&hasOwnProperty.call(obj,"callee"))};_.isFunction=function(obj){return!!(obj&&obj.constructor&&obj.call&&obj.apply)};_.isString=function(obj){return!!(obj===""||obj&&obj.charCodeAt&&obj.substr)};_.isNumber=function(obj){return!!(obj===0||obj&&obj.toExponential&&obj.toFixed)};_.isNaN=function(obj){return obj!==
obj};_.isBoolean=function(obj){return obj===true||obj===false};_.isDate=function(obj){return!!(obj&&obj.getTimezoneOffset&&obj.setUTCFullYear)};_.isRegExp=function(obj){return!!(obj&&obj.test&&obj.exec&&(obj.ignoreCase||obj.ignoreCase===false))};_.isNull=function(obj){return obj===null};_.isUndefined=function(obj){return obj===void 0};_.noConflict=function(){root._=previousUnderscore;return this};_.identity=function(value){return value};_.times=function(n,iterator,context){for(var i=0;i<n;i++)iterator.call(context,
i)};_.mixin=function(obj){each(_.functions(obj),function(name){addToWrapper(name,_[name]=obj[name])})};var idCounter=0;_.uniqueId=function(prefix){var id=idCounter++;return prefix?prefix+id:id};_.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g};_.template=function(str,data){var c=_.templateSettings;var tmpl="var __p=[],print=function(){__p.push.apply(__p,arguments);};"+"with(obj||{}){__p.push('"+str.replace(/\\/g,"\\\\").replace(/'/g,"\\'").replace(c.interpolate,function(match,
code){return"',"+code.replace(/\\'/g,"'")+",'"}).replace(c.evaluate||null,function(match,code){return"');"+code.replace(/\\'/g,"'").replace(/[\r\n\t]/g," ")+"__p.push('"}).replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/\t/g,"\\t")+"');}return __p.join('');";var func=new Function("obj",tmpl);return data?func(data):func};var wrapper=function(obj){this._wrapped=obj};_.prototype=wrapper.prototype;var result=function(obj,chain){return chain?_(obj).chain():obj};var addToWrapper=function(name,func){wrapper.prototype[name]=
function(){var args=slice.call(arguments);unshift.call(args,this._wrapped);return result(func.apply(_,args),this._chain)}};_.mixin(_);each(["pop","push","reverse","shift","sort","splice","unshift"],function(name){var method=ArrayProto[name];wrapper.prototype[name]=function(){method.apply(this._wrapped,arguments);return result(this._wrapped,this._chain)}});each(["concat","join","slice"],function(name){var method=ArrayProto[name];wrapper.prototype[name]=function(){return result(method.apply(this._wrapped,
arguments),this._chain)}});wrapper.prototype.chain=function(){this._chain=true;return this};wrapper.prototype.value=function(){return this._wrapped}})();(function(){var root=this;var nativeTrim=String.prototype.trim;var parseNumber=function(source){return source*1||0};function str_repeat(i,m){for(var o=[];m>0;o[--m]=i);return o.join("")}function defaultToWhiteSpace(characters){if(characters)return _s.escapeRegExp(characters);return"\\s"}var _s={isBlank:function(str){return!!str.match(/^\s*$/)},capitalize:function(str){return str.charAt(0).toUpperCase()+str.substring(1).toLowerCase()},chop:function(str,step){step=step||str.length;var arr=[];for(var i=
0;i<str.length;){arr.push(str.slice(i,i+step));i=i+step}return arr},clean:function(str){return _s.strip(str.replace(/\s+/g," "))},count:function(str,substr){var count=0,index;for(var i=0;i<str.length;){index=str.indexOf(substr,i);index>=0&&count++;i=i+(index>=0?index:0)+substr.length}return count},chars:function(str){return str.split("")},escapeHTML:function(str){return String(str||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")},unescapeHTML:function(str){return String(str||
"").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&apos;/g,"'")},escapeRegExp:function(str){return String(str||"").replace(/([-.*+?^${}()|[\]\/\\])/g,"\\$1")},insert:function(str,i,substr){var arr=str.split("");arr.splice(i,0,substr);return arr.join("")},includes:function(str,needle){return str.indexOf(needle)!==-1},join:function(sep){sep=String(sep);var str="";for(var i=1;i<arguments.length;i+=1){str+=String(arguments[i]);if(i!==arguments.length-
1)str+=sep}return str},lines:function(str){return str.split("\n")},splice:function(str,i,howmany,substr){var arr=str.split("");arr.splice(i,howmany,substr);return arr.join("")},startsWith:function(str,starts){return str.length>=starts.length&&str.substring(0,starts.length)===starts},endsWith:function(str,ends){return str.length>=ends.length&&str.substring(str.length-ends.length)===ends},succ:function(str){var arr=str.split("");arr.splice(str.length-1,1,String.fromCharCode(str.charCodeAt(str.length-
1)+1));return arr.join("")},titleize:function(str){var arr=str.split(" "),word;for(var i=0;i<arr.length;i++){word=arr[i].split("");if(typeof word[0]!=="undefined")word[0]=word[0].toUpperCase();i+1===arr.length?arr[i]=word.join(""):arr[i]=word.join("")+" "}return arr.join("")},camelize:function(str){return _s.trim(str).replace(/(\-|_|\s)+(.)?/g,function(match,separator,chr){return chr?chr.toUpperCase():""})},underscored:function(str){return _s.trim(str).replace(/([a-z\d])([A-Z]+)/g,"$1_$2").replace(/\-|\s+/g,
"_").toLowerCase()},dasherize:function(str){return _s.trim(str).replace(/([a-z\d])([A-Z]+)/g,"$1-$2").replace(/^([A-Z]+)/,"-$1").replace(/\_|\s+/g,"-").toLowerCase()},trim:function(str,characters){if(!characters&&nativeTrim)return nativeTrim.call(str);characters=defaultToWhiteSpace(characters);return str.replace(new RegExp("^["+characters+"]+|["+characters+"]+$","g"),"")},ltrim:function(str,characters){characters=defaultToWhiteSpace(characters);return str.replace(new RegExp("^["+characters+"]+","g"),
"")},rtrim:function(str,characters){characters=defaultToWhiteSpace(characters);return str.replace(new RegExp("["+characters+"]+$","g"),"")},truncate:function(str,length,truncateStr){truncateStr=truncateStr||"...";return str.slice(0,length)+truncateStr},words:function(str,delimiter){delimiter=delimiter||" ";return str.split(delimiter)},pad:function(str,length,padStr,type){var padding="";var padlen=0;if(!padStr)padStr=" ";else if(padStr.length>1)padStr=padStr[0];switch(type){case "right":padlen=length-
str.length;padding=str_repeat(padStr,padlen);str=str+padding;break;case "both":padlen=length-str.length;padding={"left":str_repeat(padStr,Math.ceil(padlen/2)),"right":str_repeat(padStr,Math.floor(padlen/2))};str=padding.left+str+padding.right;break;default:padlen=length-str.length;padding=str_repeat(padStr,padlen);str=padding+str}return str},lpad:function(str,length,padStr){return _s.pad(str,length,padStr)},rpad:function(str,length,padStr){return _s.pad(str,length,padStr,"right")},lrpad:function(str,
length,padStr){return _s.pad(str,length,padStr,"both")},sprintf:function(){var i=0,a,f=arguments[i++],o=[],m,p,c,x,s="";while(f){if(m=/^[^\x25]+/.exec(f))o.push(m[0]);else if(m=/^\x25{2}/.exec(f))o.push("%");else if(m=/^\x25(?:(\d+)\$)?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(f)){if((a=arguments[m[1]||i++])==null||a==undefined)throw"Too few arguments.";if(/[^s]/.test(m[7])&&typeof a!="number")throw"Expecting number but found "+typeof a;switch(m[7]){case "b":a=a.toString(2);break;case "c":a=
String.fromCharCode(a);break;case "d":a=parseInt(a);break;case "e":a=m[6]?a.toExponential(m[6]):a.toExponential();break;case "f":a=m[6]?parseFloat(a).toFixed(m[6]):parseFloat(a);break;case "o":a=a.toString(8);break;case "s":a=(a=String(a))&&m[6]?a.substring(0,m[6]):a;break;case "u":a=Math.abs(a);break;case "x":a=a.toString(16);break;case "X":a=a.toString(16).toUpperCase();break}a=/[def]/.test(m[7])&&m[2]&&a>=0?"+"+a:a;c=m[3]?m[3]=="0"?"0":m[3].charAt(1):" ";x=m[5]-String(a).length-s.length;p=m[5]?
str_repeat(c,x):"";o.push(s+(m[4]?a+p:p+a))}else throw"Huh ?!";f=f.substring(m[0].length)}return o.join("")},toNumber:function(str,decimals){return parseNumber(parseNumber(str).toFixed(parseNumber(decimals)))},strRight:function(sourceStr,sep){var pos=!sep?-1:sourceStr.indexOf(sep);return pos!=-1?sourceStr.slice(pos+sep.length,sourceStr.length):sourceStr},strRightBack:function(sourceStr,sep){var pos=!sep?-1:sourceStr.lastIndexOf(sep);return pos!=-1?sourceStr.slice(pos+sep.length,sourceStr.length):
sourceStr},strLeft:function(sourceStr,sep){var pos=!sep?-1:sourceStr.indexOf(sep);return pos!=-1?sourceStr.slice(0,pos):sourceStr},strLeftBack:function(sourceStr,sep){var pos=sourceStr.lastIndexOf(sep);return pos!=-1?sourceStr.slice(0,pos):sourceStr}};_s.strip=_s.trim;_s.lstrip=_s.ltrim;_s.rstrip=_s.rtrim;_s.center=_s.lrpad;_s.ljust=_s.lpad;_s.rjust=_s.rpad;if(typeof window==="undefined"&&typeof module!=="undefined")module.exports=_s;else if(typeof root._!=="undefined")root._.mixin(_s);else root._=
_s})();BiwaScheme.Class={create:function(methods){var klass=function(){this.initialize.apply(this,arguments)};_.extend(klass.prototype,methods);return klass},extend:function(parent,methods){var klass=function(){this.initialize.apply(this,arguments)};klass.prototype=parent;_.extend(klass.prototype,methods);return klass}};if(typeof Console==="undefined");function puts(str,no_newline){Console.puts(str,no_newline)}function p(){Console.p.apply(this,arguments)}BiwaScheme.TopEnv={};BiwaScheme.CoreEnv={};BiwaScheme.Error=BiwaScheme.Class.create({initialize:function(msg){this.message="Error: "+msg},toString:function(){return this.message}});BiwaScheme.Bug=BiwaScheme.Class.extend(new BiwaScheme.Error,{initialize:function(msg){this.message="[BUG] "+msg}});
BiwaScheme.UserError=BiwaScheme.Class.extend(new BiwaScheme.Error,{initialize:function(msg){this.message=msg}});BiwaScheme.inspect=function(object){try{if(_.isUndefined(object))return"undefined";if(object===null)return"null";if(object.inspect)return object.inspect();if(_.isString(object))return"'"+object.replace(/'/g,"\\'")+"'";if(_.isArray(object))return"["+_.map(object,BiwaScheme.inspect).join(", ")+"]";return object.toString()}catch(e){if(e instanceof RangeError)return"...";throw e;}};BiwaScheme.Set=BiwaScheme.Class.create({initialize:function(){this.arr=[];var i;for(i=0;i<arguments.length;i++)this.arr[i]=arguments[i]},equals:function(other){if(this.arr.length!=other.arr.length)return false;var a1=_.clone(this.arr);var a2=_.clone(other.arr);a1.sort();a2.sort();for(var i=0;i<this.arr.length;i++)if(a1[i]!=a2[i])return false;return true},set_cons:function(item){var o=new BiwaScheme.Set(item);o.arr=_.clone(this.arr);o.arr.push(item);return o},set_union:function(){var o=new BiwaScheme.Set;
o.arr=_.clone(this.arr);for(var k=0;k<arguments.length;k++){var s2=arguments[k];if(!s2 instanceof BiwaScheme.Set)throw new BiwaScheme.Error("set_union: arguments must be a set");for(var i=0;i<s2.arr.length;i++)o.add(s2.arr[i])}return o},set_intersect:function(s2){if(!s2 instanceof BiwaScheme.Set)throw new BiwaScheme.Error("set_intersect: arguments must be a set");var o=new BiwaScheme.Set;for(var i=0;i<this.arr.length;i++)if(s2.member(this.arr[i]))o.add(this.arr[i]);return o},set_minus:function(s2){if(!s2 instanceof
BiwaScheme.Set)throw new BiwaScheme.Error("set_minus: arguments must be a set");var o=new BiwaScheme.Set;for(var i=0;i<this.arr.length;i++)if(!s2.member(this.arr[i]))o.add(this.arr[i]);return o},add:function(item){if(!this.member(item))this.arr.push(item)},member:function(item){for(var i=0;i<this.arr.length;i++)if(this.arr[i]==item)return true;return false},rindex:function(item){for(var i=this.arr.length-1;i>=0;i--)if(this.arr[i]==item)return this.arr.length-1-i;return null},index:function(item){for(var i=
0;i<this.arr.length;i++)if(this.arr[i]==item)return i;return null},inspect:function(){return"Set("+this.arr.join(", ")+")"},toString:function(){return this.inspect()},size:function(){return this.arr.length}});BiwaScheme.to_write=function(obj){if(obj===undefined)return"undefined";else if(obj===null)return"null";else if(_.isFunction(obj))return"#<Function "+(obj.fname?obj.fname:obj.toSource?_.truncate(obj.toSource(),40):"")+">";else if(_.isString(obj))return'"'+obj.replace(/\\|\"/g,function($0){return"\\"+$0}).replace(/\x07/g,"\\a").replace(/\x08/g,"\\b").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\v/g,"\\v").replace(/\f/g,"\\f").replace(/\r/g,"\\r")+'"';else if(_.isArray(obj)&&obj.closure_p)return"#<Closure>";
else if(_.isArray(obj))return"#("+_.map(obj,function(e){return BiwaScheme.to_write(e)}).join(" ")+")";else if(typeof obj.to_write=="function")return obj.to_write();else if(isNaN(obj)&&typeof obj=="number")return"+nan.0";else switch(obj){case true:return"#t";case false:return"#f";case Infinity:return"+inf.0";case -Infinity:return"-inf.0"}return BiwaScheme.inspect(obj)};
BiwaScheme.to_display=function(obj){if(typeof obj.valueOf()=="string")return obj;else if(obj instanceof BiwaScheme.Symbol)return obj.name;else if(obj instanceof Array)return"#("+_.map(obj,BiwaScheme.to_display).join(" ")+")";else if(obj instanceof BiwaScheme.Pair)return obj.inspect(BiwaScheme.to_display);else if(obj instanceof BiwaScheme.Char)return obj.value;else return BiwaScheme.to_write(obj)};
BiwaScheme.write_ss=function(obj,array_mode){var known=[obj],used=[false];BiwaScheme.find_cyclic(obj,known,used);var cyclic=BiwaScheme.reduce_cyclic_info(known,used);var appeared=new Array(cyclic.length);for(var i=cyclic.length-1;i>=0;i--)appeared[i]=false;return BiwaScheme.to_write_ss(obj,cyclic,appeared,array_mode)};
BiwaScheme.to_write_ss=function(obj,cyclic,appeared,array_mode){var ret="";var i=cyclic.indexOf(obj);if(i>=0)if(appeared[i])return"#"+i+"#";else{appeared[i]=true;ret="#"+i+"="}if(obj instanceof BiwaScheme.Pair){var a=[];a.push(BiwaScheme.to_write_ss(obj.car,cyclic,appeared,array_mode));for(var o=obj.cdr;o!=BiwaScheme.nil;o=o.cdr){if(!(o instanceof BiwaScheme.Pair)||cyclic.indexOf(o)>=0){a.push(".");a.push(BiwaScheme.to_write_ss(o,cyclic,appeared,array_mode));break}a.push(BiwaScheme.to_write_ss(o.car,
cyclic,appeared,array_mode))}ret+="("+a.join(" ")+")"}else if(obj instanceof Array){var a=_.map(obj,function(item){return BiwaScheme.to_write_ss(item,cyclic,appeared,array_mode)});if(array_mode)ret+="["+a.join(", ")+"]";else ret+="#("+a.join(" ")+")"}else ret+=BiwaScheme.to_write(obj);return ret};BiwaScheme.reduce_cyclic_info=function(known,used){var n_used=0;for(var i=0;i<used.length;i++)if(used[i]){known[n_used]=known[i];n_used++}return known.slice(0,n_used)};
BiwaScheme.find_cyclic=function(obj,known,used){var items=obj instanceof BiwaScheme.Pair?[obj.car,obj.cdr]:obj instanceof Array?obj:null;if(!items)return;_.each(items,function(item){if(typeof item=="number"||typeof item=="string"||item===BiwaScheme.undef||item===true||item===false||item===BiwaScheme.nil||item instanceof BiwaScheme.Symbol)return;var i=known.indexOf(item);if(i>=0)used[i]=true;else{known.push(item);used.push(false);BiwaScheme.find_cyclic(item,known,used)}})};BiwaScheme.Pair=BiwaScheme.Class.create({initialize:function(car,cdr){this.car=car;this.cdr=cdr},caar:function(){return this.car.car},cadr:function(){return this.cdr.car},cdar:function(){return this.cdr.car},cddr:function(){return this.cdr.cdr},first:function(){return this.car},second:function(){return this.cdr.car},third:function(){return this.cdr.cdr.car},fourth:function(){return this.cdr.cdr.cdr.car},fifth:function(){return this.cdr.cdr.cdr.cdr.car},to_array:function(){var ary=[];for(var o=this;o instanceof
BiwaScheme.Pair;o=o.cdr)ary.push(o.car);return ary},to_set:function(){var set=new BiwaScheme.Set;for(var o=this;o instanceof BiwaScheme.Pair;o=o.cdr)set.add(o.car);return set},length:function(){var n=0;for(var o=this;o instanceof BiwaScheme.Pair;o=o.cdr)n++;return n},foreach:function(func){for(var o=this;o instanceof BiwaScheme.Pair;o=o.cdr)func(o.car);return o},map:function(func){var ary=[];for(var o=this;BiwaScheme.isPair(o);o=o.cdr)ary.push(func(o.car));return ary},concat:function(list){var o=
this;while(o instanceof BiwaScheme.Pair&&o.cdr!=BiwaScheme.nil)o=o.cdr;o.cdr=list;return this},inspect:function(conv){conv||(conv=BiwaScheme.inspect);var a=[];var last=this.foreach(function(o){a.push(conv(o))});if(last!=BiwaScheme.nil){a.push(".");a.push(conv(last))}return"("+a.join(" ")+")"},toString:function(){return this.inspect()},to_write:function(){return this.inspect(BiwaScheme.to_write)}});
var array_to_list=function(ary,deep){var list=BiwaScheme.nil;for(var i=ary.length-1;i>=0;i--){var obj=ary[i];if(deep&&_.isArray(obj)&&!obj.is_vector)obj=BiwaScheme.array_to_list(obj);list=new BiwaScheme.Pair(obj,list)}return list};BiwaScheme.List=function(){var ary=_.toArray(arguments);return array_to_list(ary,true)};BiwaScheme.array_to_list=function(array){return BiwaScheme.List.apply(null,array)};BiwaScheme.shallow_array_to_list=function(ary){return array_to_list(ary,false)};BiwaScheme.Values=BiwaScheme.Class.create({initialize:function(values){this.content=values},to_write:function(){return"#<Values "+_.map(this.content,BiwaScheme.to_write).join(" ")+">"}});BiwaScheme.nil={toString:function(){return"nil"},to_write:function(){return"()"},to_array:function(){return[]},length:function(){return 0}};BiwaScheme.undef=new Object;BiwaScheme.undef.toString=function(){return"#<undef>"};BiwaScheme.eof=new Object;BiwaScheme.Symbol=BiwaScheme.Class.create({initialize:function(str){this.name=str;BiwaScheme.Symbols[str]=this},inspect:function(){return"'"+this.name},toString:function(){return"'"+this.name},to_write:function(){return this.name}});BiwaScheme.Symbols={};BiwaScheme.Sym=function(name,leaveCase){if(BiwaScheme.Symbols[name]===undefined)return new BiwaScheme.Symbol(name);else if(!(BiwaScheme.Symbols[name]instanceof BiwaScheme.Symbol))return new BiwaScheme.Symbol(name);else return BiwaScheme.Symbols[name]};
BiwaScheme.gensyms=0;BiwaScheme.gensym=function(){BiwaScheme.gensyms++;return BiwaScheme.Sym("__gensym_"+BiwaScheme.gensyms)};BiwaScheme.Char=BiwaScheme.Class.create({initialize:function(c){BiwaScheme.Chars[this.value=c]=this},to_write:function(){switch(this.value){case "\n":return"#\\newline";case " ":return"#\\space";case "\t":return"#\\tab";default:return"#\\"+this.value}},inspect:function(){return this.to_write()}});BiwaScheme.Chars={};
BiwaScheme.Char.get=function(c){if(typeof c!="string")throw new BiwaScheme.Bug("Char.get: "+BiwaScheme.inspect(c)+" is not a string");if(BiwaScheme.Chars[c]===undefined)return new BiwaScheme.Char(c);else return BiwaScheme.Chars[c]};BiwaScheme.Complex=BiwaScheme.Class.create({initialize:function(real,imag){this.real=real;this.imag=imag},magnitude:function(){return Math.sqrt(this.real*this.real+this.imag*this.imag)},angle:function(){return Math.acos(this.real/this.magnitude())}});BiwaScheme.Complex.from_polar=function(r,theta){var real=r*Math.cos(theta);var imag=r*Math.sin(theta);return new BiwaScheme.Complex(real,imag)};
BiwaScheme.Complex.assure=function(num){if(num instanceof BiwaScheme.Complex)return num;else return new BiwaScheme.Complex(num,0)};BiwaScheme.Rational=BiwaScheme.Class.create({initialize:function(numerator,denominator){this.numerator=numerator;this.denominator=denominator}});BiwaScheme.Port=BiwaScheme.Class.create({initialize:function(is_in,is_out){this.is_open=true;this.is_binary=false;this.is_input=is_in;this.is_output=is_out},close:function(){this.is_open=false},inspect:function(){return"#<Port>"},to_write:function(){return"#<Port>"}});
BiwaScheme.Port.BrowserInput=BiwaScheme.Class.extend(new BiwaScheme.Port(true,false),{initialize:function(){},get_string:function(after){var form=$("<form/>");form.html("<input id='webscheme-read-line' type='text'><input type='submit' value='ok'>");$("#bs-console").append(form);return new BiwaScheme.Pause(function(pause){form.submit(function(){var input=$("#webscheme-read-line").val();form.remove();puts(input);pause.resume(after(input));return false})})}});
BiwaScheme.Port.DefaultOutput=BiwaScheme.Class.extend(new BiwaScheme.Port(false,true),{initialize:function(){},put_string:function(str){puts(str,true)}});BiwaScheme.Port.StringOutput=BiwaScheme.Class.extend(new BiwaScheme.Port(false,true),{initialize:function(){this.buffer=[]},put_string:function(str){this.buffer.push(str)},output_string:function(str){return this.buffer.join("")}});
BiwaScheme.Port.StringInput=BiwaScheme.Class.extend(new BiwaScheme.Port(true,false),{initialize:function(str){this.str=str},get_string:function(after){return after(this.str)}});BiwaScheme.Port.current_input=new BiwaScheme.Port.BrowserInput;BiwaScheme.Port.current_output=new BiwaScheme.Port.DefaultOutput;BiwaScheme.Port.current_error=new BiwaScheme.Port.DefaultOutput;BiwaScheme.Record=BiwaScheme.Class.create({initialize:function(rtd,values){assert_record_td(rtd,"new Record");this.rtd=rtd;this.fields=values},get:function(k){return this.fields[k]},set:function(k,v){this.fields[k]=v},toString:function(){var contents=BiwaScheme.to_write(this.fields);return"#<Record "+this.rtd.name+" "+contents+">"}});BiwaScheme.isRecord=function(o){return o instanceof BiwaScheme.Record};BiwaScheme.Record._DefinedTypes={};
BiwaScheme.Record.define_type=function(name_str,rtd,cd){return BiwaScheme.Record._DefinedTypes[name_str]={rtd:rtd,cd:cd}};BiwaScheme.Record.get_type=function(name_str){return BiwaScheme.Record._DefinedTypes[name_str]};
BiwaScheme.Record.RTD=BiwaScheme.Class.create({initialize:function(name,parent_rtd,uid,sealed,opaque,fields){this.name=name;this.parent_rtd=parent_rtd;this.is_base_type=!parent_rtd;if(uid){this.uid=uid;this.generative=false}else{this.uid=this._generate_new_uid();this.generative=true}this.sealed=!!sealed;this.opaque=parent_rtd.opaque||!!opaque;this.fields=_.map(fields,function(field){return{name:field[0],mutable:!!field[1]}})},_generate_new_uid:function(){var n=BiwaScheme.Record.RTD.last_uid++;return BiwaScheme.Sym("__record_td_uid_"+
n)},toString:function(){return"#<RecordTD "+name+">"}});BiwaScheme.Record.RTD.last_uid=0;BiwaScheme.Record.RTD.NongenerativeRecords={};BiwaScheme.isRecordTD=function(o){return o instanceof BiwaScheme.Record.RTD};
BiwaScheme.Record.CD=BiwaScheme.Class.create({initialize:function(rtd,parent_cd,protocol){this._check(rtd,parent_cd,protocol);this.rtd=rtd;this.parent_cd=parent_cd;if(protocol){this.has_custom_protocol=true;this.protocol=protocol}else{this.has_custom_protocol=false;if(rtd.parent_rtd)this.protocol=this._default_protocol_for_derived_types();else this.protocol=this._default_protocol_for_base_types()}},_check:function(rtd,parent_cd,protocol){if(rtd.is_base_type&&parent_cd)throw new Error("Record.CD.new: cannot specify parent cd of a base type");
if(parent_cd&&rtd.parent_rtd&&parent_cd.rtd!=rtd.parent_rtd)throw new Error("Record.CD.new: mismatched parents between rtd and parent_cd");if(rtd.parent_rtd&&!parent_cd&&protocol)throw new Error("Record.CD.new: protocol must be #f when parent_cd is not given");if(parent_cd&&parent_cd.has_custom_protocol&&!protocol)throw new Error("Record.CD.new: protocol must be specified when parent_cd has a custom protocol");},_default_protocol_for_base_types:function(){return function(ar){var p=ar[0];assert_procedure(p,
"_default_protocol/base");return p}},_default_protocol_for_derived_types:function(){var rtd=this.rtd;return function(ar){var n=ar[0];assert_procedure(n,"_default_protocol/n");var ctor=function(args){var my_argc=rtd.fields.length;var ancestor_argc=args.length-my_argc;var ancestor_values=args.slice(0,ancestor_argc);var my_values=args.slice(ancestor_argc);return new BiwaScheme.Call(n,ancestor_values,function(ar){var p=ar[0];assert_procedure(p,"_default_protocol/p");return new BiwaScheme.Call(p,my_values,
function(ar){var record=ar[0];assert_record(record,"_default_protocol/result");return record})})};return ctor}},toString:function(){return"#<RecordCD "+this.rtd.name+">"},record_constructor:function(){var arg_for_protocol=this.parent_cd?this._make_n([],this.rtd):this._make_p();arg_for_protocol=_.bind(arg_for_protocol,this);return new BiwaScheme.Call(this.protocol,[arg_for_protocol],function(ar){var ctor=ar[0];assert_procedure(ctor,"record_constructor");return ctor})},_make_p:function(){return function(values){return new BiwaScheme.Record(this.rtd,
values)}},_make_n:function(children_values,rtd){var parent_cd=this.parent_cd;if(parent_cd){var n=function(args_for_n){var p=function(args_for_p){var values=[].concat(args_for_p[0]).concat(children_values);var parent_n=parent_cd._make_n(values,rtd);return new BiwaScheme.Call(parent_cd.protocol,[parent_n],function(ar){var ctor=ar[0];assert_procedure(ctor,"_make_n");return new BiwaScheme.Call(ctor,args_for_n,function(ar){var record=ar[0];assert_record(record);return record})})};return p};return n}else{var n=
function(my_values){var values=my_values.concat(children_values);return new BiwaScheme.Record(rtd,values)};return n}}});BiwaScheme.isRecordCD=function(o){return o instanceof BiwaScheme.Record.CD};BiwaScheme.Hashtable=BiwaScheme.Class.create({initialize:function(_hash_proc,_equiv_proc,mutable){this.mutable=mutable===undefined?true:mutable?true:false;this.hash_proc=_hash_proc;this.equiv_proc=_equiv_proc;this.pairs_of={}},clear:function(){this.pairs_of={}},candidate_pairs:function(hashed){return this.pairs_of[hashed]},add_pair:function(hashed,key,value){var pairs=this.pairs_of[hashed];if(pairs)pairs.push([key,value]);else this.pairs_of[hashed]=[[key,value]]},remove_pair:function(hashed,pair){var pairs=
this.pairs_of[hashed];var i=pairs.indexOf(pair);if(i==-1)throw new BiwaScheme.Bug("Hashtable#remove_pair: pair not found!");else pairs.splice(i,1)},create_copy:function(mutable){var copy=new BiwaScheme.Hashtable(this.hash_proc,this.equiv_proc,mutable);_.each(_.keys(this.pairs_of),_.bind(function(hashed){var pairs=this.pairs_of[hashed];var cloned=_.map(pairs,function(pair){return _.clone(pair)});copy.pairs_of[hashed]=cloned},this));return copy},size:function(){var n=0;this._apply_pair(function(pair){n++});
return n},keys:function(){return this._apply_pair(function(pair){return pair[0]})},values:function(){return this._apply_pair(function(pair){return pair[1]})},_apply_pair:function(func){var a=[];_.each(_.values(this.pairs_of),function(pairs){_.each(pairs,function(pair){a.push(func(pair))})});return a},to_write:function(){return"#<Hashtable size="+this.size()+">"}});BiwaScheme.Hashtable.equal_hash=function(ar){return BiwaScheme.to_write(ar[0])};BiwaScheme.Hashtable.eq_hash=BiwaScheme.Hashtable.equal_hash;
BiwaScheme.Hashtable.eqv_hash=BiwaScheme.Hashtable.equal_hash;BiwaScheme.Hashtable.string_hash=function(ar){return ar[0]};BiwaScheme.Hashtable.string_ci_hash=function(ar){return _.isString(ar[0])?ar[0].toLowerCase():ar[0]};BiwaScheme.Hashtable.symbol_hash=function(ar){return ar[0]instanceof BiwaScheme.Symbol?ar[0].name:ar[0]};BiwaScheme.Hashtable.eq_equiv=function(ar){return BiwaScheme.eq(ar[0],ar[1])};BiwaScheme.Hashtable.eqv_equiv=function(ar){return BiwaScheme.eqv(ar[0],ar[1])};BiwaScheme.Syntax=BiwaScheme.Class.create({initialize:function(sname,func){this.sname=sname;this.func=func},transform:function(x){if(!this.func)throw new BiwaScheme.Bug("sorry, syntax "+this.sname+" is a pseudo syntax now");return this.func(x)},inspect:function(){return"#<Syntax "+this.sname+">"}});BiwaScheme.TopEnv["define"]=new BiwaScheme.Syntax("define");BiwaScheme.TopEnv["begin"]=new BiwaScheme.Syntax("begin");BiwaScheme.TopEnv["quote"]=new BiwaScheme.Syntax("quote");
BiwaScheme.TopEnv["lambda"]=new BiwaScheme.Syntax("lambda");BiwaScheme.TopEnv["if"]=new BiwaScheme.Syntax("if");BiwaScheme.TopEnv["set!"]=new BiwaScheme.Syntax("set!");BiwaScheme.isNil=function(obj){return obj===BiwaScheme.nil};BiwaScheme.isUndef=function(obj){return obj===BiwaScheme.undef};BiwaScheme.isChar=function(obj){return obj instanceof BiwaScheme.Char};BiwaScheme.isSymbol=function(obj){return obj instanceof BiwaScheme.Symbol};BiwaScheme.isPort=function(obj){return obj instanceof BiwaScheme.Port};BiwaScheme.isPair=function(obj){return obj instanceof BiwaScheme.Pair};
BiwaScheme.isList=function(obj){if(obj===BiwaScheme.nil)return true;if(!(obj instanceof BiwaScheme.Pair))return false;return BiwaScheme.isList(obj.cdr)};BiwaScheme.isVector=function(obj){return obj instanceof Array&&obj.closure_p!==true};BiwaScheme.isHashtable=function(obj){return obj instanceof BiwaScheme.Hashtable};BiwaScheme.isMutableHashtable=function(obj){return obj instanceof BiwaScheme.Hashtable&&obj.mutable};BiwaScheme.isClosure=function(obj){return obj instanceof Array&&obj.closure_p===true};
BiwaScheme.isProcedure=function(obj){return BiwaScheme.isClosure(obj)||_.isFunction(obj)};BiwaScheme.Parser=BiwaScheme.Class.create({initialize:function(txt){this.tokens=this.tokenize(txt);this.i=0},inspect:function(){return["#<Parser:",this.i,"/",this.tokens.length," ",BiwaScheme.inspect(this.tokens),">"].join("")},tokenize:function(txt){var tokens=new Array,oldTxt=null;var in_srfi_30_comment=0;while(txt!=""&&oldTxt!=txt){oldTxt=txt;txt=txt.replace(/^\s*(;[^\r\n]*(\r|\n|$)|#;|#\||#\\[^\w]|#?(\(|\[|{)|\)|\]|}|\'|`|,@|,|\+inf\.0|-inf\.0|\+nan\.0|\"(\\(.|$)|[^\"\\])*(\"|$)|[^\s()\[\]{}]+)/,
function($0,$1){var t=$1;if(t=="#|"){in_srfi_30_comment++;return""}else if(in_srfi_30_comment>0)if(/(.*\|#)/.test(t)){in_srfi_30_comment--;if(in_srfi_30_comment<0)throw new BiwaScheme.Error("Found an extra comment terminator: `|#'");return t.substring(RegExp.$1.length,t.length)}else return"";else{if(t.charAt(0)!=";")tokens[tokens.length]=t;return""}})}return tokens},sexpCommentMarker:new Object,getObject:function(){var r=this.getObject0();if(r!=this.sexpCommentMarker)return r;r=this.getObject();if(r==
BiwaScheme.Parser.EOS)throw new BiwaScheme.Error("Readable object not found after S exression comment");r=this.getObject();return r},getList:function(close){var list=BiwaScheme.nil,prev=list;while(this.i<this.tokens.length){this.eatObjectsInSexpComment("Input stream terminated unexpectedly(in list)");if(this.tokens[this.i]==")"||this.tokens[this.i]=="]"||this.tokens[this.i]=="}"){this.i++;break}if(this.tokens[this.i]=="."){this.i++;var o=this.getObject();if(o!=BiwaScheme.Parser.EOS&&list!=BiwaScheme.nil)prev.cdr=
o}else{var cur=new BiwaScheme.Pair(this.getObject(),BiwaScheme.nil);if(list==BiwaScheme.nil)list=cur;else prev.cdr=cur;prev=cur}}return list},getVector:function(close){var arr=new Array;while(this.i<this.tokens.length){this.eatObjectsInSexpComment("Input stream terminated unexpectedly(in vector)");if(this.tokens[this.i]==")"||this.tokens[this.i]=="]"||this.tokens[this.i]=="}"){this.i++;break}arr[arr.length]=this.getObject()}return arr},eatObjectsInSexpComment:function(err_msg){while(this.tokens[this.i]==
"#;"){this.i++;if(this.getObject()==BiwaScheme.Parser.EOS||this.i>=this.tokens.length)throw new BiwaScheme.Error(err_msg);}},getObject0:function(){if(this.i>=this.tokens.length)return BiwaScheme.Parser.EOS;var t=this.tokens[this.i++];if(t=="#;")return this.sexpCommentMarker;var s=t=="'"?"quote":t=="`"?"quasiquote":t==","?"unquote":t==",@"?"unquote-splicing":false;if(s||t=="("||t=="#("||t=="["||t=="#["||t=="{"||t=="#{")return s?new BiwaScheme.Pair(BiwaScheme.Sym(s),new BiwaScheme.Pair(this.getObject(),
BiwaScheme.nil)):t=="("||t=="["||t=="{"?this.getList(t):this.getVector(t);else{switch(t){case "+inf.0":return Infinity;case "-inf.0":return-Infinity;case "+nan.0":return NaN}var n;if(/^#x[0-9a-z]+$/i.test(t))n=new Number("0x"+t.substring(2,t.length));else if(/^#d[0-9\.]+$/i.test(t))n=new Number(t.substring(2,t.length));else n=new Number(t);if(!isNaN(n))return n.valueOf();else if(t=="#f"||t=="#F")return false;else if(t=="#t"||t=="#T")return true;else if(t.toLowerCase()=="#\\newline")return BiwaScheme.Char.get("\n");
else if(t.toLowerCase()=="#\\space")return BiwaScheme.Char.get(" ");else if(t.toLowerCase()=="#\\tab")return BiwaScheme.Char.get("\t");else if(/^#\\.$/.test(t))return BiwaScheme.Char.get(t.charAt(2));else if(/^\"(\\(.|$)|[^\"\\])*\"?$/.test(t))return t.replace(/(\r?\n|\\n)/g,"\n").replace(/^\"|\\(.|$)|\"$/g,function($0,$1){return $1?$1:""});else return BiwaScheme.Sym(t)}}});BiwaScheme.Parser.EOS=new Object;BiwaScheme.Compiler=BiwaScheme.Class.create({initialize:function(){},is_tail:function(x){return x[0]=="return"},collect_free:function(free,e,next){var vars=free;var opc=next;var arr=vars.arr;for(var i=0;i<arr.length;i++)opc=this.compile_refer(arr[i],e,["argument",opc]);return opc},compile_refer:function(x,e,next){return this.compile_lookup(x,e,function(n){return["refer-local",n,next]},function(n){return["refer-free",n,next]},function(sym){return["refer-global",sym,next]})},compile_lookup:function(x,
e,return_local,return_free,return_global){var locals=e[0],free=e[1];if((n=locals.index(x))!=null)return return_local(n);else if((n=free.index(x))!=null)return return_free(n);else{var sym=x.name;return return_global(sym)}},make_boxes:function(sets,vars,next){var vars=vars;var n=0;var a=[];while(vars instanceof BiwaScheme.Pair){if(sets.member(vars.car))a.push(n);n++;vars=vars.cdr}var opc=next;for(var i=a.length-1;i>=0;i--)opc=["box",a[i],opc];return opc},find_sets:function(x,v){var ret=null;if(x instanceof
BiwaScheme.Symbol)ret=new BiwaScheme.Set;else if(x instanceof BiwaScheme.Pair)switch(x.first()){case BiwaScheme.Sym("define"):var exp=x.third();ret=this.find_sets(exp,v);case BiwaScheme.Sym("begin"):ret=this.find_sets(x.cdr,v);break;case BiwaScheme.Sym("quote"):ret=new BiwaScheme.Set;break;case BiwaScheme.Sym("lambda"):var vars=x.second(),body=x.cdr.cdr;if(vars instanceof BiwaScheme.Pair)ret=this.find_sets(body,v.set_minus(vars.to_set()));else ret=this.find_sets(body,v.set_minus(new BiwaScheme.Set(vars)));
break;case BiwaScheme.Sym("if"):var testc=x.second(),thenc=x.third(),elsec=x.fourth();ret=this.find_sets(testc,v).set_union(this.find_sets(thenc,v),this.find_sets(elsec,v));break;case BiwaScheme.Sym("set!"):var vari=x.second(),xx=x.third();if(v.member(vari))ret=this.find_sets(xx,v).set_cons(vari);else ret=this.find_sets(xx,v);break;case BiwaScheme.Sym("call/cc"):var exp=x.second();ret=this.find_sets(exp,v);break;default:var set=new BiwaScheme.Set;for(var p=x;p instanceof BiwaScheme.Pair;p=p.cdr)set=
set.set_union(this.find_sets(p.car,v));ret=set;break}else ret=new BiwaScheme.Set;if(ret==null)throw new BiwaScheme.Bug("find_sets() exited in unusual way");else return ret},find_free:function(x,b,f){var ret=null;if(x instanceof BiwaScheme.Symbol)if(f.member(x))ret=new BiwaScheme.Set(x);else ret=new BiwaScheme.Set;else if(x instanceof BiwaScheme.Pair)switch(x.first()){case BiwaScheme.Sym("define"):var exp=x.third();ret=this.find_free(exp,b,f);break;case BiwaScheme.Sym("begin"):ret=this.find_free(x.cdr,
b,f);break;case BiwaScheme.Sym("quote"):ret=new BiwaScheme.Set;break;case BiwaScheme.Sym("lambda"):var vars=x.second(),body=x.cdr.cdr;if(vars instanceof BiwaScheme.Pair)ret=this.find_free(body,b.set_union(vars.to_set()),f);else ret=this.find_free(body,b.set_cons(vars),f);break;case BiwaScheme.Sym("if"):var testc=x.second(),thenc=x.third(),elsec=x.fourth();ret=this.find_free(testc,b,f).set_union(this.find_free(thenc,b,f),this.find_free(elsec,b,f));break;case BiwaScheme.Sym("set!"):var vari=x.second(),
exp=x.third();if(f.member(vari))ret=this.find_free(exp,b,f).set_cons(vari);else ret=this.find_free(exp,b,f);break;case BiwaScheme.Sym("call/cc"):var exp=x.second();ret=this.find_free(exp,b,f);break;default:var set=new BiwaScheme.Set;for(var p=x;p instanceof BiwaScheme.Pair;p=p.cdr)set=set.set_union(this.find_free(p.car,b,f));ret=set;break}else ret=new BiwaScheme.Set;if(ret==null)throw new BiwaScheme.Bug("find_free() exited in unusual way");else return ret},find_dot_pos:function(x){var idx=0;for(;x instanceof
BiwaScheme.Pair;x=x.cdr,++idx);if(x!=BiwaScheme.nil)return idx;else return-1},last_pair:function(x){if(x instanceof BiwaScheme.Pair)for(;x.cdr instanceof BiwaScheme.Pair;x=x.cdr);return x},dotted2proper:function(ls){var nreverse=function(ls){var res=BiwaScheme.nil;for(;ls instanceof BiwaScheme.Pair;){var d=ls.cdr;ls.cdr=res;res=ls;ls=d}return res};var copy_list=function(ls){var res=BiwaScheme.nil;for(;ls instanceof BiwaScheme.Pair;ls=ls.cdr)res=new BiwaScheme.Pair(ls.car,res);return nreverse(res)};
if(ls instanceof BiwaScheme.Pair){var last=this.last_pair(ls);if(last instanceof BiwaScheme.Pair&&last.cdr===BiwaScheme.nil)return ls;else{var copied=copy_list(ls);this.last_pair(copied).cdr=new BiwaScheme.Pair(last.cdr,BiwaScheme.nil);return copied}}else return new BiwaScheme.Pair(ls,BiwaScheme.nil)},compile:function(x,e,s,f,next){var ret=null;while(1)if(x instanceof BiwaScheme.Symbol)return this.compile_refer(x,e,s.member(x)?["indirect",next]:next);else if(x instanceof BiwaScheme.Pair)switch(x.first()){case BiwaScheme.Sym("define"):if(x.length()==
1)throw new BiwaScheme.Error("Invalid `define': "+x.to_write());var left=x.cdr.car;var exp=x.cdr.cdr;if(left instanceof BiwaScheme.Symbol){if(exp===BiwaScheme.nil)x=BiwaScheme.undef;else{if(exp.cdr!==BiwaScheme.nil)throw new BiwaScheme.Error("Invalid `define': "+x.to_write());x=exp.car}BiwaScheme.TopEnv[left.name]=BiwaScheme.undef;next=["assign-global",left.name,next]}else if(left instanceof BiwaScheme.Pair){var fname=left.car,args=left.cdr;var lambda=new BiwaScheme.Pair(BiwaScheme.Sym("lambda"),
new BiwaScheme.Pair(args,exp));x=lambda;BiwaScheme.TopEnv[fname.name]=BiwaScheme.undef;next=["assign-global",fname.name,next]}else throw new BiwaScheme.Error("compile: define needs a leftbol or pair: got "+left);break;case BiwaScheme.Sym("begin"):var a=[];for(var p=x.cdr;p instanceof BiwaScheme.Pair;p=p.cdr)a.push(p.car);var c=next;for(var i=a.length-1;i>=0;i--)c=this.compile(a[i],e,s,f,c);return c;case BiwaScheme.Sym("quote"):if(x.length()<2)throw new BiwaScheme.Error("Invalid quote: "+x.to_write());
var obj=x.second();return["constant",obj,next];case BiwaScheme.Sym("lambda"):if(x.length()<3)throw new BiwaScheme.Error("Invalid lambda: "+x.to_write());var vars=x.cdr.car;var body=new BiwaScheme.Pair(BiwaScheme.Sym("begin"),x.cdr.cdr);var dotpos=this.find_dot_pos(vars);var proper=this.dotted2proper(vars);var free=this.find_free(body,proper.to_set(),f);var sets=this.find_sets(body,proper.to_set());var do_body=this.compile(body,[proper.to_set(),free],sets.set_union(s.set_intersect(free)),f.set_union(proper.to_set()),
["return"]);var do_close=["close",free.size(),this.make_boxes(sets,proper,do_body),next,dotpos];return this.collect_free(free,e,do_close);case BiwaScheme.Sym("if"):if(x.length()<3||x.length()>4)throw new BiwaScheme.Error("Invalid if: "+x.to_write());var testc=x.second(),thenc=x.third(),elsec=x.fourth();var thenc=this.compile(thenc,e,s,f,next);var elsec=this.compile(elsec,e,s,f,next);x=testc;next=["test",thenc,elsec];break;case BiwaScheme.Sym("set!"):if(x.length()!=3)throw new BiwaScheme.Error("Invalid set!: "+
x.to_write());var v=x.second(),x=x.third();var do_assign=this.compile_lookup(v,e,function(n){return["assign-local",n,next]},function(n){return["assign-free",n,next]},function(sym){return["assign-global",sym,next]});next=do_assign;break;case BiwaScheme.Sym("call/cc"):var x=x.second();var c=["conti",this.is_tail(next)?e[0].size()+1:0,["argument",["constant",1,["argument",this.compile(x,e,s,f,this.is_tail(next)?["shift",1,["apply"]]:["apply"])]]]];return this.is_tail(next)?c:["frame",c,next];default:var func=
x.car;var args=x.cdr;var c=this.compile(func,e,s,f,this.is_tail(next)?["shift",args.length(),["apply"]]:["apply"]);c=this.compile(args.length(),e,s,f,["argument",c]);for(var p=args;p instanceof BiwaScheme.Pair;p=p.cdr)c=this.compile(p.car,e,s,f,["argument",c]);return this.is_tail(next)?c:["frame",c,next]}else return["constant",x,next]},run:function(expr){return this.compile(expr,[new BiwaScheme.Set,new BiwaScheme.Set],new BiwaScheme.Set,new BiwaScheme.Set,["halt"])}});
BiwaScheme.Compiler.compile=function(expr,next){expr=(new BiwaScheme.Interpreter).expand(expr);return(new BiwaScheme.Compiler).run(expr,next)};BiwaScheme.Pause=BiwaScheme.Class.create({initialize:function(on_pause){this.on_pause=on_pause},set_state:function(intp,x,f,c,s){this.interpreter=intp;this.x=x;this.f=f;this.c=c;this.s=s},ready:function(){this.on_pause(this)},resume:function(value){return this.interpreter.resume(true,value,this.x,this.f,this.c,this.s)}});BiwaScheme.Call=BiwaScheme.Class.create({initialize:function(proc,args,after){this.proc=proc;this.args=args;this.after=after||function(ar){return ar[0]}},inspect:function(){return"#<Call args="+this.args.inspect()+">"},toString:function(){return"#<Call>"},to_write:function(){return"#<Call>"}});
BiwaScheme.Iterator={ForArray:BiwaScheme.Class.create({initialize:function(arr){this.arr=arr;this.i=0},has_next:function(){return this.i<this.arr.length},next:function(){return this.arr[this.i++]}}),ForString:BiwaScheme.Class.create({initialize:function(str){this.str=str;this.i=0},has_next:function(){return this.i<this.str.length},next:function(){return BiwaScheme.Char.get(this.str.charAt(this.i++))}}),ForList:BiwaScheme.Class.create({initialize:function(ls){this.ls=ls},has_next:function(){return this.ls instanceof
BiwaScheme.Pair&&this.ls!=BiwaScheme.nil},next:function(){var pair=this.ls;this.ls=this.ls.cdr;return pair}}),ForMulti:BiwaScheme.Class.create({initialize:function(objs){this.objs=objs;this.size=objs.length;this.iterators=_.map(objs,function(x){return BiwaScheme.Iterator.of(x)})},has_next:function(){for(var i=0;i<this.size;i++)if(!this.iterators[i].has_next())return false;return true},next:function(){return _.map(this.iterators,function(ite){return ite.next()})}}),of:function(obj){switch(true){case obj instanceof
Array:return new this.ForArray(obj);case typeof obj=="string":return new this.ForString(obj);case obj instanceof BiwaScheme.Pair:case obj===BiwaScheme.nil:return new this.ForList(obj);default:throw new BiwaScheme.Bug("Iterator.of: unknown class: "+BiwaScheme.inspect(obj));}}};BiwaScheme.Call.default_callbacks={call:function(x){return new BiwaScheme.Call(this.proc,[x])},result:function(){},finish:function(){}};
BiwaScheme.Call.foreach=function(obj,callbacks,is_multi){is_multi||(is_multi=false);_.each(["call","result","finish"],function(key){if(!callbacks[key])callbacks[key]=BiwaScheme.Call.default_callbacks[key]});var iterator=null;var x=null;var loop=function(ar){if(iterator){var ret=callbacks["result"](ar[0],x);if(ret!==undefined)return ret}else if(is_multi)iterator=new BiwaScheme.Iterator.ForMulti(obj);else iterator=BiwaScheme.Iterator.of(obj);if(!iterator.has_next())return callbacks["finish"]();else{x=
iterator.next();var result=callbacks["call"](x);result.after=loop;return result}};return loop(null)};BiwaScheme.Call.multi_foreach=function(obj,callbacks){return BiwaScheme.Call.foreach(obj,callbacks,true)};BiwaScheme.Interpreter=BiwaScheme.Class.create({initialize:function(on_error){this.stack=[];this.on_error=on_error||function(e){};this.after_evaluate=function(){}},inspect:function(){return["#<Interpreter: stack size=>",this.stack.length," ","after_evaluate=",BiwaScheme.inspect(this.after_evaluate),">"].join("")},push:function(x,s){this.stack[s]=x;return s+1},save_stack:function(s){var v=[];for(var i=0;i<s;i++)v[i]=this.stack[i];return v},restore_stack:function(v){var s=v.length;for(var i=0;i<s;i++)this.stack[i]=
v[i];return s},continuation:function(s,n){var ss=this.push(n,s);return this.closure(["refer-local",0,["nuate",this.save_stack(ss),["return"]]],0,null,-1)},shift_args:function(n,m,s){for(var i=n-1;i>=-1;i--)this.index_set(s,i+m+1,this.index(s,i));return s-m-1},index:function(s,i){return this.stack[s-i-2]},index_set:function(s,i,v){this.stack[s-i-2]=v},closure:function(body,n,s,dotpos){var v=[];v[0]=body;for(var i=0;i<n;i++)v[i+1]=this.index(s,i-1);v[n+1]=dotpos;v.closure_p=true;return v},execute:function(a,
x,f,c,s){var ret=null;try{ret=this._execute(a,x,f,c,s)}catch(e){var state={a:a,x:x,f:f,c:c,s:s,stack:this.stack};return this.on_error(e,state)}return ret},run_dump_hook:function(a,x,f,c,s){var dumper;var state;if(this.dumper)dumper=this.dumper;else if(BiwaScheme.Interpreter.dumper)dumper=BiwaScheme.Interpreter.dumper;else return;if(dumper){state={"a":a,"f":f,"c":c,"s":s,"x":x,"stack":this.stack};dumper.dump(state)}},_execute:function(a,x,f,c,s){var ret=null;while(true){this.run_dump_hook(a,x,f,c,
s);switch(x[0]){case "halt":return a;case "refer-local":var n=x[1],x=x[2];a=this.index(f,n);break;case "refer-free":var n=x[1],x=x[2];a=c[n+1];break;case "refer-global":var sym=x[1],x=x[2];if(BiwaScheme.TopEnv.hasOwnProperty(sym))var val=BiwaScheme.TopEnv[sym];else if(BiwaScheme.CoreEnv.hasOwnProperty(sym))var val=BiwaScheme.CoreEnv[sym];else throw new BiwaScheme.Error("execute: unbound symbol: "+BiwaScheme.inspect(sym));a=val;break;case "indirect":var x=x[1];a=a[0];break;case "constant":var obj=
x[1],x=x[2];a=obj;break;case "close":var ox=x;var n=ox[1],body=ox[2],x=ox[3],dotpos=ox[4];a=this.closure(body,n,s,dotpos);s-=n;break;case "box":var n=x[1],x=x[2];this.index_set(s,n,[this.index(s,n)]);break;case "test":var thenc=x[1],elsec=x[2];x=a!==false?thenc:elsec;break;case "assign-global":var name=x[1],x=x[2];if(!BiwaScheme.TopEnv.hasOwnProperty(name)&&!BiwaScheme.CoreEnv.hasOwnProperty(name))throw new BiwaScheme.Error("global variable '"+name+"' is not defined");BiwaScheme.TopEnv[name]=a;a=
BiwaScheme.undef;break;case "assign-local":var n=x[1],x=x[2];var box=this.index(f,n);box[0]=a;a=BiwaScheme.undef;break;case "assign-free":var n=x[1],x=x[2];var box=c[n+1];box[0]=a;a=BiwaScheme.undef;break;case "conti":var n=x[1],x=x[2];a=this.continuation(s,n);break;case "nuate":var stack=x[1],x=x[2];s=this.restore_stack(stack);break;case "frame":var ret=x[2];x=x[1];s=this.push(ret,this.push(f,this.push(c,s)));break;case "argument":var x=x[1];s=this.push(a,s);break;case "shift":var n=x[1],x=x[2];
var n_args=this.index(s,n);s=this.shift_args(n,n_args,s);break;case "apply":var func=a;var n_args=this.index(s,-1);if(func instanceof Array){a=func;x=func[0];var dotpos=func[func.length-1];if(dotpos>=0){var ls=BiwaScheme.nil;for(var i=n_args;--i>=dotpos;)ls=new BiwaScheme.Pair(this.index(s,i),ls);if(dotpos>=n_args){for(var i=-1;i<n_args;i++)this.index_set(s,i-1,this.index(s,i));s++;this.index_set(s,-1,this.index(s,-1)+1)}this.index_set(s,dotpos,ls)}f=s;c=a}else if(func instanceof Function){var args=
[];for(var i=0;i<n_args;i++)args.push(this.index(s,i));var result=func(args,this);if(result instanceof BiwaScheme.Pause){var pause=result;pause.set_state(this,["return"],f,c,s);pause.ready();return pause}else if(result instanceof BiwaScheme.Call){var call_after=["frame",["argument",["constant",1,["argument",["constant",result.after,["apply"]]]]],["return"]];var call_proc=["constant",result.args.length,["argument",["constant",result.proc,["apply",result.args.length]]]];var push_args=_.inject(result.args,
function(opc,arg){return["constant",arg,["argument",opc]]},call_proc);x=["frame",push_args,call_after]}else{a=result;x=["return"]}}else throw new BiwaScheme.Error(BiwaScheme.inspect(func)+" is not a function");break;case "return":var n=this.index(s,-1);var ss=s-n;x=this.index(ss,0),f=this.index(ss,1),c=this.index(ss,2),s=ss-3-1;break;default:throw new BiwaScheme.Bug("unknown opecode type: "+x[0]);}}return a},expand:function(x,flag){flag||(flag={});var ret=null;if(x instanceof BiwaScheme.Symbol)ret=
x;else if(x instanceof BiwaScheme.Pair)switch(x.car){case BiwaScheme.Sym("define"):var left=x.cdr.car,exp=x.cdr.cdr;ret=new BiwaScheme.Pair(BiwaScheme.Sym("define"),new BiwaScheme.Pair(left,this.expand(exp,flag)));break;case BiwaScheme.Sym("begin"):ret=new BiwaScheme.Pair(BiwaScheme.Sym("begin"),this.expand(x.cdr,flag));break;case BiwaScheme.Sym("quote"):ret=x;break;case BiwaScheme.Sym("lambda"):var vars=x.cdr.car,body=x.cdr.cdr;ret=new BiwaScheme.Pair(BiwaScheme.Sym("lambda"),new BiwaScheme.Pair(vars,
this.expand(body,flag)));break;case BiwaScheme.Sym("if"):var testc=x.second(),thenc=x.third(),elsec=x.fourth();if(elsec==BiwaScheme.inner_of_nil)elsec=BiwaScheme.undef;ret=BiwaScheme.List(BiwaScheme.Sym("if"),this.expand(testc,flag),this.expand(thenc,flag),this.expand(elsec,flag));break;case BiwaScheme.Sym("set!"):var v=x.second(),x=x.third();ret=BiwaScheme.List(BiwaScheme.Sym("set!"),v,this.expand(x,flag));break;case BiwaScheme.Sym("call-with-current-continuation"):case BiwaScheme.Sym("call/cc"):var x=
x.second();ret=BiwaScheme.List(BiwaScheme.Sym("call/cc"),this.expand(x,flag));break;default:if(x.car instanceof BiwaScheme.Symbol&&BiwaScheme.TopEnv[x.car.name]instanceof BiwaScheme.Syntax){var transformer=BiwaScheme.TopEnv[x.car.name];flag["modified"]=true;ret=transformer.transform(x);if(BiwaScheme.Debug){var before=BiwaScheme.to_write(x);var after=BiwaScheme.to_write(ret);if(before!=after)puts("expand: "+before+" => "+after)}var fl;for(;;){ret=this.expand(ret,fl={});if(!fl["modified"])break}}else if(x==
BiwaScheme.nil)ret=BiwaScheme.nil;else ret=new BiwaScheme.Pair(this.expand(x.car,flag),BiwaScheme.shallow_array_to_list(_.map(x.cdr.to_array(),_.bind(function(item){return this.expand(item,flag)},this))))}else ret=x;return ret},evaluate:function(str,after_evaluate){this.parser=new BiwaScheme.Parser(str);this.compiler=new BiwaScheme.Compiler;if(after_evaluate)this.after_evaluate=after_evaluate;if(BiwaScheme.Debug)puts("executing: "+str);this.is_top=true;this.file_stack=[];return this.resume(false)},
resume:function(is_resume,a,x,f,c,s){var ret=BiwaScheme.undef;for(;;){if(is_resume){ret=this.execute(a,x,f,c,s);is_resume=false}else{if(!this.parser)break;var expr=this.parser.getObject();if(expr===BiwaScheme.Parser.EOS)break;expr=this.expand(expr);var opc=this.compiler.run(expr);ret=this.execute(expr,opc,0,[],0)}if(ret instanceof BiwaScheme.Pause)return ret}this.after_evaluate(ret);return ret},invoke_closure:function(closure,args){args||(args=[]);var n_args=args.length;var x=["constant",n_args,["argument",
["constant",closure,["apply"]]]];for(var i=0;i<n_args;i++)x=["constant",args[i],["argument",x]];return this.execute(closure,["frame",x,["halt"]],0,closure,0)},compile:function(str){var obj=BiwaScheme.Interpreter.read(str);var opc=BiwaScheme.Compiler.compile(obj);return opc}});BiwaScheme.Interpreter.read=function(str){var parser=new BiwaScheme.Parser(str);var r=parser.getObject();return r==BiwaScheme.Parser.EOS?BiwaScheme.eof:r};BiwaScheme.check_arity=function(len,min,max){var fname=arguments.callee.caller?arguments.callee.caller.fname:"(?)";if(len<min)if(max&&max==min)throw new BiwaScheme.Error(fname+": wrong number of arguments (expected: "+min+" got: "+len+")");else throw new BiwaScheme.Error(fname+": too few arguments (at least: "+min+" got: "+len+")");else if(max&&max<len)throw new BiwaScheme.Error(fname+": too many arguments (at most: "+max+" got: "+len+")");};
BiwaScheme.define_libfunc=function(fname,min,max,func,is_raw){var f=function(ar,intp){BiwaScheme.check_arity(ar.length,min,max);var result=func(ar,intp);if(is_raw)return result;else if(result===undefined)throw new BiwaScheme.Bug("library function "+"`"+fname+"'"+" returned JavaScript's undefined");else if(result===null)throw new BiwaScheme.Bug("library function "+"`"+fname+"'"+" returned JavaScript's null");else return result};func["fname"]=fname;f["fname"]=fname;f["inspect"]=function(){return this.fname};
BiwaScheme.CoreEnv[fname]=f};BiwaScheme.alias_libfunc=function(fname,aliases){if(BiwaScheme.CoreEnv[fname])if(_.isArray(aliases))_.map(aliases,function(a){BiwaScheme.alias_libfunc(fname,a)});else if(_.isString(aliases))BiwaScheme.CoreEnv[aliases]=BiwaScheme.CoreEnv[fname];else throw new BiwaScheme.Bug("bad alias for library function "+"`"+fname+"': "+aliases.toString());else throw new BiwaScheme.Bug("library function "+"`"+fname+"'"+" does not exist, so can't alias it.");};
BiwaScheme.define_libfunc_raw=function(fname,min,max,func){BiwaScheme.define_libfunc(fname,min,max,func,true)};BiwaScheme.define_syntax=function(sname,func){var s=new BiwaScheme.Syntax(sname,func);BiwaScheme.TopEnv[sname]=s};BiwaScheme.define_scmfunc=function(fname,min,max,str){(new Interpreter).evaluate("(define "+fname+" "+str+"\n)")};make_assert=function(check){return function(){var fname=arguments.callee.caller?arguments.callee.caller.fname:"";check.apply(this,[fname].concat(_.toArray(arguments)))}};
make_simple_assert=function(type,test){return make_assert(function(fname,obj,opt){option=opt?"("+opt+")":"";if(!test(obj))throw new BiwaScheme.Error(fname+option+": "+type+" required, but got "+BiwaScheme.to_write(obj));})};assert_number=make_simple_assert("number",function(obj){return typeof obj=="number"||obj instanceof BiwaScheme.Complex});assert_integer=make_simple_assert("integer",function(obj){return typeof obj=="number"&&obj%1==0});
assert_real=make_simple_assert("real number",function(obj){return typeof obj=="number"});assert_between=make_assert(function(fname,obj,from,to){if(typeof obj!="number"||obj!=Math.round(obj))throw new BiwaScheme.Error(fname+": "+"number required, but got "+BiwaScheme.to_write(obj));if(obj<from||to<obj)throw new BiwaScheme.Error(fname+": "+"number must be between "+from+" and "+to+", but got "+BiwaScheme.to_write(obj));});assert_string=make_simple_assert("string",_.isString);
assert_char=make_simple_assert("character",BiwaScheme.isChar);assert_symbol=make_simple_assert("symbol",BiwaScheme.isSymbol);assert_port=make_simple_assert("port",BiwaScheme.isPort);assert_pair=make_simple_assert("pair",BiwaScheme.isPair);assert_list=make_simple_assert("list",BiwaScheme.isList);assert_vector=make_simple_assert("vector",BiwaScheme.isVector);assert_hashtable=make_simple_assert("hashtable",BiwaScheme.isHashtable);assert_mutable_hashtable=make_simple_assert("mutable hashtable",BiwaScheme.isMutableHashtable);
assert_record=make_simple_assert("record",BiwaScheme.isRecord);assert_record_td=make_simple_assert("record type descriptor",BiwaScheme.isRecordTD);assert_record_cd=make_simple_assert("record constructor descriptor",BiwaScheme.isRecordCD);assert_function=make_simple_assert("JavaScript function",_.isFunction);assert_closure=make_simple_assert("scheme function",BiwaScheme.isClosure);assert_procedure=make_simple_assert("scheme/js function",function(obj){return BiwaScheme.isClosure(obj)||_.isFunction(obj)});
assert_date=make_simple_assert("date",function(obj){return obj instanceof Date});assert=make_assert(function(fname,success,message){if(!success)throw new BiwaScheme.Error(fname+": "+message);});if(typeof BiwaScheme!="object")BiwaScheme={};
with(BiwaScheme){define_syntax("cond",function(x){var clauses=x.cdr;if(!(clauses instanceof Pair)||clauses===nil)throw new Error("malformed cond: cond needs list but got "+to_write_ss(clauses));var ret=null;_.each(clauses.to_array().reverse(),function(clause){if(!(clause instanceof Pair))throw new Error("bad clause in cond: "+to_write_ss(clause));if(clause.car===Sym("else"))if(ret!==null)throw new Error("'else' clause of cond followed by more clauses: "+to_write_ss(clauses));else if(clause.cdr===
nil)ret=false;else if(clause.cdr.cdr===nil)ret=clause.cdr.car;else ret=new Pair(Sym("begin"),clause.cdr);else if(ret===null)ret=BiwaScheme.undef;else{var test=clause.car;if(clause.cdr===nil)ret=List(Sym("or"),test,ret);else if(clause.cdr.cdr===nil)ret=List(Sym("if"),test,clause.cdr.car,ret);else if(clause.cdr.car===Sym("=>")){var test=clause.car,expr=clause.cdr.cdr.car;var tmp_sym=BiwaScheme.gensym();ret=List(Sym("let"),List(List(tmp_sym,test)),List(Sym("if"),test,List(expr,tmp_sym),ret))}else ret=
List(Sym("if"),test,new Pair(Sym("begin"),clause.cdr),ret)}});return ret});define_syntax("case",function(x){var tmp_sym=BiwaScheme.gensym();if(x.cdr===nil)throw new Error("case: at least one clause is required");else if(!(x.cdr instanceof Pair))throw new Error("case: proper list is required");else{var key=x.cdr.car;var clauses=x.cdr.cdr;var ret=undefined;_.each(clauses.to_array().reverse(),function(clause){if(clause.car===Sym("else"))if(ret===undefined)ret=new Pair(Sym("begin"),clause.cdr);else throw new Error("case: 'else' clause followed by more clauses: "+
to_write_ss(clauses));else ret=List(Sym("if"),new Pair(Sym("or"),array_to_list(_.map(clause.car.to_array(),function(d){return List(Sym("eqv?"),tmp_sym,List(Sym("quote"),d))}))),new Pair(Sym("begin"),clause.cdr),ret)});return new Pair(Sym("let1"),new Pair(tmp_sym,new Pair(key,new Pair(ret,nil))))}});define_syntax("and",function(x){if(x.cdr==nil)return true;var objs=x.cdr.to_array();var i=objs.length-1;var t=objs[i];for(i=i-1;i>=0;i--)t=List(Sym("if"),objs[i],t,false);return t});define_syntax("or",
function(x){var objs=x.cdr.to_array();var f=false;for(var i=objs.length-1;i>=0;i--)f=List(Sym("if"),objs[i],objs[i],f);return f});define_syntax("let",function(x){var name=null;if(x.cdr.car instanceof Symbol){name=x.cdr.car;x=x.cdr}var binds=x.cdr.car,body=x.cdr.cdr;if(!(binds instanceof Pair))throw new Error("let: need a pair for bindings: got "+to_write(binds));var vars=nil,vals=nil;for(var p=binds;p instanceof Pair;p=p.cdr){vars=new Pair(p.car.car,vars);vals=new Pair(p.car.cdr.car,vals)}var lambda=
null;if(name){vars=array_to_list(vars.to_array().reverse());vals=array_to_list(vals.to_array().reverse());var body_lambda=new Pair(Sym("lambda"),new Pair(vars,body));var init_call=new Pair(name,vals);lambda=List(Sym("letrec"),new Pair(List(name,body_lambda),nil),init_call)}else lambda=new Pair(new Pair(Sym("lambda"),new Pair(vars,body)),vals);return lambda});define_syntax("let*",function(x){var binds=x.cdr.car,body=x.cdr.cdr;if(!(binds instanceof Pair))throw new Error("let*: need a pair for bindings: got "+
to_write(binds));var ret=null;_.each(binds.to_array().reverse(),function(bind){ret=new Pair(Sym("let"),new Pair(new Pair(bind,nil),ret==null?body:new Pair(ret,nil)))});return ret});var expand_letrec_star=function(x){var binds=x.cdr.car,body=x.cdr.cdr;if(!(binds instanceof Pair))throw new Error("letrec*: need a pair for bindings: got "+to_write(binds));var ret=body;_.each(binds.to_array().reverse(),function(bind){ret=new Pair(new Pair(Sym("set!"),bind),ret)});var letbody=nil;_.each(binds.to_array().reverse(),
function(bind){letbody=new Pair(new Pair(bind.car,new Pair(BiwaScheme.undef,nil)),letbody)});return new Pair(Sym("let"),new Pair(letbody,ret))};define_syntax("letrec",expand_letrec_star);define_syntax("letrec*",expand_letrec_star);define_syntax("let-values",function(x){var mv_bindings=x.cdr.car;var body=x.cdr.cdr;var ret=null;var let_bindings=nil;var let_star_values_bindings=nil;_.each(mv_bindings.to_array().reverse(),function(item){var init=item.cdr.car;var tmpsym=BiwaScheme.gensym();var binding=
new Pair(tmpsym,new Pair(new Pair(Sym("lambda"),new Pair(nil,new Pair(init,nil))),nil));let_bindings=new Pair(binding,let_bindings);var formals=item.car;let_star_values_bindings=new Pair(new Pair(formals,new Pair(new Pair(tmpsym,nil),nil)),let_star_values_bindings)});var let_star_values=new Pair(Sym("let*-values"),new Pair(let_star_values_bindings,body));ret=new Pair(Sym("let"),new Pair(let_bindings,new Pair(let_star_values,nil)));return ret});define_syntax("let*-values",function(x){var mv_bindings=
x.cdr.car;var body=x.cdr.cdr;var ret=null;_.each(mv_bindings.to_array().reverse(),function(item){var formals=item.car,init=item.cdr.car;ret=new Pair(Sym("call-with-values"),new Pair(new Pair(Sym("lambda"),new Pair(nil,new Pair(init,nil))),new Pair(new Pair(Sym("lambda"),new Pair(formals,ret==null?body:new Pair(ret,nil))),nil)))});return ret});BiwaScheme.eq=function(a,b){return a===b};BiwaScheme.eqv=function(a,b){return a==b&&typeof a==typeof b};define_libfunc("eqv?",2,2,function(ar){return BiwaScheme.eqv(ar[0],
ar[1])});define_libfunc("eq?",2,2,function(ar){return BiwaScheme.eq(ar[0],ar[1])});define_libfunc("equal?",2,2,function(ar){return to_write(ar[0])==to_write(ar[1])});define_libfunc("procedure?",1,1,function(ar){return ar[0]instanceof Array&&ar[0].closure_p===true||typeof ar[0]=="function"});define_libfunc("number?",1,1,function(ar){return typeof ar[0]=="number"||ar[0]instanceof Complex||ar[0]instanceof Rational});define_libfunc("complex?",1,1,function(ar){return ar[0]instanceof Complex});define_libfunc("real?",
1,1,function(ar){return typeof ar[0]=="number"});define_libfunc("rational?",1,1,function(ar){return ar[0]instanceof Rational});define_libfunc("integer?",1,1,function(ar){return typeof ar[0]=="number"&&ar[0]==Math.round(ar[0])&&ar[0]!=Infinity&&ar[0]!=-Infinity});define_libfunc("=",2,null,function(ar){var v=ar[0];assert_number(ar[0]);for(var i=1;i<ar.length;i++){assert_number(ar[i]);if(ar[i]!=v)return false}return true});define_libfunc("<",2,null,function(ar){assert_number(ar[0]);for(var i=1;i<ar.length;i++){assert_number(ar[i]);
if(!(ar[i-1]<ar[i]))return false}return true});define_libfunc(">",2,null,function(ar){assert_number(ar[0]);for(var i=1;i<ar.length;i++){assert_number(ar[i]);if(!(ar[i-1]>ar[i]))return false}return true});define_libfunc("<=",2,null,function(ar){assert_number(ar[0]);for(var i=1;i<ar.length;i++){assert_number(ar[i]);if(!(ar[i-1]<=ar[i]))return false}return true});define_libfunc(">=",2,null,function(ar){assert_number(ar[0]);for(var i=1;i<ar.length;i++){assert_number(ar[i]);if(!(ar[i-1]>=ar[i]))return false}return true});
define_libfunc("zero?",1,1,function(ar){assert_number(ar[0]);return ar[0]===0});define_libfunc("positive?",1,1,function(ar){assert_number(ar[0]);return ar[0]>0});define_libfunc("negative?",1,1,function(ar){assert_number(ar[0]);return ar[0]<0});define_libfunc("odd?",1,1,function(ar){assert_number(ar[0]);return ar[0]%2==1||ar[0]%2==-1});define_libfunc("even?",1,1,function(ar){assert_number(ar[0]);return ar[0]%2==0});define_libfunc("finite?",1,1,function(ar){assert_number(ar[0]);return ar[0]!=Infinity&&
ar[0]!=-Infinity&&!isNaN(ar[0])});define_libfunc("infinite?",1,1,function(ar){assert_number(ar[0]);return ar[0]==Infinity||ar[0]==-Infinity});define_libfunc("nan?",1,1,function(ar){assert_number(ar[0]);return isNaN(ar[0])});define_libfunc("max",2,null,function(ar){for(var i=0;i<ar.length;i++)assert_number(ar[i]);return Math.max.apply(null,ar)});define_libfunc("min",2,null,function(ar){for(var i=0;i<ar.length;i++)assert_number(ar[i]);return Math.min.apply(null,ar)});define_libfunc("+",0,null,function(ar){var n=
0;for(var i=0;i<ar.length;i++){assert_number(ar[i]);n+=ar[i]}return n});define_libfunc("*",0,null,function(ar){var n=1;for(var i=0;i<ar.length;i++){assert_number(ar[i]);n*=ar[i]}return n});define_libfunc("-",1,null,function(ar){var len=ar.length;assert_number(ar[0]);if(len==1)return-ar[0];else{var n=ar[0];for(var i=1;i<len;i++){assert_number(ar[i]);n-=ar[i]}return n}});define_libfunc("/",1,null,function(ar){var len=ar.length;assert_number(ar[0]);if(len==1)return 1/ar[0];else{var n=ar[0];for(var i=
1;i<len;i++){assert_number(ar[i]);n/=ar[i]}return n}});define_libfunc("abs",1,1,function(ar){assert_number(ar[0]);return Math.abs(ar[0])});var div=function(n,m){return Math.floor(n/m)};var mod=function(n,m){return n-Math.floor(n/m)*m};var div0=function(n,m){return n>0?Math.floor(n/m):Math.ceil(n/m)};var mod0=function(n,m){return n>0?n-Math.floor(n/m)*m:n-Math.ceil(n/m)*m};define_libfunc("div0-and-mod0",2,2,function(ar){assert_number(ar[0]);assert_number(ar[1]);return new Values([div(ar[0],ar[1]),
mod(ar[0],ar[1])])});define_libfunc("div",2,2,function(ar){assert_number(ar[0]);assert_number(ar[1]);return div(ar[0],ar[1])});define_libfunc("mod",2,2,function(ar){assert_number(ar[0]);assert_number(ar[1]);return mod(ar[0],ar[1])});define_libfunc("div0-and-mod0",2,2,function(ar){assert_number(ar[0]);assert_number(ar[1]);return new Values([div0(ar[0],ar[1]),mod0(ar[0],ar[1])])});define_libfunc("div0",2,2,function(ar){assert_number(ar[0]);assert_number(ar[1]);return div0(ar[0],ar[1])});define_libfunc("mod0",
2,2,function(ar){assert_number(ar[0]);assert_number(ar[1]);return mod0(ar[0],ar[1])});define_libfunc("numerator",1,1,function(ar){assert_number(ar[0]);if(ar[0]instanceof Rational)return ar[0].numerator;else throw new Bug("todo");});define_libfunc("denominator",1,1,function(ar){assert_number(ar[0]);if(ar[0]instanceof Rational)return ar[0].denominator;else throw new Bug("todo");});define_libfunc("floor",1,1,function(ar){assert_number(ar[0]);return Math.floor(ar[0])});define_libfunc("ceiling",1,1,function(ar){assert_number(ar[0]);
return Math.ceil(ar[0])});define_libfunc("truncate",1,1,function(ar){assert_number(ar[0]);return ar[0]<0?Math.ceil(ar[0]):Math.floor(ar[0])});define_libfunc("round",1,1,function(ar){assert_number(ar[0]);return Math.round(ar[0])});define_libfunc("exp",1,1,function(ar){assert_number(ar[0]);return Math.exp(ar[0])});define_libfunc("log",1,2,function(ar){var num=ar[0],base=ar[1];assert_number(num);if(base){assert_number(base);return Math.log(num)/Math.log(b)}else return Math.log(num)});define_libfunc("sin",
1,1,function(ar){assert_number(ar[0]);return Math.sin(ar[0])});define_libfunc("cos",1,1,function(ar){assert_number(ar[0]);return Math.cos(ar[0])});define_libfunc("tan",1,1,function(ar){assert_number(ar[0]);return Math.tan(ar[0])});define_libfunc("asin",1,1,function(ar){assert_number(ar[0]);return Math.asin(ar[0])});define_libfunc("acos",1,1,function(ar){assert_number(ar[0]);return Math.acos(ar[0])});define_libfunc("atan",1,2,function(ar){assert_number(ar[0]);if(ar[1]){assert_number(ar[1]);return Math.atan2(ar[0],
ar[1])}else return Math.atan(ar[0])});define_libfunc("sqrt",1,1,function(ar){assert_number(ar[0]);return Math.sqrt(ar[0])});define_libfunc("exact-integer-sqrt",1,1,function(ar){assert_number(ar[0]);var sqrt_f=Math.sqrt(ar[0]);var sqrt_i=sqrt_f-sqrt_f%1;var rest=ar[0]-sqrt_i*sqrt_i;return new Values([sqrt_i,rest])});define_libfunc("expt",2,2,function(ar){assert_number(ar[0]);assert_number(ar[1]);return Math.pow(ar[0],ar[1])});define_libfunc("make-rectangular",2,2,function(ar){assert_number(ar[0]);
assert_number(ar[1]);return new Complex(ar[0],ar[1])});define_libfunc("make-polar",2,2,function(ar){assert_number(ar[0]);assert_number(ar[1]);return Complex.from_polar(ar[0],ar[1])});define_libfunc("real-part",1,1,function(ar){assert_number(ar[0]);return Complex.assure(ar[0]).real});define_libfunc("imag-part",1,1,function(ar){assert_number(ar[0]);return Complex.assure(ar[0]).imag});define_libfunc("magnitude",1,1,function(ar){assert_number(ar[0]);return Complex.assure(ar[0]).magnitude()});define_libfunc("angle",
1,1,function(ar){assert_number(ar[0]);return Complex.assure(ar[0]).angle()});define_libfunc("number->string",1,3,function(ar){var z=ar[0],radix=ar[1],precision=ar[2];if(precision)throw new Bug("number->string: precision is not yet implemented");radix=radix||10;return z.toString(radix)});define_libfunc("string->number",1,3,function(ar){var s=ar[0],radix=ar[1]||10;switch(s){case "+inf.0":return Infinity;case "-inf.0":return-Infinity;case "+nan.0":return NaN;default:if(s.match(/[eE.]/))return parseFloat(s);
else return parseInt(s,radix)}});define_libfunc("not",1,1,function(ar){return ar[0]===false?true:false});define_libfunc("boolean?",1,1,function(ar){return ar[0]===false||ar[0]===true?true:false});define_libfunc("boolean=?",2,null,function(ar){var len=ar.length;for(var i=1;i<len;i++)if(ar[i]!=ar[0])return false;return true});define_libfunc("pair?",1,1,function(ar){return ar[0]instanceof Pair?true:false});define_libfunc("cons",2,2,function(ar){return new Pair(ar[0],ar[1])});define_libfunc("car",1,1,
function(ar){if(!(ar[0]instanceof Pair))throw new Error("Attempt to apply car on "+ar[0]);return ar[0].car});define_libfunc("cdr",1,1,function(ar){if(!(ar[0]instanceof Pair))throw new Error("Attempt to apply cdr on "+ar[0]);return ar[0].cdr});define_libfunc("set-car!",2,2,function(ar){if(!(ar[0]instanceof Pair))throw new Error("Attempt to apply set-car! on "+ar[0]);ar[0].car=ar[1];return BiwaScheme.undef});define_libfunc("set-cdr!",2,2,function(ar){if(!(ar[0]instanceof Pair))throw new Error("Attempt to apply set-cdr! on "+
ar[0]);ar[0].cdr=ar[1];return BiwaScheme.undef});define_libfunc("caar",1,1,function(ar){return ar[0].car.car});define_libfunc("cadr",1,1,function(ar){return ar[0].cdr.car});define_libfunc("cdar",1,1,function(ar){return ar[0].car.cdr});define_libfunc("cddr",1,1,function(ar){return ar[0].cdr.cdr});define_libfunc("caaar",1,1,function(ar){return ar[0].car.car.car});define_libfunc("caadr",1,1,function(ar){return ar[0].cdr.car.car});define_libfunc("cadar",1,1,function(ar){return ar[0].car.cdr.car});define_libfunc("caddr",
1,1,function(ar){return ar[0].cdr.cdr.car});define_libfunc("cdaar",1,1,function(ar){return ar[0].car.car.cdr});define_libfunc("cdadr",1,1,function(ar){return ar[0].cdr.car.cdr});define_libfunc("cddar",1,1,function(ar){return ar[0].car.cdr.cdr});define_libfunc("cdddr",1,1,function(ar){return ar[0].cdr.cdr.cdr});define_libfunc("caaaar",1,1,function(ar){return ar[0].car.car.car.car});define_libfunc("caaadr",1,1,function(ar){return ar[0].cdr.car.car.car});define_libfunc("caadar",1,1,function(ar){return ar[0].car.cdr.car.car});
define_libfunc("caaddr",1,1,function(ar){return ar[0].cdr.cdr.car.car});define_libfunc("cadaar",1,1,function(ar){return ar[0].car.car.cdr.car});define_libfunc("cadadr",1,1,function(ar){return ar[0].cdr.car.cdr.car});define_libfunc("caddar",1,1,function(ar){return ar[0].car.cdr.cdr.car});define_libfunc("cadddr",1,1,function(ar){return ar[0].cdr.cdr.cdr.car});define_libfunc("cdaaar",1,1,function(ar){return ar[0].car.car.car.cdr});define_libfunc("cdaadr",1,1,function(ar){return ar[0].cdr.car.car.cdr});
define_libfunc("cdadar",1,1,function(ar){return ar[0].car.cdr.car.cdr});define_libfunc("cdaddr",1,1,function(ar){return ar[0].cdr.cdr.car.cdr});define_libfunc("cddaar",1,1,function(ar){return ar[0].car.car.cdr.cdr});define_libfunc("cddadr",1,1,function(ar){return ar[0].cdr.car.cdr.cdr});define_libfunc("cdddar",1,1,function(ar){return ar[0].car.cdr.cdr.cdr});define_libfunc("cddddr",1,1,function(ar){return ar[0].cdr.cdr.cdr.cdr});define_libfunc("null?",1,1,function(ar){return ar[0]===nil});define_libfunc("list?",
1,1,function(ar){var contents=[];for(var o=ar[0];o!=nil;o=o.cdr){if(o==nil)return true;if(!(o instanceof Pair))return false;if(_.detect(contents,function(item){return item===o.car}))return false;contents.push(o.car)}return true});define_libfunc("list",0,null,function(ar){var l=nil;for(var i=ar.length-1;i>=0;i--)l=new Pair(ar[i],l);return l});define_libfunc("length",1,1,function(ar){assert_list(ar[0]);var n=0;for(var o=ar[0];o!=nil;o=o.cdr)n++;return n});define_libfunc("append",2,null,function(ar){var k=
ar.length;var ret=ar[--k];while(k--)_.each(ar[k].to_array().reverse(),function(item){ret=new Pair(item,ret)});return ret});define_libfunc("reverse",1,1,function(ar){if(!ar[0]instanceof Pair)throw new Error("reverse needs pair but got "+ar[0]);var l=nil;for(var o=ar[0];o!=nil;o=o.cdr)l=new Pair(o.car,l);return l});define_libfunc("list-tail",2,2,function(ar){if(!ar[0]instanceof Pair)throw new Error("list-tail needs pair but got "+ar[0]);var o=ar[0];for(var i=0;i<ar[1];i++){if(!o instanceof Pair)throw new Error("list-tail: the list is shorter than "+
ar[1]);o=o.cdr}return o});define_libfunc("list-ref",2,2,function(ar){if(!ar[0]instanceof Pair)throw new Error("list-ref needs pair but got "+ar[0]);var o=ar[0];for(var i=0;i<ar[1];i++){if(!o instanceof Pair)throw new Error("list-ref: the list is shorter than "+ar[1]);o=o.cdr}return o.car});define_libfunc("map",2,null,function(ar){var proc=ar.shift(),lists=ar;_.each(lists,assert_list);var a=[];return Call.multi_foreach(lists,{call:function(xs){return new Call(proc,_.map(xs,function(x){return x.car}))},
result:function(res){a.push(res)},finish:function(){return array_to_list(a)}})});define_libfunc("for-each",2,null,function(ar){var proc=ar.shift(),lists=ar;_.each(lists,assert_list);return Call.multi_foreach(lists,{call:function(xs){return new Call(proc,_.map(xs,function(x){return x.car}))},finish:function(){return BiwaScheme.undef}})});define_libfunc("symbol?",1,1,function(ar){return ar[0]instanceof Symbol?true:false});define_libfunc("symbol->string",1,1,function(ar){assert_symbol(ar[0]);return ar[0].name});
define_libfunc("symbol=?",2,null,function(ar){assert_symbol(ar[0]);for(var i=1;i<ar.length;i++){assert_symbol(ar[i]);if(ar[i]!=ar[0])return false}return true});define_libfunc("string->symbol",1,1,function(ar){assert_string(ar[0]);return Sym(ar[0])});define_libfunc("char?",1,1,function(ar){return ar[0]instanceof Char});define_libfunc("char->integer",1,1,function(ar){assert_char(ar[0]);return ar[0].value.charCodeAt(0)});define_libfunc("integer->char",1,1,function(ar){assert_integer(ar[0]);return Char.get(String.fromCharCode(ar[0]))});
var make_char_compare_func=function(test){return function(ar){assert_char(ar[0]);for(var i=1;i<ar.length;i++){assert_char(ar[i]);if(!test(ar[i-1].value,ar[i].value))return false}return true}};define_libfunc("char=?",2,null,make_char_compare_func(function(a,b){return a==b}));define_libfunc("char<?",2,null,make_char_compare_func(function(a,b){return a<b}));define_libfunc("char>?",2,null,make_char_compare_func(function(a,b){return a>b}));define_libfunc("char<=?",2,null,make_char_compare_func(function(a,
b){return a<=b}));define_libfunc("char>=?",2,null,make_char_compare_func(function(a,b){return a>=b}));define_libfunc("string?",1,1,function(ar){return typeof ar[0]=="string"});define_libfunc("make-string",1,2,function(ar){assert_integer(ar[0]);var c=" ";if(ar[1]){assert_char(ar[1]);c=ar[1].value}var out="";_.times(ar[0],function(){out+=c});return out});define_libfunc("string",1,null,function(ar){for(var i=0;i<ar.length;i++)assert_char(ar[i]);return _.map(ar,function(c){return c.value}).join("")});
define_libfunc("string-length",1,1,function(ar){assert_string(ar[0]);return ar[0].length});define_libfunc("string-ref",2,2,function(ar){assert_string(ar[0]);assert_between(ar[1],0,ar[0].length-1);return Char.get(ar[0].charAt([ar[1]]))});define_libfunc("string=?",2,null,function(ar){assert_string(ar[0]);for(var i=1;i<ar.length;i++){assert_string(ar[i]);if(ar[0]!=ar[i])return false}return true});define_libfunc("string<?",2,null,function(ar){assert_string(ar[0]);for(var i=1;i<ar.length;i++){assert_string(ar[i]);
if(!(ar[i-1]<ar[i]))return false}return true});define_libfunc("string>?",2,null,function(ar){assert_string(ar[0]);for(var i=1;i<ar.length;i++){assert_string(ar[i]);if(!(ar[i-1]>ar[i]))return false}return true});define_libfunc("string<=?",2,null,function(ar){assert_string(ar[0]);for(var i=1;i<ar.length;i++){assert_string(ar[i]);if(!(ar[i-1]<=ar[i]))return false}return true});define_libfunc("string>=?",2,null,function(ar){assert_string(ar[0]);for(var i=1;i<ar.length;i++){assert_string(ar[i]);if(!(ar[i-
1]>=ar[i]))return false}return true});define_libfunc("substring",3,3,function(ar){assert_string(ar[0]);assert_integer(ar[1]);assert_integer(ar[2]);if(ar[1]<0)throw new Error("substring: start too small: "+ar[1]);if(ar[2]<0)throw new Error("substring: end too small: "+ar[2]);if(ar[0].length+1<=ar[1])throw new Error("substring: start too big: "+ar[1]);if(ar[0].length+1<=ar[2])throw new Error("substring: end too big: "+ar[2]);if(!(ar[1]<=ar[2]))throw new Error("substring: not start <= end: "+ar[1]+", "+
ar[2]);return ar[0].substring(ar[1],ar[2])});define_libfunc("string-append",0,null,function(ar){for(var i=0;i<ar.length;i++)assert_string(ar[i]);return ar.join("")});define_libfunc("string->list",1,1,function(ar){assert_string(ar[0]);return array_to_list(_.map(ar[0].split(""),function(s){return Char.get(s[0])}))});define_libfunc("list->string",1,1,function(ar){assert_list(ar[0]);return _.map(ar[0].to_array(),function(c){return c.value}).join("")});define_libfunc("string-for-each",2,null,function(ar){var proc=
ar.shift(),strs=ar;_.each(strs,assert_string);return Call.multi_foreach(strs,{call:function(chars){return new Call(proc,chars)},finish:function(){return BiwaScheme.undef}})});define_libfunc("string-copy",1,1,function(ar){assert_string(ar[0]);return ar[0]});define_libfunc("vector?",1,1,function(ar){return ar[0]instanceof Array&&ar[0].closure_p!==true});define_libfunc("make-vector",1,2,function(ar){assert_integer(ar[0]);var vec=new Array(ar[0]);if(ar.length==2)for(var i=0;i<ar[0];i++)vec[i]=ar[1];return vec});
define_libfunc("vector",1,null,function(ar){return ar});define_libfunc("vector-length",1,1,function(ar){assert_vector(ar[0]);return ar[0].length});define_libfunc("vector-ref",2,2,function(ar){assert_vector(ar[0]);assert_integer(ar[1]);return ar[0][ar[1]]});define_libfunc("vector-set!",3,3,function(ar){assert_vector(ar[0]);assert_integer(ar[1]);ar[0][ar[1]]=ar[2];return BiwaScheme.undef});define_libfunc("vector->list",1,1,function(ar){assert_vector(ar[0]);return array_to_list(ar[0])});define_libfunc("list->vector",
1,1,function(ar){assert_list(ar[0]);return ar[0].to_array()});define_libfunc("vector-fill!",2,2,function(ar){assert_vector(ar[0]);var vec=ar[0],obj=ar[1];for(var i=0;i<vec.length;i++)vec[i]=obj;return vec});define_libfunc("vector-map",2,null,function(ar){var proc=ar.shift(),vecs=ar;_.each(vecs,assert_vector);var a=[];return Call.multi_foreach(vecs,{call:function(objs){return new Call(proc,objs)},result:function(res){a.push(res)},finish:function(){return a}})});define_libfunc("vector-for-each",2,null,
function(ar){var proc=ar.shift(),vecs=ar;_.each(vecs,assert_vector);return Call.multi_foreach(vecs,{call:function(objs){return new Call(proc,objs)},finish:function(){return BiwaScheme.undef}})});define_libfunc("apply",2,null,function(ar){var proc=ar.shift(),rest_args=ar.pop(),args=ar;args=args.concat(rest_args.to_array());return new Call(proc,args)});define_syntax("call-with-current-continuation",function(x){return new Pair(Sym("call/cc"),x.cdr)});define_libfunc("values",0,null,function(ar){return new Values(ar)});
define_libfunc("call-with-values",2,2,function(ar){var producer=ar[0],consumer=ar[1];return new Call(producer,[],function(ar){var values=ar[0];if(!(values instanceof Values))throw new Error("values expected, but got "+to_write(values));return new Call(consumer,values.content)})});var expand_qq=function(f,lv){if(f instanceof Symbol||f===nil)return List(Sym("quote"),f);else if(f instanceof Pair){var car=f.car;if(car instanceof Pair&&car.car===Sym("unquote-splicing")){var lv=lv-1;if(lv==0)return List(Sym("append"),
f.car.cdr.car,expand_qq(f.cdr,lv+1));else return List(Sym("cons"),List(Sym("list"),Sym("unquote-splicing"),expand_qq(f.car.cdr.car,lv)),expand_qq(f.cdr,lv+1))}else if(car===Sym("unquote")){var lv=lv-1;if(lv==0)return f.cdr.car;else return List(Sym("list"),List(Sym("quote"),Sym("unquote")),expand_qq(f.cdr.car,lv))}else if(car===Sym("quasiquote"))return List(Sym("list"),Sym("quasiquote"),expand_qq(f.cdr.car,lv+1));else return List(Sym("cons"),expand_qq(f.car,lv),expand_qq(f.cdr,lv))}else if(f instanceof
Array)throw new Bug("vector quasiquotation is not implemented yet");else return f};define_syntax("quasiquote",function(x){return expand_qq(x.cdr.car,1)});define_syntax("unquote",function(x){throw new Error("unquote(,) must be inside quasiquote(`)");});define_syntax("unquote-splicing",function(x){throw new Error("unquote-splicing(,@) must be inside quasiquote(`)");});define_libfunc("string-upcase",1,1,function(ar){assert_string(ar[0]);return ar[0].toUpperCase()});define_libfunc("string-downcase",1,
1,function(ar){assert_string(ar[0]);return ar[0].toLowerCase()});BiwaScheme.make_string_ci_function=function(compare){return function(ar){assert_string(ar[0]);var str=ar[0].toUpperCase();for(var i=1;i<ar.length;i++){assert_string(ar[i]);if(!compare(str,ar[i].toUpperCase()))return false}return true}};define_libfunc("string-ci=?",2,null,make_string_ci_function(function(a,b){return a==b}));define_libfunc("string-ci<?",2,null,make_string_ci_function(function(a,b){return a<b}));define_libfunc("string-ci>?",
2,null,make_string_ci_function(function(a,b){return a>b}));define_libfunc("string-ci<=?",2,null,make_string_ci_function(function(a,b){return a<=b}));define_libfunc("string-ci>=?",2,null,make_string_ci_function(function(a,b){return a>=b}));define_libfunc("find",2,2,function(ar){var proc=ar[0],ls=ar[1];assert_list(ls);return Call.foreach(ls,{call:function(x){return new Call(proc,[x.car])},result:function(res,x){if(res)return x.car},finish:function(){return false}})});define_libfunc("for-all",2,null,
function(ar){var proc=ar.shift();var lists=ar;_.each(lists,assert_list);var last=true;return Call.multi_foreach(lists,{call:function(pairs){return new Call(proc,_.map(pairs,function(x){return x.car}))},result:function(res,pairs){if(res===false)return false;last=res},finish:function(){return last}})});define_libfunc("exists",2,null,function(ar){var proc=ar.shift();var lists=ar;_.each(lists,assert_list);return Call.multi_foreach(lists,{call:function(pairs){return new Call(proc,_.map(pairs,function(x){return x.car}))},
result:function(res,pairs){if(res!==false)return res},finish:function(){return false}})});define_libfunc("filter",2,2,function(ar){var proc=ar[0],ls=ar[1];assert_list(ls);var a=[];return Call.foreach(ls,{call:function(x){return new Call(proc,[x.car])},result:function(res,x){if(res)a.push(x.car)},finish:function(){return array_to_list(a)}})});define_libfunc("partition",2,2,function(ar){var proc=ar[0],ls=ar[1];assert_list(ls);var t=[],f=[];return Call.foreach(ls,{call:function(x){return new Call(proc,
[x.car])},result:function(res,x){if(res)t.push(x.car);else f.push(x.car)},finish:function(){return new Values([array_to_list(t),array_to_list(f)])}})});define_libfunc("fold-left",3,null,function(ar){var proc=ar.shift(),accum=ar.shift(),lists=ar;_.each(lists,assert_list);return Call.multi_foreach(lists,{call:function(pairs){var args=_.map(pairs,function(x){return x.car});args.unshift(accum);return new Call(proc,args)},result:function(res,pairs){accum=res},finish:function(){return accum}})});define_libfunc("fold-right",
3,null,function(ar){var proc=ar.shift(),accum=ar.shift();var lists=_.map(ar,function(ls){assert_list(ls);return array_to_list(ls.to_array().reverse())});return Call.multi_foreach(lists,{call:function(pairs){var args=_.map(pairs,function(x){return x.car});args.push(accum);return new Call(proc,args)},result:function(res,pairs){accum=res},finish:function(){return accum}})});define_libfunc("remp",2,2,function(ar){var proc=ar[0],ls=ar[1];assert_list(ls);var ret=[];return Call.foreach(ls,{call:function(x){return new Call(proc,
[x.car])},result:function(res,x){if(!res)ret.push(x.car)},finish:function(){return array_to_list(ret)}})});var make_remover=function(key){return function(ar){var obj=ar[0],ls=ar[1];assert_list(ls);var ret=[];return Call.foreach(ls,{call:function(x){return new Call(TopEnv[key]||CoreEnv[key],[obj,x.car])},result:function(res,x){if(!res)ret.push(x.car)},finish:function(){return array_to_list(ret)}})}};define_libfunc("remove",2,2,make_remover("equal?"));define_libfunc("remv",2,2,make_remover("eqv?"));
define_libfunc("remq",2,2,make_remover("eq?"));define_libfunc("memp",2,2,function(ar){var proc=ar[0],ls=ar[1];assert_list(ls);var ret=[];return Call.foreach(ls,{call:function(x){return new Call(proc,[x.car])},result:function(res,x){if(res)return x},finish:function(){return false}})});var make_finder=function(key){return function(ar){var obj=ar[0],ls=ar[1];assert_list(ls);var ret=[];return Call.foreach(ls,{call:function(x){return new Call(TopEnv[key]||CoreEnv[key],[obj,x.car])},result:function(res,
x){if(res)return x},finish:function(){return false}})}};define_libfunc("member",2,2,make_finder("equal?"));define_libfunc("memv",2,2,make_finder("eqv?"));define_libfunc("memq",2,2,make_finder("eq?"));define_libfunc("assp",2,2,function(ar){var proc=ar[0],als=ar[1];assert_list(als);var ret=[];return Call.foreach(als,{call:function(x){if(x.car.car)return new Call(proc,[x.car.car]);else throw new Error("ass*: pair required but got "+to_write(x.car));},result:function(res,x){if(res)return x.car},finish:function(){return false}})});
var make_assoc=function(key){return function(ar){var obj=ar[0],ls=ar[1];assert_list(ls);var ret=[];return Call.foreach(ls,{call:function(x){if(x.car.car)return new Call(TopEnv[key]||CoreEnv[key],[obj,x.car.car]);else throw new Error("ass*: pair required but got "+to_write(x.car));},result:function(res,x){if(res)return x.car},finish:function(){return false}})}};define_libfunc("assoc",2,2,make_assoc("equal?"));define_libfunc("assv",2,2,make_assoc("eqv?"));define_libfunc("assq",2,2,make_assoc("eq?"));
define_libfunc("cons*",1,null,function(ar){if(ar.length==1)return ar[0];else{var ret=null;_.each(ar.reverse(),function(x){if(ret)ret=new Pair(x,ret);else ret=x});return ret}});define_libfunc("list-sort",1,2,function(ar){if(ar[1])throw new Bug("list-sort: cannot take compare proc now");assert_list(ar[0]);return array_to_list(ar[0].to_array().sort())});define_libfunc("vector-sort",1,2,function(ar){if(ar[1])throw new Bug("vector-sort: cannot take compare proc now");assert_vector(ar[0]);return _.clone(ar[0]).sort()});
define_libfunc("vector-sort!",1,2,function(ar){if(ar[1])throw new Bug("vector-sort!: cannot take compare proc now");assert_vector(ar[0]);ar[0].sort();return BiwaScheme.undef});define_syntax("when",function(x){var test=x.cdr.car,body=x.cdr.cdr;return new Pair(Sym("if"),new Pair(test,new Pair(new Pair(Sym("begin"),body),new Pair(BiwaScheme.undef,nil))))});define_syntax("unless",function(x){var test=x.cdr.car,body=x.cdr.cdr;return new Pair(Sym("if"),new Pair(new Pair(Sym("not"),new Pair(test,nil)),new Pair(new Pair(Sym("begin"),
body),new Pair(BiwaScheme.undef,nil))))});define_syntax("do",function(x){if(!BiwaScheme.isPair(x.cdr))throw new Error("do: no variables of do");var varsc=x.cdr.car;if(!BiwaScheme.isPair(varsc))throw new Error("do: variables must be given as a list");if(!BiwaScheme.isPair(x.cdr.cdr))throw new Error("do: no resulting form of do");var resultc=x.cdr.cdr.car;var bodyc=x.cdr.cdr.cdr;var loop=BiwaScheme.gensym();var init_vars=array_to_list(varsc.map(function(var_def){var a=var_def.to_array();return List(a[0],
a[1])}));var test=resultc.car;var result_exprs=new Pair(Sym("begin"),resultc.cdr);var next_loop=new Pair(loop,array_to_list(varsc.map(function(var_def){var a=var_def.to_array();return a[2]||a[0]})));var body_exprs=(new Pair(Sym("begin"),bodyc)).concat(List(next_loop));return List(Sym("let"),loop,init_vars,List(Sym("if"),test,result_exprs,body_exprs))});define_syntax("case-lambda",function(x){});define_syntax("define-record-type",function(x){var name_spec=x.cdr.car;var record_clauses=x.cdr.cdr;if(BiwaScheme.isSymbol(name_spec)){var record_name=
name_spec;var constructor_name=Sym("make-"+name_spec.name);var predicate_name=Sym(name_spec.name+"?")}else{assert_list(name_spec);var record_name=name_spec.car;var constructor_name=name_spec.cdr.car;var predicate_name=name_spec.cdr.cdr.car;assert_symbol(record_name);assert_symbol(constructor_name);assert_symbol(predicate_name)}var sealed=false;var opaque=false;var nongenerative=false;var uid=false;var parent_name;var parent_rtd=false;var parent_cd=false;var protocol=false;var fields=[];_.each(record_clauses.to_array(),
function(clause){switch(clause.car){case Sym("fields"):fields=_.map(clause.cdr.to_array(),function(field_spec,idx){if(BiwaScheme.isSymbol(field_spec))return{name:field_spec,idx:idx,mutable:false,accessor_name:null,mutator_name:null};else{assert_list(field_spec);assert_symbol(field_spec.car);switch(field_spec.car){case Sym("immutable"):var field_name=field_spec.cdr.car;assert_symbol(field_name);if(BiwaScheme.isNil(field_spec.cdr.cdr))return{name:field_name,idx:idx,mutable:false};else return{name:field_name,
idx:idx,mutable:false,accessor_name:field_spec.cdr.cdr.car};break;case Sym("mutable"):var field_name=field_spec.cdr.car;assert_symbol(field_name);if(BiwaScheme.isNil(field_spec.cdr.cdr))return{name:field_name,idx:idx,mutable:true};else return{name:field_name,idx:idx,mutable:true,accessor_name:field_spec.cdr.cdr.car,mutator_name:field_spec.cdr.cdr.cdr.car};break;default:throw new Error("define-record-type: field definition "+"must start with `immutable' or 'mutable'");}}});break;case Sym("parent"):parent_name=
clause.cdr.car;assert_symbol(parent_name);break;case Sym("protocol"):protocol=clause.cdr.car;break;case Sym("sealed"):sealed=!!clause.cdr.car;break;case Sym("opaque"):opaque=!!clause.cdr.car;break;case Sym("nongenerative"):nongenerative=true;uid=clause.cdr.car;break;case Sym("parent-rtd"):parent_rtd=clause.cdr.car;parent_cd=clause.cdr.cdr.car;break;default:throw new BiwaScheme.Error("define-record-type: unknown clause `"+BiwaScheme.to_write(clause.car)+"'");}});if(parent_name){parent_rtd=[Sym("record-type-descriptor"),
parent_name];parent_cd=[Sym("record-constructor-descriptor"),parent_name]}var rtd=[Sym("record-type-descriptor"),record_name];var cd=[Sym("record-constructor-descriptor"),record_name];var rtd_fields=_.map(fields,function(field){return List(Sym(field.mutable?"mutable":"immutable"),field.name)});rtd_fields.is_vector=true;var rtd_def=[Sym("make-record-type-descriptor"),[Sym("quote"),record_name],parent_rtd,uid,sealed,opaque,rtd_fields];var cd_def=[Sym("make-record-constructor-descriptor"),Sym("__rtd"),
parent_cd,protocol];var registration=[Sym("let*"),[[Sym("__rtd"),rtd_def],[Sym("__cd"),cd_def]],[Sym("_define-record-type"),[Sym("quote"),record_name],Sym("__rtd"),Sym("__cd")]];var accessor_defs=_.map(fields,function(field){var name=field.accessor_name||Sym(record_name.name+"-"+field.name.name);return[Sym("define"),name,[Sym("record-accessor"),rtd,field.idx]]});var mutator_defs=_.filter(fields,function(field){return field.mutable});mutator_defs=_.map(mutator_defs,function(field){var name=field.mutator_name||
Sym("set-"+record_name.name+"-"+field.name.name+"!");return[Sym("define"),name,[Sym("record-mutator"),rtd,field.idx]]});return List.apply(null,[Sym("begin"),registration,[Sym("define"),constructor_name,[Sym("record-constructor"),cd]],[Sym("define"),predicate_name,[Sym("record-predicate"),rtd]]].concat(accessor_defs).concat(mutator_defs))});define_libfunc("_define-record-type",3,3,function(ar){assert_symbol(ar[0]);assert_record_td(ar[1]);assert_record_cd(ar[2]);BiwaScheme.Record.define_type(ar[0].name,
ar[1],ar[2]);return BiwaScheme.undef});define_syntax("record-type-descriptor",function(x){return List(Sym("_record-type-descriptor"),[Sym("quote"),x.cdr.car])});define_libfunc("_record-type-descriptor",1,1,function(ar){assert_symbol(ar[0]);var type=BiwaScheme.Record.get_type(ar[0].name);if(type)return type.rtd;else throw new Error("record-type-descriptor: unknown record type "+ar[0].name);});define_syntax("record-constructor-descriptor",function(x){return List(Sym("_record-constructor-descriptor"),
[Sym("quote"),x.cdr.car])});define_libfunc("_record-constructor-descriptor",1,1,function(ar){assert_symbol(ar[0]);var type=BiwaScheme.Record.get_type(ar[0].name);if(type)return type.cd;else throw new Error("record-constructor-descriptor: unknown record type "+ar[0].name);});define_libfunc("make-record-type-descriptor",6,6,function(ar){var name=ar[0],parent_rtd=ar[1],uid=ar[2],sealed=ar[3],opaque=ar[4],fields=ar[5];assert_symbol(name);if(parent_rtd)assert_record_td(parent_rtd);if(uid){assert_symbol(uid);
var _rtd=BiwaScheme.Record.RTD.NongenerativeRecords[uid.name];if(_rtd)return _rtd}sealed=!!sealed;opaque=!!opaque;assert_vector(fields);for(var i=0;i<fields.length;i++){var list=fields[i];assert_symbol(list.car,"mutability");assert_symbol(list.cdr.car,"field name");fields[i]=[list.cdr.car.name,list.car==Sym("mutable")]}var rtd=new BiwaScheme.Record.RTD(name,parent_rtd,uid,sealed,opaque,fields);if(uid)BiwaScheme.Record.RTD.NongenerativeRecords[uid.name]=rtd;return rtd});define_libfunc("record-type-descriptor?",
1,1,function(ar){return ar[0]instanceof BiwaScheme.Record.RTD});define_libfunc("make-record-constructor-descriptor",3,3,function(ar){var rtd=ar[0],parent_cd=ar[1],protocol=ar[2];assert_record_td(rtd);if(parent_cd)assert_record_cd(parent_cd);if(protocol)assert_procedure(protocol);return new BiwaScheme.Record.CD(rtd,parent_cd,protocol)});define_libfunc("record-constructor",1,1,function(ar){var cd=ar[0];assert_record_cd(cd);return cd.record_constructor()});define_libfunc("record-predicate",1,1,function(ar){var rtd=
ar[0];assert_record_td(rtd);return function(args){var obj=args[0];return obj instanceof BiwaScheme.Record&&obj.rtd===rtd}});define_libfunc("record-accessor",2,2,function(ar){var rtd=ar[0],k=ar[1];assert_record_td(rtd);assert_integer(k);for(var _rtd=rtd.parent_rtd;_rtd;_rtd=_rtd.parent_rtd)k+=_rtd.fields.length;return function(args){var record=args[0];assert_record(record);var descendant=false;for(var _rtd=record.rtd;_rtd;_rtd=_rtd.parent_rtd)if(_rtd==rtd)descendant=true;assert(descendant,"(record-accessor): "+
BiwaScheme.to_write(record)+" is not a "+rtd.name);return record.get(k)}});define_libfunc("record-mutator",2,2,function(ar){var rtd=ar[0],k=ar[1];assert_record_td(rtd);assert_integer(k);for(var _rtd=rtd.parent_rtd;_rtd;_rtd=_rtd.parent_rtd)k+=_rtd.fields.length;return function(args){var record=args[0],val=args[1];assert_record(record);assert(record.rtd===rtd,"(record-mutator): "+BiwaScheme.to_write(record)+" is not a "+rtd.name);assert(!record.rtd.sealed,"(record-mutator): "+rtd.name+" is sealed (can't mutate)");
record.set(k,val)}});define_libfunc("record?",1,1,function(ar){var obj=ar[0];if(BiwaScheme.isRecord(obj))if(obj.rtd.opaque)return false;else return true;else return false});define_libfunc("record-rtd",1,1,function(ar){assert_record(ar[0]);return ar[0].rtd});define_libfunc("record-type-name",1,1,function(ar){assert_record_td(ar[0]);return ar[0].name});define_libfunc("record-type-parent",1,1,function(ar){assert_record_td(ar[0]);return ar[0].parent_rtd});define_libfunc("record-type-uid",1,1,function(ar){assert_record_td(ar[0]);
return ar[0].uid});define_libfunc("record-type-generative?",1,1,function(ar){assert_record_td(ar[0]);return ar[0].generative});define_libfunc("record-type-sealed?",1,1,function(ar){assert_record_td(ar[0]);return ar[0].sealed});define_libfunc("record-type-opaque?",1,1,function(ar){assert_record_td(ar[0]);return ar[0].opaque});define_libfunc("record-type-field-names",1,1,function(ar){assert_record_td(ar[0]);return _.map(ar[0].fields,function(field){return field.name})});define_libfunc("record-field-mutable?",
2,2,function(ar){var rtd=ar[0],k=ar[1];assert_record_td(ar[0]);assert_integer(k);for(var _rtd=rtd.parent_rtd;_rtd;_rtd=_rtd.parent_rtd)k+=_rtd.fields.length;return ar[0].fields[k].mutable});define_libfunc("raise",1,1,function(ar){throw new BiwaScheme.UserError(BiwaScheme.to_write(ar[0]));});define_libfunc("port?",1,1,function(ar){return ar[0]instanceof Port});define_libfunc("textual-port?",1,1,function(ar){assert_port(ar[0]);return!ar[0].is_binary});define_libfunc("binary-port?",1,1,function(ar){assert_port(ar[0]);
return ar[0].is_binary});define_libfunc("close-port",1,1,function(ar){assert_port(ar[0]);ar[0].close();return BiwaScheme.undef});define_libfunc("call-with-port",2,2,function(ar){var port=ar[0],proc=ar[1];assert_port(port);assert_closure(proc);return new Call(proc,[port],function(ar){port.close();return ar[0]})});define_libfunc("put-char",2,2,function(ar){assert_port(ar[0]);assert_char(ar[1]);ar[0].put_string(ar[1].value);return BiwaScheme.undef});define_libfunc("put-string",2,2,function(ar){assert_port(ar[0]);
assert_string(ar[1]);ar[0].put_string(ar[1]);return BiwaScheme.undef});define_libfunc("put-datum",2,2,function(ar){assert_port(ar[0]);ar[0].put_string(to_write(ar[1]));return BiwaScheme.undef});define_libfunc("eof-object",0,0,function(ar){return eof});define_libfunc("eof-object?",1,1,function(ar){return ar[0]===eof});define_libfunc("input-port?",1,1,function(ar){assert_port(ar[0]);return ar[0].is_input});define_libfunc("output-port?",1,1,function(ar){assert_port(ar[0]);return ar[0].is_output});define_libfunc("current-input-port",
0,0,function(ar){return Port.current_input});define_libfunc("current-output-port",0,0,function(ar){return Port.current_output});define_libfunc("current-error-port",0,0,function(ar){return Port.current_error});define_libfunc("close-input-port",1,1,function(ar){assert_port(ar[0]);if(!ar[0].is_input)throw new Error("close-input-port: port is not input port");ar[0].close();return BiwaScheme.undef});define_libfunc("close-output-port",1,1,function(ar){assert_port(ar[0]);if(!ar[0].is_output)throw new Error("close-output-port: port is not output port");
ar[0].close();return BiwaScheme.undef});define_libfunc("read",0,1,function(ar){var port=ar[0]||Port.current_input;assert_port(port);return port.get_string(function(str){return Interpreter.read(str)})});define_libfunc("newline",0,1,function(ar){var port=ar[0]||Port.current_output;port.put_string("\n");return BiwaScheme.undef});define_libfunc("display",1,2,function(ar){var port=ar[1]||Port.current_output;port.put_string(to_display(ar[0]));return BiwaScheme.undef});define_libfunc("write",1,2,function(ar){var port=
ar[1]||Port.current_output;assert_port(port);port.put_string(to_write(ar[0]));return BiwaScheme.undef});define_libfunc("file-exists?",1,1,function(ar){netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");assert_string(ar[0]);var fileIn=FileIO.open(ar[0]);return fileIn.exists()});define_libfunc("delete-file",1,1,function(ar){netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");assert_string(ar[0]);var deleted=FileIO.unlink(FileIO.open(ar[0]));if(!deleted)puts("delete-file: cannot delete "+
ar[0]);return BiwaScheme.undef});define_libfunc("make-eq-hashtable",0,1,function(ar){return new Hashtable(Hashtable.eq_hash,Hashtable.eq_equiv)});define_libfunc("make-eqv-hashtable",0,1,function(ar){return new Hashtable(Hashtable.eqv_hash,Hashtable.eqv_equiv)});define_libfunc("make-hashtable",2,3,function(ar){assert_procedure(ar[0]);assert_procedure(ar[1]);return new Hashtable(ar[0],ar[1])});define_libfunc("hashtable?",1,1,function(ar){return ar[0]instanceof Hashtable});define_libfunc("hashtable-size",
1,1,function(ar){assert_hashtable(ar[0]);return ar[0].keys().length});BiwaScheme.find_hash_pair=function(hash,key,callbacks){return new Call(hash.hash_proc,[key],function(ar){var hashed=ar[0];var candidate_pairs=hash.candidate_pairs(hashed);if(!candidate_pairs)return callbacks.on_not_found(hashed);return Call.foreach(candidate_pairs,{call:function(pair){return new Call(hash.equiv_proc,[key,pair[0]])},result:function(equal,pair){if(equal)return callbacks.on_found(pair,hashed)},finish:function(){return callbacks.on_not_found(hashed)}})})};
define_libfunc("hashtable-ref",3,3,function(ar){var hash=ar[0],key=ar[1],ifnone=ar[2];assert_hashtable(hash);return BiwaScheme.find_hash_pair(hash,key,{on_found:function(pair){return pair[1]},on_not_found:function(hashed){return ifnone}})});define_libfunc("hashtable-set!",3,3,function(ar){var hash=ar[0],key=ar[1],value=ar[2];assert_hashtable(hash);return BiwaScheme.find_hash_pair(hash,key,{on_found:function(pair){pair[1]=value;return BiwaScheme.undef},on_not_found:function(hashed){hash.add_pair(hashed,
key,value);return BiwaScheme.undef}})});define_libfunc("hashtable-delete!",2,2,function(ar){var hash=ar[0],key=ar[1];assert_hashtable(hash);return BiwaScheme.find_hash_pair(hash,key,{on_found:function(pair,hashed){hash.remove_pair(hashed,pair);return BiwaScheme.undef},on_not_found:function(hashed){return BiwaScheme.undef}})});define_libfunc("hashtable-contains?",2,2,function(ar){var hash=ar[0],key=ar[1];assert_hashtable(hash);return BiwaScheme.find_hash_pair(hash,key,{on_found:function(pair){return true},
on_not_found:function(hashed){return false}})});define_libfunc("hashtable-update!",4,4,function(ar){var hash=ar[0],key=ar[1],proc=ar[2],ifnone=ar[3];assert_hashtable(hash);assert_procedure(proc);return BiwaScheme.find_hash_pair(hash,key,{on_found:function(pair,hashed){return new Call(proc,[pair[1]],function(ar){pair[1]=ar[0];return BiwaScheme.undef})},on_not_found:function(hashed){return new Call(proc,[ifnone],function(ar){hash.add_pair(hashed,key,ar[0]);return BiwaScheme.undef})}})});define_libfunc("hashtable-copy",
1,2,function(ar){var mutable=ar[1]===undefined?false:!!ar[1];assert_hashtable(ar[0]);return ar[0].create_copy(mutable)});define_libfunc("hashtable-clear!",0,1,function(ar){assert_hashtable(ar[0]);ar[0].clear();return BiwaScheme.undef});define_libfunc("hashtable-keys",1,1,function(ar){assert_hashtable(ar[0]);return ar[0].keys()});define_libfunc("hashtable-entries",1,1,function(ar){assert_hashtable(ar[0]);return new Values([ar[0].keys(),ar[0].values()])});define_libfunc("hashtable-equivalence-function",
1,1,function(ar){assert_hashtable(ar[0]);return ar[0].equiv_proc});define_libfunc("hashtable-hash-function",1,1,function(ar){assert_hashtable(ar[0]);return ar[0].hash_proc});define_libfunc("hashtable-mutable?",1,1,function(ar){assert_hashtable(ar[0]);return ar[0].mutable});define_libfunc("equal-hash",0,0,function(ar){return Hashtable.equal_hash});define_libfunc("string-hash",0,0,function(ar){return Hashtable.string_hash});define_libfunc("string-ci-hash",0,0,function(ar){return Hashtable.string_ci_hash});
define_libfunc("symbol-hash",0,0,function(ar){return Hashtable.symbol_hash});define_libfunc("eval",1,1,function(ar,intp){var expr=ar[0];var intp=new BiwaScheme.Interpreter(intp.on_error);return intp.evaluate(expr.to_write())})};if(typeof BiwaScheme!="object")BiwaScheme={};
with(BiwaScheme){define_libfunc_raw("js-eval",1,1,function(ar){return eval(ar[0])});define_libfunc_raw("js-ref",2,2,function(ar){assert_string(ar[1]);return ar[0][ar[1]]});define_libfunc("js-set!",3,3,function(ar){assert_string(ar[1]);ar[0][ar[1]]=ar[2];return BiwaScheme.undef});define_libfunc_raw("js-call",1,null,function(ar){var js_func=ar.shift();assert_function(js_func);var receiver=null;return js_func.apply(receiver,ar)});define_libfunc_raw("js-invoke",2,null,function(ar){var js_obj=ar.shift();
var func_name=ar.shift();assert_string(func_name);if(js_obj[func_name])return js_obj[func_name].apply(js_obj,ar);else throw new Error("js-invoke: function "+func_name+" is not defined");});define_libfunc("js-new",1,null,function(ar,intp){var array_to_obj=function(ary){if(ary.length%2!=0)throw new Error("js-new: odd number of key-value pair");var obj={};for(var i=0;i<ary.length;i+=2){var key=ary[i],value=ary[i+1];assert_symbol(key);if(value.closure_p===true)value=BiwaScheme.js_closure(value,intp);
obj[key.name]=value}return obj};var ctor=ar.shift();assert_string(ctor);if(ar.length==0)return eval("new "+ctor+"()");else{var args=[];for(var i=0;i<ar.length;i++)if(ar[i]instanceof Symbol){args.push(array_to_obj(ar.slice(i)));break}else args.push(ar[i]);var args_str=_.map(ar,function(value,i){return"args['"+i+"']"}).join(",");return eval("new "+ctor+"("+args_str+")")}});define_libfunc("js-obj",0,null,function(ar){if(ar.length%2!=0)throw new Error("js-obj: number of arguments must be even");var obj=
{};for(i=0;i<ar.length/2;i++){assert_string(ar[i*2]);obj[ar[i*2]]=ar[i*2+1]}return obj});BiwaScheme.js_closure=function(proc,intp){var on_error=intp.on_error;return function(){var intp=new Interpreter(on_error);return intp.invoke_closure(proc,_.toArray(arguments))}};define_libfunc("js-closure",1,1,function(ar,intp){assert_closure(ar[0]);return BiwaScheme.js_closure(ar[0],intp)});define_libfunc("js-null?",1,1,function(ar){return ar[0]===null});define_libfunc("js-undefined?",1,1,function(ar){return ar[0]===
undefined});define_libfunc_raw("js-array-to-list",1,1,function(ar){return BiwaScheme.array_to_list(ar[0])});define_libfunc_raw("list-to-js-array",1,1,function(ar){return ar[0].to_array()});define_libfunc("timer",2,2,function(ar,intp){var proc=ar[0],sec=ar[1];assert_closure(proc);assert_real(sec);setTimeout(function(){(new Interpreter(intp.on_error)).invoke_closure(proc)},sec*1E3);return BiwaScheme.undef});define_libfunc("set-timer!",2,2,function(ar,intp){var proc=ar[0],sec=ar[1];assert_closure(proc);
assert_real(sec);return setInterval(function(){(new Interpreter(intp.on_error)).invoke_closure(proc)},sec*1E3)});define_libfunc("clear-timer!",1,1,function(ar){var timer_id=ar[0];clearInterval(timer_id);return BiwaScheme.undef});define_libfunc("sleep",1,1,function(ar){var sec=ar[0];assert_real(sec);return new BiwaScheme.Pause(function(pause){setTimeout(function(){pause.resume(nil)},sec*1E3)})})};if(typeof BiwaScheme!="object")BiwaScheme={};
with(BiwaScheme){define_libfunc("read-line",0,1,function(ar){var port=ar[0]||Port.current_input;assert_port(port);return port.get_string()});define_libfunc("element-empty!",1,1,function(ar){if($(ar[0]).attr("value"))return $(ar[0]).val("");else return $(ar[0]).empty()});alias_libfunc("element-empty!","element-clear!");define_libfunc("element-visible?",1,1,function(ar){return $(ar[0]).is(":visible")});define_libfunc("element-toggle!",1,1,function(ar){return $(ar[0]).toggle()});define_libfunc("element-hide!",
1,1,function(ar){return $(ar[0]).hide()});define_libfunc("element-show!",1,1,function(ar){return $(ar[0]).show()});define_libfunc("element-remove!",1,1,function(ar){return $(ar[0]).remove()});define_libfunc("element-update!",2,2,function(ar){return $(ar[0]).html(ar[1])});define_libfunc("element-replace!",2,2,function(ar){return $(ar[0]).replaceWith(ar[1])});define_libfunc("element-insert!",2,2,function(ar){return $(ar[0]).append(ar[1])});define_libfunc("element-wrap!",3,3,function(ar){throw new Bug("not yet implemented");
});define_libfunc("element-ancestors",1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-descendants",1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-first-descendant",1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-immediate-descendants",1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-previous-sibling",1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-next-sibling",
1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-siblings",1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-match?",2,2,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-up",3,3,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-down",3,3,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-previous",3,3,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-next",
3,3,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-select",0,0,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-adjacent",0,0,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-identify",1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-read-attribute",2,2,function(ar){assert_string(ar[1]);return $(ar[0]).attr(ar[1])});define_libfunc("element-write-attribute",3,3,function(ar){assert_string(ar[1]);
return $(ar[0]).attr(ar[1],ar[2])});define_libfunc("element-height",1,1,function(ar){return $(ar[0]).height()});define_libfunc("element-width",1,1,function(ar){return $(ar[0]).width()});define_libfunc("element-class-names",1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-has-class-name?",2,2,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-add-class-name",2,2,function(ar){assert_string(ar[1]);return $(ar[0]).addClass(ar[1],ar[2])});define_libfunc("element-remove-class-name",
2,2,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-toggle-class-name",2,2,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-clean-whitespace!",1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-empty?",1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-descendant-of!",2,2,function(ar){throw new Bug("not yet implemented");});define_libfunc("scroll-to-element!",1,1,function(ar){throw new Bug("not yet implemented");
});define_libfunc("element-style",2,2,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-opacity",2,2,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-style-set!",2,2,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-opacity-set!",2,2,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-dimensions",1,1,function(ar){return new Values($(ar[0]).width(),$(ar[0]).height())});define_libfunc("element-make-positioned!",
1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-undo-positioned!",1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-make-clipping!",1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-undo-clipping!",1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-cumulative-offset",1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-positioned-offset",1,1,function(ar){throw new Bug("not yet implemented");
});define_libfunc("element-absolutize!",1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-relativize!",1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-cumulative-scroll-offset",1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-offset-parent",1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-viewport-offset",1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-clone-position!",
1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-absolutize!",1,1,function(ar){throw new Bug("not yet implemented");});define_libfunc("element-focus!",1,1,function(ar){return $(ar[0]).focus()});BiwaScheme.create_elements_by_string=function(spec){spec=spec.to_array();var name=spec.shift();if(name instanceof Symbol)name=name.name;var m=name.match(/(.*)\.(.*)/);if(m){name=m[1];spec.unshift(Sym("class"),m[2])}m=name.match(/(.*)\#(.*)/);if(m){name=m[1];spec.unshift(Sym("id"),
m[2])}var children=[];var s=["<"+name];for(var i=0;i<spec.length;i++)if(spec[i]instanceof Symbol){s.push(" "+spec[i].name+'="'+spec[i+1]+'"');i++}else if(spec[i]instanceof Pair)children.push(create_elements_by_string(spec[i]));else children.push(spec[i]);s.push(">");s.push(children.join(""));s.push("</"+name+">");return s.join("")};BiwaScheme.tree_all=function(tree,pred){if(tree===nil)return true;else if(pred(tree.car)===false)return false;else return BiwaScheme.tree_all(tree.cdr,pred)};define_libfunc("element-new",
1,1,function(ar){var string_or_symbol=function(item){return _.isString(item)||item instanceof Symbol||item instanceof Pair};if(BiwaScheme.tree_all(ar[0],string_or_symbol))return $(create_elements_by_string(ar[0]))[0];else return nil});BiwaScheme.element_content=function(selector){if($(selector).attr("value"))return $(selector).val();else return _.escapeHTML($(selector).html())};define_libfunc("element-content",1,1,function(ar){return BiwaScheme.element_content(ar[0])});define_libfunc("load",1,1,function(ar,
intp){var path=ar[0];assert_string(path);return new BiwaScheme.Pause(function(pause){$.ajax(path,{success:function(data){var local_intp=new Interpreter(intp.on_error);local_intp.evaluate(data,function(){return pause.resume(BiwaScheme.undef)})},error:function(){throw new Error("load: network error: failed to load"+path);}})})});_require=function(src,check,proc){var script=$("<script/>",{src:src});$("body").append(script);var checker=new Function("return !!("+check+")");if(checker())proc();else setTimeout(function(){checker()?
proc():setTimeout(arguments.callee,10)},10)};define_libfunc("js-load",2,2,function(ar){var path=ar[0];var check=ar[1];assert_string(path);assert_string(check);return new BiwaScheme.Pause(function(pause){_require(path,"window."+check,function(){pause.resume(BiwaScheme.undef)})})});BiwaScheme.getelem=function(ar){var x=$(ar[0]);if(x.length>0)return x;else return false};define_libfunc("$",1,1,BiwaScheme.getelem);define_libfunc("getelem",1,1,BiwaScheme.getelem);define_libfunc("dom-element",1,1,function(ar){return $(ar[0])[0]});
define_libfunc("set-style!",3,3,function(ar){assert_string(ar[1]);$(ar[0]).css(ar[1],ar[2]);return BiwaScheme.undef});define_libfunc("get-style",2,2,function(ar){assert_string(ar[1]);return $(ar[0]).css(ar[1])});define_libfunc("set-content!",2,2,function(ar){assert_string(ar[1]);var str=ar[1].replace(/\n/g,"<br>").replace(/\t/g,"&nbsp;&nbsp;&nbsp;");$(ar[0]).html(str);return BiwaScheme.undef});define_libfunc("get-content",1,1,function(ar){return BiwaScheme.element_content(ar[0])});define_libfunc("set-handler!",
3,3,function(ar,intp){throw new Error("set-handler! is obsolete, please use add-handler! instead");});define_libfunc("add-handler!",3,3,function(ar,intp){var selector=ar[0],evtype=ar[1],proc=ar[2];var on_error=intp.on_error;$(selector).bind(evtype,function(event){var intp=new Interpreter(on_error);return intp.invoke_closure(proc,[event])});return BiwaScheme.undef});define_libfunc("wait-for",2,2,function(ar){var selector=ar[0],evtype=ar[1];var elem=$(selector);elem.biwascheme_wait_for=elem.biwascheme_wait_for||
{};var prev_handler=elem.biwascheme_wait_for[evtype];if(prev_handler)elem.unbind(evtype,prev_handler);return new BiwaScheme.Pause(function(pause){var handler=function(event){elem.biwascheme_wait_for[evtype]=undefined;elem.unbind(evtype,handler);return pause.resume(BiwaScheme.undef)};elem.biwascheme_wait_for[evtype]=handler;elem.bind(evtype,handler)})});define_libfunc("domelem",1,null,function(ar){throw new Error("obsolete");});define_libfunc("dom-remove-children!",1,1,function(ar){puts("warning: dom-remove-children! is obsolete. use element-empty! instead");
$(ar[0]).empty();return BiwaScheme.undef});define_libfunc("dom-create-element",1,1,function(ar){throw new Error("obsolete");});define_libfunc("element-append-child!",2,2,function(ar){return $(ar[0]).append(ar[1])});define_libfunc("dom-remove-child!",2,2,function(ar){throw new Error("obsolete");});define_libfunc("http-request",1,1,function(ar){var path=ar[0];assert_string(path);return new BiwaScheme.Pause(function(pause){$.get(path,function(transport){pause.resume(transport.responseText)})})});define_libfunc("http-post",
2,2,function(ar){var path=ar[0];assert_string(path);var alist=ar[1];assert_list(alist);var h={};alist.foreach(function(item){assert_string(item.car);h[item.car]=item.cdr});return new BiwaScheme.Pause(function(pause){$.post(path,h,function(transport){pause.resume(transport.responseText)})})});BiwaScheme.jsonp_receiver=[];define_libfunc("receive-jsonp",1,1,function(ar){var url=ar[0];assert_string(url);var receives=BiwaScheme.jsonp_receiver;for(var i=0;i<receives.length;i++)if(receives[i]===null)break;
var receiver_id=i;url+="?callback=BiwaScheme.jsonp_receiver["+receiver_id+"]";return new BiwaScheme.Pause(function(pause){receives[receiver_id]=function(data){pause.resume(data);receives[receiver_id]=null};var script=$("<script/>",{src:src});$("body").append(script)})});define_libfunc("alert",1,1,function(ar){alert(ar[0]);return BiwaScheme.undef});define_libfunc("confirm",1,1,function(ar){return confirm(ar[0])})};if(typeof BiwaScheme!="object")BiwaScheme={};
with(BiwaScheme){define_libfunc("html-escape",1,1,function(ar){assert_string(ar[0]);return _.escapeHTML(ar[0])});BiwaScheme.inspect_objs=function(objs){return _.map(objs,BiwaScheme.inspect).join(", ")};define_libfunc("inspect",1,null,function(ar){return BiwaScheme.inspect_objs(ar)});define_libfunc("inspect!",1,null,function(ar){puts(BiwaScheme.inspect_objs(ar));return BiwaScheme.undef});BiwaScheme.json2sexp=function(json){switch(true){case _.isNumber(json)||_.isString(json)||json===true||json===false:return json;
case _.isArray(json):return array_to_list(_.map(json,json2sexp));case typeof json=="object":var ls=nil;for(key in json)ls=new Pair(new Pair(key,json2sexp(json[key])),ls);return ls;default:throw new Error("json->sexp: detected invalid value for json: "+BiwaScheme.inspect(json));}throw new Bug("must not happen");};define_libfunc("json->sexp",1,1,function(ar){return json2sexp(ar[0])});define_libfunc("identity",1,1,function(ar){return ar[0]});define_libfunc("string-concat",1,1,function(ar){assert_list(ar[0]);
return ar[0].to_array().join("")});define_libfunc("string-split",2,2,function(ar){assert_string(ar[0]);assert_string(ar[1]);return array_to_list(ar[0].split(ar[1]))});define_libfunc("string-join",1,2,function(ar){assert_list(ar[0]);var delim="";if(ar[1]){assert_string(ar[1]);delim=ar[1]}return ar[0].to_array().join(delim)});define_libfunc("intersperse",2,2,function(ar){var item=ar[0],ls=ar[1];assert_list(ls);var ret=[];_.each(ls.to_array().reverse(),function(x){ret.push(x);ret.push(item)});ret.pop();
return array_to_list(ret)});define_libfunc("map-with-index",2,null,function(ar){var proc=ar.shift(),lists=ar;_.each(lists,assert_list);var results=[],i=0;return Call.multi_foreach(lists,{call:function(xs){var args=_.map(xs,function(x){return x.car});args.unshift(i);i++;return new Call(proc,args)},result:function(res){results.push(res)},finish:function(){return array_to_list(results)}})});var sort_with_comp=function(ary,proc){return ary.sort(function(a,b){var intp2=new BiwaScheme.Interpreter;return intp2.invoke_closure(proc,
[a,b])})};define_libfunc("list-sort/comp",1,2,function(ar){assert_procedure(ar[0]);assert_list(ar[1]);return array_to_list(sort_with_comp(ar[1].to_array(),ar[0]))});define_libfunc("vector-sort/comp",1,2,function(ar){assert_procedure(ar[0]);assert_vector(ar[1]);return sort_with_comp(_.clone(ar[1]),ar[0])});define_libfunc("vector-sort/comp!",1,2,function(ar){assert_procedure(ar[0]);assert_vector(ar[1]);sort_with_comp(ar[1],ar[0]);return BiwaScheme.undef});var rearrange_args=function(expected,given){var args=
[];var dotpos=(new Compiler).find_dot_pos(expected);if(dotpos==-1)args=given;else{for(var i=0;i<dotpos;i++)args[i]=given[i];args[i]=array_to_list(given.slice(i))}return args};define_syntax("define-macro",function(x){var head=x.cdr.car;var expected_args;if(head instanceof Pair){var name=head.car;expected_args=head.cdr;var body=x.cdr.cdr;var lambda=new Pair(Sym("lambda"),new Pair(expected_args,body))}else{var name=head;var lambda=x.cdr.cdr.car;expected_args=lambda.cdr.car}var opc=Compiler.compile(lambda);
if(opc[1]!=0)throw new Bug("you cannot use free variables in macro expander (or define-macro must be on toplevel)");var cls=[opc[2]];TopEnv[name.name]=new Syntax(name.name,function(sexp){var given_args=sexp.to_array();given_args.shift();var intp=new Interpreter;var args=rearrange_args(expected_args,given_args);var result=intp.invoke_closure(cls,args);return result});return BiwaScheme.undef});var macroexpand_1=function(x){if(x instanceof Pair)if(x.car instanceof Symbol&&TopEnv[x.car.name]instanceof
Syntax){var transformer=TopEnv[x.car.name];x=transformer.transform(x)}else throw new Error("macroexpand-1: `"+to_write_ss(x)+"' is not a macro");return x};define_syntax("%macroexpand",function(x){var expanded=(new Interpreter).expand(x.cdr.car);return List(Sym("quote"),expanded)});define_syntax("%macroexpand-1",function(x){var expanded=macroexpand_1(x.cdr.car);return List(Sym("quote"),expanded)});define_libfunc("macroexpand",1,1,function(ar){return(new Interpreter).expand(ar[0])});define_libfunc("macroexpand-1",
1,1,function(ar){return macroexpand_1(ar[0])});define_libfunc("gensym",0,0,function(ar){return BiwaScheme.gensym()});define_libfunc("print",1,null,function(ar){_.map(ar,function(item){puts(to_display(item),true)});puts("");return BiwaScheme.undef});define_libfunc("write-to-string",1,1,function(ar){return to_write(ar[0])});define_libfunc("read-from-string",1,1,function(ar){assert_string(ar[0]);return Interpreter.read(ar[0])});define_libfunc("port-closed?",1,1,function(ar){assert_port(ar[0]);return!ar[0].is_open});
define_syntax("let1",function(x){var vari=x.cdr.car;var expr=x.cdr.cdr.car;var body=x.cdr.cdr.cdr;return new Pair(new Pair(Sym("lambda"),new Pair(new Pair(vari,nil),body)),new Pair(expr,nil))});var assert_regexp=function(obj,fname){if(!(obj instanceof RegExp))throw new Error(fname+": regexp required, but got "+to_write(obj));};define_libfunc("string->regexp",1,1,function(ar){assert_string(ar[0],"string->regexp");return new RegExp(ar[0])});define_libfunc("regexp?",1,1,function(ar){return ar[0]instanceof
RegExp});define_libfunc("regexp->string",1,1,function(ar){assert_regexp(ar[0],"regexp->string");return ar[0].toString().slice(1,-1)});define_libfunc("regexp-exec",2,2,function(ar){var rexp=ar[0];if(_.isString(ar[0]))rexp=new RegExp(ar[0]);assert_regexp(rexp,"regexp-exec");assert_string(ar[1],"regexp-exec");var ret=rexp.exec(ar[1]);return ret===null?false:array_to_list(ret)})};with(BiwaScheme){define_libfunc("iota",1,3,function(ar){var count=ar[0];var start=ar[1]||0;var step=ar[2]===undefined?1:ar[2];assert_integer(count);assert_number(start);assert_number(step);var a=[],n=start;for(var i=0;i<count;i++){a.push(n);n+=step}return array_to_list(a)});define_libfunc("open-input-string",1,1,function(ar){assert_string(ar[0]);return new Port.StringInput(ar[0])});define_libfunc("open-output-string",0,0,function(ar){return new Port.StringOutput});define_libfunc("get-output-string",
1,1,function(ar){assert_port(ar[0]);if(!(ar[0]instanceof Port.StringOutput))throw new Error("get-output-string: port must be made by 'open-output-string'");return ar[0].output_string()});define_libfunc("current-date",0,1,function(ar){return new Date});define_libfunc("date?",1,1,function(ar){return ar[0]instanceof Date});define_libfunc("date-nanosecond",1,1,function(ar){assert_date(ar[0]);return ar[0].getMilliseconds()*1E6});define_libfunc("date-millisecond",1,1,function(ar){assert_date(ar[0]);return ar[0].getMilliseconds()});
define_libfunc("date-second",1,1,function(ar){assert_date(ar[0]);return ar[0].getSeconds()});define_libfunc("date-minute",1,1,function(ar){assert_date(ar[0]);return ar[0].getMinutes()});define_libfunc("date-hour",1,1,function(ar){assert_date(ar[0]);return ar[0].getHours()});define_libfunc("date-day",1,1,function(ar){assert_date(ar[0]);return ar[0].getDate()});define_libfunc("date-month",1,1,function(ar){assert_date(ar[0]);return ar[0].getMonth()+1});define_libfunc("date-year",1,1,function(ar){assert_date(ar[0]);
return ar[0].getFullYear()});define_libfunc("date-week-day",1,1,function(ar){assert_date(ar[0]);return ar[0].getDay()});BiwaScheme.date_names={weekday:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],full_weekday:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],month:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],full_month:["January","February","March","April","May","June","July","August","September","Octorber","November","December"]};BiwaScheme.date2string=
function(date,format){var zeropad=function(n){return n<10?"0"+n:""+n};var spacepad=function(n){return n<10?" "+n:""+n};var getter={a:function(x){return date_names.weekday[x.getDay()]},A:function(x){return date_names.full_weekday[x.getDay()]},b:function(x){return date_names.month[x.getMonth()]},B:function(x){return date_names.full_month[x.getMonth()]},c:function(x){return x.toString()},d:function(x){return zeropad(x.getDate())},D:function(x){return getter.d(x)+getter.m(x)+getter.y(x)},e:function(x){return spacepad(x.getDate())},
f:function(x){return x.getSeconds()+x.getMilliseconds()/1E3},h:function(x){return date_names.month[x.getMonth()]},H:function(x){return zeropad(x.getHours())},I:function(x){var h=x.getHours();return zeropad(h<13?h:h-12)},j:function(x){throw new Bug("not implemented: day of year");},k:function(x){return spacepad(x.getHours())},l:function(x){var h=x.getHours();return spacepad(h<13?h:h-12)},m:function(x){return zeropad(x.getMonth())},M:function(x){return zeropad(x.getMinutes())},n:function(x){return"\n"},
N:function(x){throw new Bug("not implemented: nanoseconds");},p:function(x){return x.getHours()<13?"AM":"PM"},r:function(x){return getter.I(x)+":"+getter.M(x)+":"+getter.S(x)+" "+getter.p(x)},s:function(x){return Math.floor(x.getTime()/1E3)},S:function(x){return zeropad(x.getSeconds())},t:function(x){return"\t"},T:function(x){return getter.H(x)+":"+getter.M(x)+":"+getter.S(x)},U:function(x){throw new Bug("not implemented: weeknum(0~, Sun)");},V:function(x){throw new Bug("not implemented: weeknum(1~, Sun?)");
},w:function(x){return x.getDay()},W:function(x){throw new Bug("not implemented: weeknum(0~, Mon)");},x:function(x){throw new Bug("not implemented: weeknum(1~, Mon)");},X:function(x){return getter.Y(x)+"/"+getter.m(x)+"/"+getter.d(x)},y:function(x){return x.getFullYear()%100},Y:function(x){return x.getFullYear()},z:function(x){throw new Bug("not implemented: time-zone");},Z:function(x){throw new Bug("not implemented: symbol time zone");},1:function(x){throw new Bug("not implemented: ISO-8601 year-month-day format");
},2:function(x){throw new Bug("not implemented: ISO-8601 hour-minute-second-timezone format");},3:function(x){throw new Bug("not implemented: ISO-8601 hour-minute-second format");},4:function(x){throw new Bug("not implemented: ISO-8601 year-month-day-hour-minute-second-timezone format");},5:function(x){throw new Bug("not implemented: ISO-8601 year-month-day-hour-minute-second format");}};return format.replace(/~([\w1-5~])/g,function(str,x){var func=getter[x];if(func)return func(date);else if(x=="~")return"~";
else return x})};define_libfunc("date->string",1,2,function(ar){assert_date(ar[0]);if(ar[1]){assert_string(ar[1]);return date2string(ar[0],ar[1])}else return ar[0].toString()});define_libfunc("parse-date",1,1,function(ar){assert_string(ar[0]);return new Date(Date.parse(ar[0]))});define_libfunc("random-integer",1,1,function(ar){var n=ar[0];assert_integer(n);if(n<0)throw new Error("random-integer: the argument must be >= 0");else return Math.floor(Math.random()*ar[0])});define_libfunc("random-real",
0,0,function(ar){return Math.random()});var user_write_ss=function(ar){puts(write_ss(ar[0]),true);return BiwaScheme.undef};define_libfunc("write/ss",1,2,user_write_ss);define_libfunc("write-with-shared-structure",1,2,user_write_ss);define_libfunc("write*",1,2,user_write_ss);define_libfunc("vector-append",2,null,function(ar){var vec=[];return vec.concat.apply(vec,ar)})};(function(window,undefined){var document=window.document,navigator=window.navigator,location=window.location;var jQuery=function(){var jQuery=function(selector,context){return new jQuery.fn.init(selector,context,rootjQuery)},_jQuery=window.jQuery,_$=window.$,rootjQuery,quickExpr=/^(?:[^<]*(<[\w\W]+>)[^>]*$|#([\w\-]*)$)/,rnotwhite=/\S/,trimLeft=/^\s+/,trimRight=/\s+$/,rdigit=/\d/,rsingleTag=/^<(\w+)\s*\/?>(?:<\/\1>)?$/,rvalidchars=/^[\],:{}\s]*$/,rvalidescape=/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,
rvalidtokens=/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,rvalidbraces=/(?:^|:|,)(?:\s*\[)+/g,rwebkit=/(webkit)[ \/]([\w.]+)/,ropera=/(opera)(?:.*version)?[ \/]([\w.]+)/,rmsie=/(msie) ([\w.]+)/,rmozilla=/(mozilla)(?:.*? rv:([\w.]+))?/,rdashAlpha=/-([a-z])/ig,fcamelCase=function(all,letter){return letter.toUpperCase()},userAgent=navigator.userAgent,browserMatch,readyList,DOMContentLoaded,toString=Object.prototype.toString,hasOwn=Object.prototype.hasOwnProperty,push=Array.prototype.push,
slice=Array.prototype.slice,trim=String.prototype.trim,indexOf=Array.prototype.indexOf,class2type={};jQuery.fn=jQuery.prototype={constructor:jQuery,init:function(selector,context,rootjQuery){var match,elem,ret,doc;if(!selector)return this;if(selector.nodeType){this.context=this[0]=selector;this.length=1;return this}if(selector==="body"&&!context&&document.body){this.context=document;this[0]=document.body;this.selector=selector;this.length=1;return this}if(typeof selector==="string"){if(selector.charAt(0)===
"<"&&selector.charAt(selector.length-1)===">"&&selector.length>=3)match=[null,selector,null];else match=quickExpr.exec(selector);if(match&&(match[1]||!context))if(match[1]){context=context instanceof jQuery?context[0]:context;doc=context?context.ownerDocument||context:document;ret=rsingleTag.exec(selector);if(ret)if(jQuery.isPlainObject(context)){selector=[document.createElement(ret[1])];jQuery.fn.attr.call(selector,context,true)}else selector=[doc.createElement(ret[1])];else{ret=jQuery.buildFragment([match[1]],
[doc]);selector=(ret.cacheable?jQuery.clone(ret.fragment):ret.fragment).childNodes}return jQuery.merge(this,selector)}else{elem=document.getElementById(match[2]);if(elem&&elem.parentNode){if(elem.id!==match[2])return rootjQuery.find(selector);this.length=1;this[0]=elem}this.context=document;this.selector=selector;return this}else if(!context||context.jquery)return(context||rootjQuery).find(selector);else return this.constructor(context).find(selector)}else if(jQuery.isFunction(selector))return rootjQuery.ready(selector);
if(selector.selector!==undefined){this.selector=selector.selector;this.context=selector.context}return jQuery.makeArray(selector,this)},selector:"",jquery:"1.6.2",length:0,size:function(){return this.length},toArray:function(){return slice.call(this,0)},get:function(num){return num==null?this.toArray():num<0?this[this.length+num]:this[num]},pushStack:function(elems,name,selector){var ret=this.constructor();if(jQuery.isArray(elems))push.apply(ret,elems);else jQuery.merge(ret,elems);ret.prevObject=
this;ret.context=this.context;if(name==="find")ret.selector=this.selector+(this.selector?" ":"")+selector;else if(name)ret.selector=this.selector+"."+name+"("+selector+")";return ret},each:function(callback,args){return jQuery.each(this,callback,args)},ready:function(fn){jQuery.bindReady();readyList.done(fn);return this},eq:function(i){return i===-1?this.slice(i):this.slice(i,+i+1)},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},slice:function(){return this.pushStack(slice.apply(this,
arguments),"slice",slice.call(arguments).join(","))},map:function(callback){return this.pushStack(jQuery.map(this,function(elem,i){return callback.call(elem,i,elem)}))},end:function(){return this.prevObject||this.constructor(null)},push:push,sort:[].sort,splice:[].splice};jQuery.fn.init.prototype=jQuery.fn;jQuery.extend=jQuery.fn.extend=function(){var options,name,src,copy,copyIsArray,clone,target=arguments[0]||{},i=1,length=arguments.length,deep=false;if(typeof target==="boolean"){deep=target;target=
arguments[1]||{};i=2}if(typeof target!=="object"&&!jQuery.isFunction(target))target={};if(length===i){target=this;--i}for(;i<length;i++)if((options=arguments[i])!=null)for(name in options){src=target[name];copy=options[name];if(target===copy)continue;if(deep&&copy&&(jQuery.isPlainObject(copy)||(copyIsArray=jQuery.isArray(copy)))){if(copyIsArray){copyIsArray=false;clone=src&&jQuery.isArray(src)?src:[]}else clone=src&&jQuery.isPlainObject(src)?src:{};target[name]=jQuery.extend(deep,clone,copy)}else if(copy!==
undefined)target[name]=copy}return target};jQuery.extend({noConflict:function(deep){if(window.$===jQuery)window.$=_$;if(deep&&window.jQuery===jQuery)window.jQuery=_jQuery;return jQuery},isReady:false,readyWait:1,holdReady:function(hold){if(hold)jQuery.readyWait++;else jQuery.ready(true)},ready:function(wait){if(wait===true&&!--jQuery.readyWait||wait!==true&&!jQuery.isReady){if(!document.body)return setTimeout(jQuery.ready,1);jQuery.isReady=true;if(wait!==true&&--jQuery.readyWait>0)return;readyList.resolveWith(document,
[jQuery]);if(jQuery.fn.trigger)jQuery(document).trigger("ready").unbind("ready")}},bindReady:function(){if(readyList)return;readyList=jQuery._Deferred();if(document.readyState==="complete")return setTimeout(jQuery.ready,1);if(document.addEventListener){document.addEventListener("DOMContentLoaded",DOMContentLoaded,false);window.addEventListener("load",jQuery.ready,false)}else if(document.attachEvent){document.attachEvent("onreadystatechange",DOMContentLoaded);window.attachEvent("onload",jQuery.ready);
var toplevel=false;try{toplevel=window.frameElement==null}catch(e){}if(document.documentElement.doScroll&&toplevel)doScrollCheck()}},isFunction:function(obj){return jQuery.type(obj)==="function"},isArray:Array.isArray||function(obj){return jQuery.type(obj)==="array"},isWindow:function(obj){return obj&&typeof obj==="object"&&"setInterval"in obj},isNaN:function(obj){return obj==null||!rdigit.test(obj)||isNaN(obj)},type:function(obj){return obj==null?String(obj):class2type[toString.call(obj)]||"object"},
isPlainObject:function(obj){if(!obj||jQuery.type(obj)!=="object"||obj.nodeType||jQuery.isWindow(obj))return false;if(obj.constructor&&!hasOwn.call(obj,"constructor")&&!hasOwn.call(obj.constructor.prototype,"isPrototypeOf"))return false;var key;for(key in obj);return key===undefined||hasOwn.call(obj,key)},isEmptyObject:function(obj){for(var name in obj)return false;return true},error:function(msg){throw msg;},parseJSON:function(data){if(typeof data!=="string"||!data)return null;data=jQuery.trim(data);
if(window.JSON&&window.JSON.parse)return window.JSON.parse(data);if(rvalidchars.test(data.replace(rvalidescape,"@").replace(rvalidtokens,"]").replace(rvalidbraces,"")))return(new Function("return "+data))();jQuery.error("Invalid JSON: "+data)},parseXML:function(data,xml,tmp){if(window.DOMParser){tmp=new DOMParser;xml=tmp.parseFromString(data,"text/xml")}else{xml=new ActiveXObject("Microsoft.XMLDOM");xml.async="false";xml.loadXML(data)}tmp=xml.documentElement;if(!tmp||!tmp.nodeName||tmp.nodeName===
"parsererror")jQuery.error("Invalid XML: "+data);return xml},noop:function(){},globalEval:function(data){if(data&&rnotwhite.test(data))(window.execScript||function(data){window["eval"].call(window,data)})(data)},camelCase:function(string){return string.replace(rdashAlpha,fcamelCase)},nodeName:function(elem,name){return elem.nodeName&&elem.nodeName.toUpperCase()===name.toUpperCase()},each:function(object,callback,args){var name,i=0,length=object.length,isObj=length===undefined||jQuery.isFunction(object);
if(args)if(isObj)for(name in object){if(callback.apply(object[name],args)===false)break}else for(;i<length;){if(callback.apply(object[i++],args)===false)break}else if(isObj)for(name in object){if(callback.call(object[name],name,object[name])===false)break}else for(;i<length;)if(callback.call(object[i],i,object[i++])===false)break;return object},trim:trim?function(text){return text==null?"":trim.call(text)}:function(text){return text==null?"":text.toString().replace(trimLeft,"").replace(trimRight,
"")},makeArray:function(array,results){var ret=results||[];if(array!=null){var type=jQuery.type(array);if(array.length==null||type==="string"||type==="function"||type==="regexp"||jQuery.isWindow(array))push.call(ret,array);else jQuery.merge(ret,array)}return ret},inArray:function(elem,array){if(indexOf)return indexOf.call(array,elem);for(var i=0,length=array.length;i<length;i++)if(array[i]===elem)return i;return-1},merge:function(first,second){var i=first.length,j=0;if(typeof second.length==="number")for(var l=
second.length;j<l;j++)first[i++]=second[j];else while(second[j]!==undefined)first[i++]=second[j++];first.length=i;return first},grep:function(elems,callback,inv){var ret=[],retVal;inv=!!inv;for(var i=0,length=elems.length;i<length;i++){retVal=!!callback(elems[i],i);if(inv!==retVal)ret.push(elems[i])}return ret},map:function(elems,callback,arg){var value,key,ret=[],i=0,length=elems.length,isArray=elems instanceof jQuery||length!==undefined&&typeof length==="number"&&(length>0&&elems[0]&&elems[length-
1]||length===0||jQuery.isArray(elems));if(isArray)for(;i<length;i++){value=callback(elems[i],i,arg);if(value!=null)ret[ret.length]=value}else for(key in elems){value=callback(elems[key],key,arg);if(value!=null)ret[ret.length]=value}return ret.concat.apply([],ret)},guid:1,proxy:function(fn,context){if(typeof context==="string"){var tmp=fn[context];context=fn;fn=tmp}if(!jQuery.isFunction(fn))return undefined;var args=slice.call(arguments,2),proxy=function(){return fn.apply(context,args.concat(slice.call(arguments)))};
proxy.guid=fn.guid=fn.guid||proxy.guid||jQuery.guid++;return proxy},access:function(elems,key,value,exec,fn,pass){var length=elems.length;if(typeof key==="object"){for(var k in key)jQuery.access(elems,k,key[k],exec,fn,value);return elems}if(value!==undefined){exec=!pass&&exec&&jQuery.isFunction(value);for(var i=0;i<length;i++)fn(elems[i],key,exec?value.call(elems[i],i,fn(elems[i],key)):value,pass);return elems}return length?fn(elems[0],key):undefined},now:function(){return(new Date).getTime()},uaMatch:function(ua){ua=
ua.toLowerCase();var match=rwebkit.exec(ua)||ropera.exec(ua)||rmsie.exec(ua)||ua.indexOf("compatible")<0&&rmozilla.exec(ua)||[];return{browser:match[1]||"",version:match[2]||"0"}},sub:function(){function jQuerySub(selector,context){return new jQuerySub.fn.init(selector,context)}jQuery.extend(true,jQuerySub,this);jQuerySub.superclass=this;jQuerySub.fn=jQuerySub.prototype=this();jQuerySub.fn.constructor=jQuerySub;jQuerySub.sub=this.sub;jQuerySub.fn.init=function init(selector,context){if(context&&context instanceof
jQuery&&!(context instanceof jQuerySub))context=jQuerySub(context);return jQuery.fn.init.call(this,selector,context,rootjQuerySub)};jQuerySub.fn.init.prototype=jQuerySub.fn;var rootjQuerySub=jQuerySub(document);return jQuerySub},browser:{}});jQuery.each("Boolean Number String Function Array Date RegExp Object".split(" "),function(i,name){class2type["[object "+name+"]"]=name.toLowerCase()});browserMatch=jQuery.uaMatch(userAgent);if(browserMatch.browser){jQuery.browser[browserMatch.browser]=true;jQuery.browser.version=
browserMatch.version}if(jQuery.browser.webkit)jQuery.browser.safari=true;if(rnotwhite.test("\u00a0")){trimLeft=/^[\s\xA0]+/;trimRight=/[\s\xA0]+$/}rootjQuery=jQuery(document);if(document.addEventListener)DOMContentLoaded=function(){document.removeEventListener("DOMContentLoaded",DOMContentLoaded,false);jQuery.ready()};else if(document.attachEvent)DOMContentLoaded=function(){if(document.readyState==="complete"){document.detachEvent("onreadystatechange",DOMContentLoaded);jQuery.ready()}};function doScrollCheck(){if(jQuery.isReady)return;
try{document.documentElement.doScroll("left")}catch(e){setTimeout(doScrollCheck,1);return}jQuery.ready()}return jQuery}();var promiseMethods="done fail isResolved isRejected promise then always pipe".split(" "),sliceDeferred=[].slice;jQuery.extend({_Deferred:function(){var callbacks=[],fired,firing,cancelled,deferred={done:function(){if(!cancelled){var args=arguments,i,length,elem,type,_fired;if(fired){_fired=fired;fired=0}for(i=0,length=args.length;i<length;i++){elem=args[i];type=jQuery.type(elem);
if(type==="array")deferred.done.apply(deferred,elem);else if(type==="function")callbacks.push(elem)}if(_fired)deferred.resolveWith(_fired[0],_fired[1])}return this},resolveWith:function(context,args){if(!cancelled&&!fired&&!firing){args=args||[];firing=1;try{while(callbacks[0])callbacks.shift().apply(context,args)}finally{fired=[context,args];firing=0}}return this},resolve:function(){deferred.resolveWith(this,arguments);return this},isResolved:function(){return!!(firing||fired)},cancel:function(){cancelled=
1;callbacks=[];return this}};return deferred},Deferred:function(func){var deferred=jQuery._Deferred(),failDeferred=jQuery._Deferred(),promise;jQuery.extend(deferred,{then:function(doneCallbacks,failCallbacks){deferred.done(doneCallbacks).fail(failCallbacks);return this},always:function(){return deferred.done.apply(deferred,arguments).fail.apply(this,arguments)},fail:failDeferred.done,rejectWith:failDeferred.resolveWith,reject:failDeferred.resolve,isRejected:failDeferred.isResolved,pipe:function(fnDone,
fnFail){return jQuery.Deferred(function(newDefer){jQuery.each({done:[fnDone,"resolve"],fail:[fnFail,"reject"]},function(handler,data){var fn=data[0],action=data[1],returned;if(jQuery.isFunction(fn))deferred[handler](function(){returned=fn.apply(this,arguments);if(returned&&jQuery.isFunction(returned.promise))returned.promise().then(newDefer.resolve,newDefer.reject);else newDefer[action](returned)});else deferred[handler](newDefer[action])})}).promise()},promise:function(obj){if(obj==null){if(promise)return promise;
promise=obj={}}var i=promiseMethods.length;while(i--)obj[promiseMethods[i]]=deferred[promiseMethods[i]];return obj}});deferred.done(failDeferred.cancel).fail(deferred.cancel);delete deferred.cancel;if(func)func.call(deferred,deferred);return deferred},when:function(firstParam){var args=arguments,i=0,length=args.length,count=length,deferred=length<=1&&firstParam&&jQuery.isFunction(firstParam.promise)?firstParam:jQuery.Deferred();function resolveFunc(i){return function(value){args[i]=arguments.length>
1?sliceDeferred.call(arguments,0):value;if(!--count)deferred.resolveWith(deferred,sliceDeferred.call(args,0))}}if(length>1){for(;i<length;i++)if(args[i]&&jQuery.isFunction(args[i].promise))args[i].promise().then(resolveFunc(i),deferred.reject);else--count;if(!count)deferred.resolveWith(deferred,args)}else if(deferred!==firstParam)deferred.resolveWith(deferred,length?[firstParam]:[]);return deferred.promise()}});jQuery.support=function(){var div=document.createElement("div"),documentElement=document.documentElement,
all,a,select,opt,input,marginDiv,support,fragment,body,testElementParent,testElement,testElementStyle,tds,events,eventName,i,isSupported;div.setAttribute("className","t");div.innerHTML="   <link/><table></table><a href='/a' style='top:1px;float:left;opacity:.55;'>a</a><input type='checkbox'/>";all=div.getElementsByTagName("*");a=div.getElementsByTagName("a")[0];if(!all||!all.length||!a)return{};select=document.createElement("select");opt=select.appendChild(document.createElement("option"));input=
div.getElementsByTagName("input")[0];support={leadingWhitespace:div.firstChild.nodeType===3,tbody:!div.getElementsByTagName("tbody").length,htmlSerialize:!!div.getElementsByTagName("link").length,style:/top/.test(a.getAttribute("style")),hrefNormalized:a.getAttribute("href")==="/a",opacity:/^0.55$/.test(a.style.opacity),cssFloat:!!a.style.cssFloat,checkOn:input.value==="on",optSelected:opt.selected,getSetAttribute:div.className!=="t",submitBubbles:true,changeBubbles:true,focusinBubbles:false,deleteExpando:true,
noCloneEvent:true,inlineBlockNeedsLayout:false,shrinkWrapBlocks:false,reliableMarginRight:true};input.checked=true;support.noCloneChecked=input.cloneNode(true).checked;select.disabled=true;support.optDisabled=!opt.disabled;try{delete div.test}catch(e){support.deleteExpando=false}if(!div.addEventListener&&div.attachEvent&&div.fireEvent){div.attachEvent("onclick",function(){support.noCloneEvent=false});div.cloneNode(true).fireEvent("onclick")}input=document.createElement("input");input.value="t";input.setAttribute("type",
"radio");support.radioValue=input.value==="t";input.setAttribute("checked","checked");div.appendChild(input);fragment=document.createDocumentFragment();fragment.appendChild(div.firstChild);support.checkClone=fragment.cloneNode(true).cloneNode(true).lastChild.checked;div.innerHTML="";div.style.width=div.style.paddingLeft="1px";body=document.getElementsByTagName("body")[0];testElement=document.createElement(body?"div":"body");testElementStyle={visibility:"hidden",width:0,height:0,border:0,margin:0};
if(body)jQuery.extend(testElementStyle,{position:"absolute",left:-1E3,top:-1E3});for(i in testElementStyle)testElement.style[i]=testElementStyle[i];testElement.appendChild(div);testElementParent=body||documentElement;testElementParent.insertBefore(testElement,testElementParent.firstChild);support.appendChecked=input.checked;support.boxModel=div.offsetWidth===2;if("zoom"in div.style){div.style.display="inline";div.style.zoom=1;support.inlineBlockNeedsLayout=div.offsetWidth===2;div.style.display="";
div.innerHTML="<div style='width:4px;'></div>";support.shrinkWrapBlocks=div.offsetWidth!==2}div.innerHTML="<table><tr><td style='padding:0;border:0;display:none'></td><td>t</td></tr></table>";tds=div.getElementsByTagName("td");isSupported=tds[0].offsetHeight===0;tds[0].style.display="";tds[1].style.display="none";support.reliableHiddenOffsets=isSupported&&tds[0].offsetHeight===0;div.innerHTML="";if(document.defaultView&&document.defaultView.getComputedStyle){marginDiv=document.createElement("div");
marginDiv.style.width="0";marginDiv.style.marginRight="0";div.appendChild(marginDiv);support.reliableMarginRight=(parseInt((document.defaultView.getComputedStyle(marginDiv,null)||{marginRight:0}).marginRight,10)||0)===0}testElement.innerHTML="";testElementParent.removeChild(testElement);if(div.attachEvent)for(i in{submit:1,change:1,focusin:1}){eventName="on"+i;isSupported=eventName in div;if(!isSupported){div.setAttribute(eventName,"return;");isSupported=typeof div[eventName]==="function"}support[i+
"Bubbles"]=isSupported}testElement=fragment=select=opt=body=marginDiv=div=input=null;return support}();jQuery.boxModel=jQuery.support.boxModel;var rbrace=/^(?:\{.*\}|\[.*\])$/,rmultiDash=/([a-z])([A-Z])/g;jQuery.extend({cache:{},uuid:0,expando:"jQuery"+(jQuery.fn.jquery+Math.random()).replace(/\D/g,""),noData:{"embed":true,"object":"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000","applet":true},hasData:function(elem){elem=elem.nodeType?jQuery.cache[elem[jQuery.expando]]:elem[jQuery.expando];return!!elem&&
!isEmptyDataObject(elem)},data:function(elem,name,data,pvt){if(!jQuery.acceptData(elem))return;var internalKey=jQuery.expando,getByName=typeof name==="string",thisCache,isNode=elem.nodeType,cache=isNode?jQuery.cache:elem,id=isNode?elem[jQuery.expando]:elem[jQuery.expando]&&jQuery.expando;if((!id||pvt&&id&&!cache[id][internalKey])&&getByName&&data===undefined)return;if(!id)if(isNode)elem[jQuery.expando]=id=++jQuery.uuid;else id=jQuery.expando;if(!cache[id]){cache[id]={};if(!isNode)cache[id].toJSON=
jQuery.noop}if(typeof name==="object"||typeof name==="function")if(pvt)cache[id][internalKey]=jQuery.extend(cache[id][internalKey],name);else cache[id]=jQuery.extend(cache[id],name);thisCache=cache[id];if(pvt){if(!thisCache[internalKey])thisCache[internalKey]={};thisCache=thisCache[internalKey]}if(data!==undefined)thisCache[jQuery.camelCase(name)]=data;if(name==="events"&&!thisCache[name])return thisCache[internalKey]&&thisCache[internalKey].events;return getByName?thisCache[jQuery.camelCase(name)]||
thisCache[name]:thisCache},removeData:function(elem,name,pvt){if(!jQuery.acceptData(elem))return;var internalKey=jQuery.expando,isNode=elem.nodeType,cache=isNode?jQuery.cache:elem,id=isNode?elem[jQuery.expando]:jQuery.expando;if(!cache[id])return;if(name){var thisCache=pvt?cache[id][internalKey]:cache[id];if(thisCache){delete thisCache[name];if(!isEmptyDataObject(thisCache))return}}if(pvt){delete cache[id][internalKey];if(!isEmptyDataObject(cache[id]))return}var internalCache=cache[id][internalKey];
if(jQuery.support.deleteExpando||cache!=window)delete cache[id];else cache[id]=null;if(internalCache){cache[id]={};if(!isNode)cache[id].toJSON=jQuery.noop;cache[id][internalKey]=internalCache}else if(isNode)if(jQuery.support.deleteExpando)delete elem[jQuery.expando];else if(elem.removeAttribute)elem.removeAttribute(jQuery.expando);else elem[jQuery.expando]=null},_data:function(elem,name,data){return jQuery.data(elem,name,data,true)},acceptData:function(elem){if(elem.nodeName){var match=jQuery.noData[elem.nodeName.toLowerCase()];
if(match)return!(match===true||elem.getAttribute("classid")!==match)}return true}});jQuery.fn.extend({data:function(key,value){var data=null;if(typeof key==="undefined"){if(this.length){data=jQuery.data(this[0]);if(this[0].nodeType===1){var attr=this[0].attributes,name;for(var i=0,l=attr.length;i<l;i++){name=attr[i].name;if(name.indexOf("data-")===0){name=jQuery.camelCase(name.substring(5));dataAttr(this[0],name,data[name])}}}}return data}else if(typeof key==="object")return this.each(function(){jQuery.data(this,
key)});var parts=key.split(".");parts[1]=parts[1]?"."+parts[1]:"";if(value===undefined){data=this.triggerHandler("getData"+parts[1]+"!",[parts[0]]);if(data===undefined&&this.length){data=jQuery.data(this[0],key);data=dataAttr(this[0],key,data)}return data===undefined&&parts[1]?this.data(parts[0]):data}else return this.each(function(){var $this=jQuery(this),args=[parts[0],value];$this.triggerHandler("setData"+parts[1]+"!",args);jQuery.data(this,key,value);$this.triggerHandler("changeData"+parts[1]+
"!",args)})},removeData:function(key){return this.each(function(){jQuery.removeData(this,key)})}});function dataAttr(elem,key,data){if(data===undefined&&elem.nodeType===1){var name="data-"+key.replace(rmultiDash,"$1-$2").toLowerCase();data=elem.getAttribute(name);if(typeof data==="string"){try{data=data==="true"?true:data==="false"?false:data==="null"?null:!jQuery.isNaN(data)?parseFloat(data):rbrace.test(data)?jQuery.parseJSON(data):data}catch(e){}jQuery.data(elem,key,data)}else data=undefined}return data}
function isEmptyDataObject(obj){for(var name in obj)if(name!=="toJSON")return false;return true}function handleQueueMarkDefer(elem,type,src){var deferDataKey=type+"defer",queueDataKey=type+"queue",markDataKey=type+"mark",defer=jQuery.data(elem,deferDataKey,undefined,true);if(defer&&(src==="queue"||!jQuery.data(elem,queueDataKey,undefined,true))&&(src==="mark"||!jQuery.data(elem,markDataKey,undefined,true)))setTimeout(function(){if(!jQuery.data(elem,queueDataKey,undefined,true)&&!jQuery.data(elem,
markDataKey,undefined,true)){jQuery.removeData(elem,deferDataKey,true);defer.resolve()}},0)}jQuery.extend({_mark:function(elem,type){if(elem){type=(type||"fx")+"mark";jQuery.data(elem,type,(jQuery.data(elem,type,undefined,true)||0)+1,true)}},_unmark:function(force,elem,type){if(force!==true){type=elem;elem=force;force=false}if(elem){type=type||"fx";var key=type+"mark",count=force?0:(jQuery.data(elem,key,undefined,true)||1)-1;if(count)jQuery.data(elem,key,count,true);else{jQuery.removeData(elem,key,
true);handleQueueMarkDefer(elem,type,"mark")}}},queue:function(elem,type,data){if(elem){type=(type||"fx")+"queue";var q=jQuery.data(elem,type,undefined,true);if(data)if(!q||jQuery.isArray(data))q=jQuery.data(elem,type,jQuery.makeArray(data),true);else q.push(data);return q||[]}},dequeue:function(elem,type){type=type||"fx";var queue=jQuery.queue(elem,type),fn=queue.shift(),defer;if(fn==="inprogress")fn=queue.shift();if(fn){if(type==="fx")queue.unshift("inprogress");fn.call(elem,function(){jQuery.dequeue(elem,
type)})}if(!queue.length){jQuery.removeData(elem,type+"queue",true);handleQueueMarkDefer(elem,type,"queue")}}});jQuery.fn.extend({queue:function(type,data){if(typeof type!=="string"){data=type;type="fx"}if(data===undefined)return jQuery.queue(this[0],type);return this.each(function(){var queue=jQuery.queue(this,type,data);if(type==="fx"&&queue[0]!=="inprogress")jQuery.dequeue(this,type)})},dequeue:function(type){return this.each(function(){jQuery.dequeue(this,type)})},delay:function(time,type){time=
jQuery.fx?jQuery.fx.speeds[time]||time:time;type=type||"fx";return this.queue(type,function(){var elem=this;setTimeout(function(){jQuery.dequeue(elem,type)},time)})},clearQueue:function(type){return this.queue(type||"fx",[])},promise:function(type,object){if(typeof type!=="string"){object=type;type=undefined}type=type||"fx";var defer=jQuery.Deferred(),elements=this,i=elements.length,count=1,deferDataKey=type+"defer",queueDataKey=type+"queue",markDataKey=type+"mark",tmp;function resolve(){if(!--count)defer.resolveWith(elements,
[elements])}while(i--)if(tmp=jQuery.data(elements[i],deferDataKey,undefined,true)||(jQuery.data(elements[i],queueDataKey,undefined,true)||jQuery.data(elements[i],markDataKey,undefined,true))&&jQuery.data(elements[i],deferDataKey,jQuery._Deferred(),true)){count++;tmp.done(resolve)}resolve();return defer.promise()}});var rclass=/[\n\t\r]/g,rspace=/\s+/,rreturn=/\r/g,rtype=/^(?:button|input)$/i,rfocusable=/^(?:button|input|object|select|textarea)$/i,rclickable=/^a(?:rea)?$/i,rboolean=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,
rinvalidChar=/\:|^on/,formHook,boolHook;jQuery.fn.extend({attr:function(name,value){return jQuery.access(this,name,value,true,jQuery.attr)},removeAttr:function(name){return this.each(function(){jQuery.removeAttr(this,name)})},prop:function(name,value){return jQuery.access(this,name,value,true,jQuery.prop)},removeProp:function(name){name=jQuery.propFix[name]||name;return this.each(function(){try{this[name]=undefined;delete this[name]}catch(e){}})},addClass:function(value){var classNames,i,l,elem,setClass,
c,cl;if(jQuery.isFunction(value))return this.each(function(j){jQuery(this).addClass(value.call(this,j,this.className))});if(value&&typeof value==="string"){classNames=value.split(rspace);for(i=0,l=this.length;i<l;i++){elem=this[i];if(elem.nodeType===1)if(!elem.className&&classNames.length===1)elem.className=value;else{setClass=" "+elem.className+" ";for(c=0,cl=classNames.length;c<cl;c++)if(!~setClass.indexOf(" "+classNames[c]+" "))setClass+=classNames[c]+" ";elem.className=jQuery.trim(setClass)}}}return this},
removeClass:function(value){var classNames,i,l,elem,className,c,cl;if(jQuery.isFunction(value))return this.each(function(j){jQuery(this).removeClass(value.call(this,j,this.className))});if(value&&typeof value==="string"||value===undefined){classNames=(value||"").split(rspace);for(i=0,l=this.length;i<l;i++){elem=this[i];if(elem.nodeType===1&&elem.className)if(value){className=(" "+elem.className+" ").replace(rclass," ");for(c=0,cl=classNames.length;c<cl;c++)className=className.replace(" "+classNames[c]+
" "," ");elem.className=jQuery.trim(className)}else elem.className=""}}return this},toggleClass:function(value,stateVal){var type=typeof value,isBool=typeof stateVal==="boolean";if(jQuery.isFunction(value))return this.each(function(i){jQuery(this).toggleClass(value.call(this,i,this.className,stateVal),stateVal)});return this.each(function(){if(type==="string"){var className,i=0,self=jQuery(this),state=stateVal,classNames=value.split(rspace);while(className=classNames[i++]){state=isBool?state:!self.hasClass(className);
self[state?"addClass":"removeClass"](className)}}else if(type==="undefined"||type==="boolean"){if(this.className)jQuery._data(this,"__className__",this.className);this.className=this.className||value===false?"":jQuery._data(this,"__className__")||""}})},hasClass:function(selector){var className=" "+selector+" ";for(var i=0,l=this.length;i<l;i++)if((" "+this[i].className+" ").replace(rclass," ").indexOf(className)>-1)return true;return false},val:function(value){var hooks,ret,elem=this[0];if(!arguments.length){if(elem){hooks=
jQuery.valHooks[elem.nodeName.toLowerCase()]||jQuery.valHooks[elem.type];if(hooks&&"get"in hooks&&(ret=hooks.get(elem,"value"))!==undefined)return ret;ret=elem.value;return typeof ret==="string"?ret.replace(rreturn,""):ret==null?"":ret}return undefined}var isFunction=jQuery.isFunction(value);return this.each(function(i){var self=jQuery(this),val;if(this.nodeType!==1)return;if(isFunction)val=value.call(this,i,self.val());else val=value;if(val==null)val="";else if(typeof val==="number")val+="";else if(jQuery.isArray(val))val=
jQuery.map(val,function(value){return value==null?"":value+""});hooks=jQuery.valHooks[this.nodeName.toLowerCase()]||jQuery.valHooks[this.type];if(!hooks||!("set"in hooks)||hooks.set(this,val,"value")===undefined)this.value=val})}});jQuery.extend({valHooks:{option:{get:function(elem){var val=elem.attributes.value;return!val||val.specified?elem.value:elem.text}},select:{get:function(elem){var value,index=elem.selectedIndex,values=[],options=elem.options,one=elem.type==="select-one";if(index<0)return null;
for(var i=one?index:0,max=one?index+1:options.length;i<max;i++){var option=options[i];if(option.selected&&(jQuery.support.optDisabled?!option.disabled:option.getAttribute("disabled")===null)&&(!option.parentNode.disabled||!jQuery.nodeName(option.parentNode,"optgroup"))){value=jQuery(option).val();if(one)return value;values.push(value)}}if(one&&!values.length&&options.length)return jQuery(options[index]).val();return values},set:function(elem,value){var values=jQuery.makeArray(value);jQuery(elem).find("option").each(function(){this.selected=
jQuery.inArray(jQuery(this).val(),values)>=0});if(!values.length)elem.selectedIndex=-1;return values}}},attrFn:{val:true,css:true,html:true,text:true,data:true,width:true,height:true,offset:true},attrFix:{tabindex:"tabIndex"},attr:function(elem,name,value,pass){var nType=elem.nodeType;if(!elem||nType===3||nType===8||nType===2)return undefined;if(pass&&name in jQuery.attrFn)return jQuery(elem)[name](value);if(!("getAttribute"in elem))return jQuery.prop(elem,name,value);var ret,hooks,notxml=nType!==
1||!jQuery.isXMLDoc(elem);if(notxml){name=jQuery.attrFix[name]||name;hooks=jQuery.attrHooks[name];if(!hooks)if(rboolean.test(name))hooks=boolHook;else if(formHook&&name!=="className"&&(jQuery.nodeName(elem,"form")||rinvalidChar.test(name)))hooks=formHook}if(value!==undefined)if(value===null){jQuery.removeAttr(elem,name);return undefined}else if(hooks&&"set"in hooks&&notxml&&(ret=hooks.set(elem,value,name))!==undefined)return ret;else{elem.setAttribute(name,""+value);return value}else if(hooks&&"get"in
hooks&&notxml&&(ret=hooks.get(elem,name))!==null)return ret;else{ret=elem.getAttribute(name);return ret===null?undefined:ret}},removeAttr:function(elem,name){var propName;if(elem.nodeType===1){name=jQuery.attrFix[name]||name;if(jQuery.support.getSetAttribute)elem.removeAttribute(name);else{jQuery.attr(elem,name,"");elem.removeAttributeNode(elem.getAttributeNode(name))}if(rboolean.test(name)&&(propName=jQuery.propFix[name]||name)in elem)elem[propName]=false}},attrHooks:{type:{set:function(elem,value){if(rtype.test(elem.nodeName)&&
elem.parentNode)jQuery.error("type property can't be changed");else if(!jQuery.support.radioValue&&value==="radio"&&jQuery.nodeName(elem,"input")){var val=elem.value;elem.setAttribute("type",value);if(val)elem.value=val;return value}}},tabIndex:{get:function(elem){var attributeNode=elem.getAttributeNode("tabIndex");return attributeNode&&attributeNode.specified?parseInt(attributeNode.value,10):rfocusable.test(elem.nodeName)||rclickable.test(elem.nodeName)&&elem.href?0:undefined}},value:{get:function(elem,
name){if(formHook&&jQuery.nodeName(elem,"button"))return formHook.get(elem,name);return name in elem?elem.value:null},set:function(elem,value,name){if(formHook&&jQuery.nodeName(elem,"button"))return formHook.set(elem,value,name);elem.value=value}}},propFix:{tabindex:"tabIndex",readonly:"readOnly","for":"htmlFor","class":"className",maxlength:"maxLength",cellspacing:"cellSpacing",cellpadding:"cellPadding",rowspan:"rowSpan",colspan:"colSpan",usemap:"useMap",frameborder:"frameBorder",contenteditable:"contentEditable"},
prop:function(elem,name,value){var nType=elem.nodeType;if(!elem||nType===3||nType===8||nType===2)return undefined;var ret,hooks,notxml=nType!==1||!jQuery.isXMLDoc(elem);if(notxml){name=jQuery.propFix[name]||name;hooks=jQuery.propHooks[name]}if(value!==undefined)if(hooks&&"set"in hooks&&(ret=hooks.set(elem,value,name))!==undefined)return ret;else return elem[name]=value;else if(hooks&&"get"in hooks&&(ret=hooks.get(elem,name))!==undefined)return ret;else return elem[name]},propHooks:{}});boolHook={get:function(elem,
name){return jQuery.prop(elem,name)?name.toLowerCase():undefined},set:function(elem,value,name){var propName;if(value===false)jQuery.removeAttr(elem,name);else{propName=jQuery.propFix[name]||name;if(propName in elem)elem[propName]=true;elem.setAttribute(name,name.toLowerCase())}return name}};if(!jQuery.support.getSetAttribute){jQuery.attrFix=jQuery.propFix;formHook=jQuery.attrHooks.name=jQuery.attrHooks.title=jQuery.valHooks.button={get:function(elem,name){var ret;ret=elem.getAttributeNode(name);
return ret&&ret.nodeValue!==""?ret.nodeValue:undefined},set:function(elem,value,name){var ret=elem.getAttributeNode(name);if(ret){ret.nodeValue=value;return value}}};jQuery.each(["width","height"],function(i,name){jQuery.attrHooks[name]=jQuery.extend(jQuery.attrHooks[name],{set:function(elem,value){if(value===""){elem.setAttribute(name,"auto");return value}}})})}if(!jQuery.support.hrefNormalized)jQuery.each(["href","src","width","height"],function(i,name){jQuery.attrHooks[name]=jQuery.extend(jQuery.attrHooks[name],
{get:function(elem){var ret=elem.getAttribute(name,2);return ret===null?undefined:ret}})});if(!jQuery.support.style)jQuery.attrHooks.style={get:function(elem){return elem.style.cssText.toLowerCase()||undefined},set:function(elem,value){return elem.style.cssText=""+value}};if(!jQuery.support.optSelected)jQuery.propHooks.selected=jQuery.extend(jQuery.propHooks.selected,{get:function(elem){var parent=elem.parentNode;if(parent){parent.selectedIndex;if(parent.parentNode)parent.parentNode.selectedIndex}}});
if(!jQuery.support.checkOn)jQuery.each(["radio","checkbox"],function(){jQuery.valHooks[this]={get:function(elem){return elem.getAttribute("value")===null?"on":elem.value}}});jQuery.each(["radio","checkbox"],function(){jQuery.valHooks[this]=jQuery.extend(jQuery.valHooks[this],{set:function(elem,value){if(jQuery.isArray(value))return elem.checked=jQuery.inArray(jQuery(elem).val(),value)>=0}})});var rnamespaces=/\.(.*)$/,rformElems=/^(?:textarea|input|select)$/i,rperiod=/\./g,rspaces=/ /g,rescape=/[^\w\s.|`]/g,
fcleanup=function(nm){return nm.replace(rescape,"\\$&")};jQuery.event={add:function(elem,types,handler,data){if(elem.nodeType===3||elem.nodeType===8)return;if(handler===false)handler=returnFalse;else if(!handler)return;var handleObjIn,handleObj;if(handler.handler){handleObjIn=handler;handler=handleObjIn.handler}if(!handler.guid)handler.guid=jQuery.guid++;var elemData=jQuery._data(elem);if(!elemData)return;var events=elemData.events,eventHandle=elemData.handle;if(!events)elemData.events=events={};
if(!eventHandle)elemData.handle=eventHandle=function(e){return typeof jQuery!=="undefined"&&(!e||jQuery.event.triggered!==e.type)?jQuery.event.handle.apply(eventHandle.elem,arguments):undefined};eventHandle.elem=elem;types=types.split(" ");var type,i=0,namespaces;while(type=types[i++]){handleObj=handleObjIn?jQuery.extend({},handleObjIn):{handler:handler,data:data};if(type.indexOf(".")>-1){namespaces=type.split(".");type=namespaces.shift();handleObj.namespace=namespaces.slice(0).sort().join(".")}else{namespaces=
[];handleObj.namespace=""}handleObj.type=type;if(!handleObj.guid)handleObj.guid=handler.guid;var handlers=events[type],special=jQuery.event.special[type]||{};if(!handlers){handlers=events[type]=[];if(!special.setup||special.setup.call(elem,data,namespaces,eventHandle)===false)if(elem.addEventListener)elem.addEventListener(type,eventHandle,false);else if(elem.attachEvent)elem.attachEvent("on"+type,eventHandle)}if(special.add){special.add.call(elem,handleObj);if(!handleObj.handler.guid)handleObj.handler.guid=
handler.guid}handlers.push(handleObj);jQuery.event.global[type]=true}elem=null},global:{},remove:function(elem,types,handler,pos){if(elem.nodeType===3||elem.nodeType===8)return;if(handler===false)handler=returnFalse;var ret,type,fn,j,i=0,all,namespaces,namespace,special,eventType,handleObj,origType,elemData=jQuery.hasData(elem)&&jQuery._data(elem),events=elemData&&elemData.events;if(!elemData||!events)return;if(types&&types.type){handler=types.handler;types=types.type}if(!types||typeof types==="string"&&
types.charAt(0)==="."){types=types||"";for(type in events)jQuery.event.remove(elem,type+types);return}types=types.split(" ");while(type=types[i++]){origType=type;handleObj=null;all=type.indexOf(".")<0;namespaces=[];if(!all){namespaces=type.split(".");type=namespaces.shift();namespace=new RegExp("(^|\\.)"+jQuery.map(namespaces.slice(0).sort(),fcleanup).join("\\.(?:.*\\.)?")+"(\\.|$)")}eventType=events[type];if(!eventType)continue;if(!handler){for(j=0;j<eventType.length;j++){handleObj=eventType[j];
if(all||namespace.test(handleObj.namespace)){jQuery.event.remove(elem,origType,handleObj.handler,j);eventType.splice(j--,1)}}continue}special=jQuery.event.special[type]||{};for(j=pos||0;j<eventType.length;j++){handleObj=eventType[j];if(handler.guid===handleObj.guid){if(all||namespace.test(handleObj.namespace)){if(pos==null)eventType.splice(j--,1);if(special.remove)special.remove.call(elem,handleObj)}if(pos!=null)break}}if(eventType.length===0||pos!=null&&eventType.length===1){if(!special.teardown||
special.teardown.call(elem,namespaces)===false)jQuery.removeEvent(elem,type,elemData.handle);ret=null;delete events[type]}}if(jQuery.isEmptyObject(events)){var handle=elemData.handle;if(handle)handle.elem=null;delete elemData.events;delete elemData.handle;if(jQuery.isEmptyObject(elemData))jQuery.removeData(elem,undefined,true)}},customEvent:{"getData":true,"setData":true,"changeData":true},trigger:function(event,data,elem,onlyHandlers){var type=event.type||event,namespaces=[],exclusive;if(type.indexOf("!")>=
0){type=type.slice(0,-1);exclusive=true}if(type.indexOf(".")>=0){namespaces=type.split(".");type=namespaces.shift();namespaces.sort()}if((!elem||jQuery.event.customEvent[type])&&!jQuery.event.global[type])return;event=typeof event==="object"?event[jQuery.expando]?event:new jQuery.Event(type,event):new jQuery.Event(type);event.type=type;event.exclusive=exclusive;event.namespace=namespaces.join(".");event.namespace_re=new RegExp("(^|\\.)"+namespaces.join("\\.(?:.*\\.)?")+"(\\.|$)");if(onlyHandlers||
!elem){event.preventDefault();event.stopPropagation()}if(!elem){jQuery.each(jQuery.cache,function(){var internalKey=jQuery.expando,internalCache=this[internalKey];if(internalCache&&internalCache.events&&internalCache.events[type])jQuery.event.trigger(event,data,internalCache.handle.elem)});return}if(elem.nodeType===3||elem.nodeType===8)return;event.result=undefined;event.target=elem;data=data!=null?jQuery.makeArray(data):[];data.unshift(event);var cur=elem,ontype=type.indexOf(":")<0?"on"+type:"";
do{var handle=jQuery._data(cur,"handle");event.currentTarget=cur;if(handle)handle.apply(cur,data);if(ontype&&jQuery.acceptData(cur)&&cur[ontype]&&cur[ontype].apply(cur,data)===false){event.result=false;event.preventDefault()}cur=cur.parentNode||cur.ownerDocument||cur===event.target.ownerDocument&&window}while(cur&&!event.isPropagationStopped());if(!event.isDefaultPrevented()){var old,special=jQuery.event.special[type]||{};if((!special._default||special._default.call(elem.ownerDocument,event)===false)&&
!(type==="click"&&jQuery.nodeName(elem,"a"))&&jQuery.acceptData(elem)){try{if(ontype&&elem[type]){old=elem[ontype];if(old)elem[ontype]=null;jQuery.event.triggered=type;elem[type]()}}catch(ieError){}if(old)elem[ontype]=old;jQuery.event.triggered=undefined}}return event.result},handle:function(event){event=jQuery.event.fix(event||window.event);var handlers=((jQuery._data(this,"events")||{})[event.type]||[]).slice(0),run_all=!event.exclusive&&!event.namespace,args=Array.prototype.slice.call(arguments,
0);args[0]=event;event.currentTarget=this;for(var j=0,l=handlers.length;j<l;j++){var handleObj=handlers[j];if(run_all||event.namespace_re.test(handleObj.namespace)){event.handler=handleObj.handler;event.data=handleObj.data;event.handleObj=handleObj;var ret=handleObj.handler.apply(this,args);if(ret!==undefined){event.result=ret;if(ret===false){event.preventDefault();event.stopPropagation()}}if(event.isImmediatePropagationStopped())break}}return event.result},props:"altKey attrChange attrName bubbles button cancelable charCode clientX clientY ctrlKey currentTarget data detail eventPhase fromElement handler keyCode layerX layerY metaKey newValue offsetX offsetY pageX pageY prevValue relatedNode relatedTarget screenX screenY shiftKey srcElement target toElement view wheelDelta which".split(" "),
fix:function(event){if(event[jQuery.expando])return event;var originalEvent=event;event=jQuery.Event(originalEvent);for(var i=this.props.length,prop;i;){prop=this.props[--i];event[prop]=originalEvent[prop]}if(!event.target)event.target=event.srcElement||document;if(event.target.nodeType===3)event.target=event.target.parentNode;if(!event.relatedTarget&&event.fromElement)event.relatedTarget=event.fromElement===event.target?event.toElement:event.fromElement;if(event.pageX==null&&event.clientX!=null){var eventDocument=
event.target.ownerDocument||document,doc=eventDocument.documentElement,body=eventDocument.body;event.pageX=event.clientX+(doc&&doc.scrollLeft||body&&body.scrollLeft||0)-(doc&&doc.clientLeft||body&&body.clientLeft||0);event.pageY=event.clientY+(doc&&doc.scrollTop||body&&body.scrollTop||0)-(doc&&doc.clientTop||body&&body.clientTop||0)}if(event.which==null&&(event.charCode!=null||event.keyCode!=null))event.which=event.charCode!=null?event.charCode:event.keyCode;if(!event.metaKey&&event.ctrlKey)event.metaKey=
event.ctrlKey;if(!event.which&&event.button!==undefined)event.which=event.button&1?1:event.button&2?3:event.button&4?2:0;return event},guid:1E8,proxy:jQuery.proxy,special:{ready:{setup:jQuery.bindReady,teardown:jQuery.noop},live:{add:function(handleObj){jQuery.event.add(this,liveConvert(handleObj.origType,handleObj.selector),jQuery.extend({},handleObj,{handler:liveHandler,guid:handleObj.handler.guid}))},remove:function(handleObj){jQuery.event.remove(this,liveConvert(handleObj.origType,handleObj.selector),
handleObj)}},beforeunload:{setup:function(data,namespaces,eventHandle){if(jQuery.isWindow(this))this.onbeforeunload=eventHandle},teardown:function(namespaces,eventHandle){if(this.onbeforeunload===eventHandle)this.onbeforeunload=null}}}};jQuery.removeEvent=document.removeEventListener?function(elem,type,handle){if(elem.removeEventListener)elem.removeEventListener(type,handle,false)}:function(elem,type,handle){if(elem.detachEvent)elem.detachEvent("on"+type,handle)};jQuery.Event=function(src,props){if(!this.preventDefault)return new jQuery.Event(src,
props);if(src&&src.type){this.originalEvent=src;this.type=src.type;this.isDefaultPrevented=src.defaultPrevented||src.returnValue===false||src.getPreventDefault&&src.getPreventDefault()?returnTrue:returnFalse}else this.type=src;if(props)jQuery.extend(this,props);this.timeStamp=jQuery.now();this[jQuery.expando]=true};function returnFalse(){return false}function returnTrue(){return true}jQuery.Event.prototype={preventDefault:function(){this.isDefaultPrevented=returnTrue;var e=this.originalEvent;if(!e)return;
if(e.preventDefault)e.preventDefault();else e.returnValue=false},stopPropagation:function(){this.isPropagationStopped=returnTrue;var e=this.originalEvent;if(!e)return;if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=returnTrue;this.stopPropagation()},isDefaultPrevented:returnFalse,isPropagationStopped:returnFalse,isImmediatePropagationStopped:returnFalse};var withinElement=function(event){var related=event.relatedTarget,
inside=false,eventType=event.type;event.type=event.data;if(related!==this){if(related)inside=jQuery.contains(this,related);if(!inside){jQuery.event.handle.apply(this,arguments);event.type=eventType}}},delegate=function(event){event.type=event.data;jQuery.event.handle.apply(this,arguments)};jQuery.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(orig,fix){jQuery.event.special[orig]={setup:function(data){jQuery.event.add(this,fix,data&&data.selector?delegate:withinElement,orig)},teardown:function(data){jQuery.event.remove(this,
fix,data&&data.selector?delegate:withinElement)}}});if(!jQuery.support.submitBubbles)jQuery.event.special.submit={setup:function(data,namespaces){if(!jQuery.nodeName(this,"form")){jQuery.event.add(this,"click.specialSubmit",function(e){var elem=e.target,type=elem.type;if((type==="submit"||type==="image")&&jQuery(elem).closest("form").length)trigger("submit",this,arguments)});jQuery.event.add(this,"keypress.specialSubmit",function(e){var elem=e.target,type=elem.type;if((type==="text"||type==="password")&&
jQuery(elem).closest("form").length&&e.keyCode===13)trigger("submit",this,arguments)})}else return false},teardown:function(namespaces){jQuery.event.remove(this,".specialSubmit")}};if(!jQuery.support.changeBubbles){var changeFilters,getVal=function(elem){var type=elem.type,val=elem.value;if(type==="radio"||type==="checkbox")val=elem.checked;else if(type==="select-multiple")val=elem.selectedIndex>-1?jQuery.map(elem.options,function(elem){return elem.selected}).join("-"):"";else if(jQuery.nodeName(elem,
"select"))val=elem.selectedIndex;return val},testChange=function testChange(e){var elem=e.target,data,val;if(!rformElems.test(elem.nodeName)||elem.readOnly)return;data=jQuery._data(elem,"_change_data");val=getVal(elem);if(e.type!=="focusout"||elem.type!=="radio")jQuery._data(elem,"_change_data",val);if(data===undefined||val===data)return;if(data!=null||val){e.type="change";e.liveFired=undefined;jQuery.event.trigger(e,arguments[1],elem)}};jQuery.event.special.change={filters:{focusout:testChange,beforedeactivate:testChange,
click:function(e){var elem=e.target,type=jQuery.nodeName(elem,"input")?elem.type:"";if(type==="radio"||type==="checkbox"||jQuery.nodeName(elem,"select"))testChange.call(this,e)},keydown:function(e){var elem=e.target,type=jQuery.nodeName(elem,"input")?elem.type:"";if(e.keyCode===13&&!jQuery.nodeName(elem,"textarea")||e.keyCode===32&&(type==="checkbox"||type==="radio")||type==="select-multiple")testChange.call(this,e)},beforeactivate:function(e){var elem=e.target;jQuery._data(elem,"_change_data",getVal(elem))}},
setup:function(data,namespaces){if(this.type==="file")return false;for(var type in changeFilters)jQuery.event.add(this,type+".specialChange",changeFilters[type]);return rformElems.test(this.nodeName)},teardown:function(namespaces){jQuery.event.remove(this,".specialChange");return rformElems.test(this.nodeName)}};changeFilters=jQuery.event.special.change.filters;changeFilters.focus=changeFilters.beforeactivate}function trigger(type,elem,args){var event=jQuery.extend({},args[0]);event.type=type;event.originalEvent=
{};event.liveFired=undefined;jQuery.event.handle.call(elem,event);if(event.isDefaultPrevented())args[0].preventDefault()}if(!jQuery.support.focusinBubbles)jQuery.each({focus:"focusin",blur:"focusout"},function(orig,fix){var attaches=0;jQuery.event.special[fix]={setup:function(){if(attaches++===0)document.addEventListener(orig,handler,true)},teardown:function(){if(--attaches===0)document.removeEventListener(orig,handler,true)}};function handler(donor){var e=jQuery.event.fix(donor);e.type=fix;e.originalEvent=
{};jQuery.event.trigger(e,null,e.target);if(e.isDefaultPrevented())donor.preventDefault()}});jQuery.each(["bind","one"],function(i,name){jQuery.fn[name]=function(type,data,fn){var handler;if(typeof type==="object"){for(var key in type)this[name](key,data,type[key],fn);return this}if(arguments.length===2||data===false){fn=data;data=undefined}if(name==="one"){handler=function(event){jQuery(this).unbind(event,handler);return fn.apply(this,arguments)};handler.guid=fn.guid||jQuery.guid++}else handler=
fn;if(type==="unload"&&name!=="one")this.one(type,data,fn);else for(var i=0,l=this.length;i<l;i++)jQuery.event.add(this[i],type,handler,data);return this}});jQuery.fn.extend({unbind:function(type,fn){if(typeof type==="object"&&!type.preventDefault)for(var key in type)this.unbind(key,type[key]);else for(var i=0,l=this.length;i<l;i++)jQuery.event.remove(this[i],type,fn);return this},delegate:function(selector,types,data,fn){return this.live(types,data,fn,selector)},undelegate:function(selector,types,
fn){if(arguments.length===0)return this.unbind("live");else return this.die(types,null,fn,selector)},trigger:function(type,data){return this.each(function(){jQuery.event.trigger(type,data,this)})},triggerHandler:function(type,data){if(this[0])return jQuery.event.trigger(type,data,this[0],true)},toggle:function(fn){var args=arguments,guid=fn.guid||jQuery.guid++,i=0,toggler=function(event){var lastToggle=(jQuery.data(this,"lastToggle"+fn.guid)||0)%i;jQuery.data(this,"lastToggle"+fn.guid,lastToggle+
1);event.preventDefault();return args[lastToggle].apply(this,arguments)||false};toggler.guid=guid;while(i<args.length)args[i++].guid=guid;return this.click(toggler)},hover:function(fnOver,fnOut){return this.mouseenter(fnOver).mouseleave(fnOut||fnOver)}});var liveMap={focus:"focusin",blur:"focusout",mouseenter:"mouseover",mouseleave:"mouseout"};jQuery.each(["live","die"],function(i,name){jQuery.fn[name]=function(types,data,fn,origSelector){var type,i=0,match,namespaces,preType,selector=origSelector||
this.selector,context=origSelector?this:jQuery(this.context);if(typeof types==="object"&&!types.preventDefault){for(var key in types)context[name](key,data,types[key],selector);return this}if(name==="die"&&!types&&origSelector&&origSelector.charAt(0)==="."){context.unbind(origSelector);return this}if(data===false||jQuery.isFunction(data)){fn=data||returnFalse;data=undefined}types=(types||"").split(" ");while((type=types[i++])!=null){match=rnamespaces.exec(type);namespaces="";if(match){namespaces=
match[0];type=type.replace(rnamespaces,"")}if(type==="hover"){types.push("mouseenter"+namespaces,"mouseleave"+namespaces);continue}preType=type;if(liveMap[type]){types.push(liveMap[type]+namespaces);type=type+namespaces}else type=(liveMap[type]||type)+namespaces;if(name==="live")for(var j=0,l=context.length;j<l;j++)jQuery.event.add(context[j],"live."+liveConvert(type,selector),{data:data,selector:selector,handler:fn,origType:type,origHandler:fn,preType:preType});else context.unbind("live."+liveConvert(type,
selector),fn)}return this}});function liveHandler(event){var stop,maxLevel,related,match,handleObj,elem,j,i,l,data,close,namespace,ret,elems=[],selectors=[],events=jQuery._data(this,"events");if(event.liveFired===this||!events||!events.live||event.target.disabled||event.button&&event.type==="click")return;if(event.namespace)namespace=new RegExp("(^|\\.)"+event.namespace.split(".").join("\\.(?:.*\\.)?")+"(\\.|$)");event.liveFired=this;var live=events.live.slice(0);for(j=0;j<live.length;j++){handleObj=
live[j];if(handleObj.origType.replace(rnamespaces,"")===event.type)selectors.push(handleObj.selector);else live.splice(j--,1)}match=jQuery(event.target).closest(selectors,event.currentTarget);for(i=0,l=match.length;i<l;i++){close=match[i];for(j=0;j<live.length;j++){handleObj=live[j];if(close.selector===handleObj.selector&&(!namespace||namespace.test(handleObj.namespace))&&!close.elem.disabled){elem=close.elem;related=null;if(handleObj.preType==="mouseenter"||handleObj.preType==="mouseleave"){event.type=
handleObj.preType;related=jQuery(event.relatedTarget).closest(handleObj.selector)[0];if(related&&jQuery.contains(elem,related))related=elem}if(!related||related!==elem)elems.push({elem:elem,handleObj:handleObj,level:close.level})}}}for(i=0,l=elems.length;i<l;i++){match=elems[i];if(maxLevel&&match.level>maxLevel)break;event.currentTarget=match.elem;event.data=match.handleObj.data;event.handleObj=match.handleObj;ret=match.handleObj.origHandler.apply(match.elem,arguments);if(ret===false||event.isPropagationStopped()){maxLevel=
match.level;if(ret===false)stop=false;if(event.isImmediatePropagationStopped())break}}return stop}function liveConvert(type,selector){return(type&&type!=="*"?type+".":"")+selector.replace(rperiod,"`").replace(rspaces,"&")}jQuery.each(("blur focus focusin focusout load resize scroll unload click dblclick "+"mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave "+"change select submit keydown keypress keyup error").split(" "),function(i,name){jQuery.fn[name]=function(data,fn){if(fn==
null){fn=data;data=null}return arguments.length>0?this.bind(name,data,fn):this.trigger(name)};if(jQuery.attrFn)jQuery.attrFn[name]=true});(function(){var chunker=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^\[\]]*\]|['"][^'"]*['"]|[^\[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?((?:.|\r|\n)*)/g,done=0,toString=Object.prototype.toString,hasDuplicate=false,baseHasDuplicate=true,rBackslash=/\\/g,rNonWord=/\W/;[0,0].sort(function(){baseHasDuplicate=false;return 0});var Sizzle=function(selector,context,
results,seed){results=results||[];context=context||document;var origContext=context;if(context.nodeType!==1&&context.nodeType!==9)return[];if(!selector||typeof selector!=="string")return results;var m,set,checkSet,extra,ret,cur,pop,i,prune=true,contextXML=Sizzle.isXML(context),parts=[],soFar=selector;do{chunker.exec("");m=chunker.exec(soFar);if(m){soFar=m[3];parts.push(m[1]);if(m[2]){extra=m[3];break}}}while(m);if(parts.length>1&&origPOS.exec(selector))if(parts.length===2&&Expr.relative[parts[0]])set=
posProcess(parts[0]+parts[1],context);else{set=Expr.relative[parts[0]]?[context]:Sizzle(parts.shift(),context);while(parts.length){selector=parts.shift();if(Expr.relative[selector])selector+=parts.shift();set=posProcess(selector,set)}}else{if(!seed&&parts.length>1&&context.nodeType===9&&!contextXML&&Expr.match.ID.test(parts[0])&&!Expr.match.ID.test(parts[parts.length-1])){ret=Sizzle.find(parts.shift(),context,contextXML);context=ret.expr?Sizzle.filter(ret.expr,ret.set)[0]:ret.set[0]}if(context){ret=
seed?{expr:parts.pop(),set:makeArray(seed)}:Sizzle.find(parts.pop(),parts.length===1&&(parts[0]==="~"||parts[0]==="+")&&context.parentNode?context.parentNode:context,contextXML);set=ret.expr?Sizzle.filter(ret.expr,ret.set):ret.set;if(parts.length>0)checkSet=makeArray(set);else prune=false;while(parts.length){cur=parts.pop();pop=cur;if(!Expr.relative[cur])cur="";else pop=parts.pop();if(pop==null)pop=context;Expr.relative[cur](checkSet,pop,contextXML)}}else checkSet=parts=[]}if(!checkSet)checkSet=set;
if(!checkSet)Sizzle.error(cur||selector);if(toString.call(checkSet)==="[object Array]")if(!prune)results.push.apply(results,checkSet);else if(context&&context.nodeType===1)for(i=0;checkSet[i]!=null;i++){if(checkSet[i]&&(checkSet[i]===true||checkSet[i].nodeType===1&&Sizzle.contains(context,checkSet[i])))results.push(set[i])}else for(i=0;checkSet[i]!=null;i++){if(checkSet[i]&&checkSet[i].nodeType===1)results.push(set[i])}else makeArray(checkSet,results);if(extra){Sizzle(extra,origContext,results,seed);
Sizzle.uniqueSort(results)}return results};Sizzle.uniqueSort=function(results){if(sortOrder){hasDuplicate=baseHasDuplicate;results.sort(sortOrder);if(hasDuplicate)for(var i=1;i<results.length;i++)if(results[i]===results[i-1])results.splice(i--,1)}return results};Sizzle.matches=function(expr,set){return Sizzle(expr,null,null,set)};Sizzle.matchesSelector=function(node,expr){return Sizzle(expr,null,null,[node]).length>0};Sizzle.find=function(expr,context,isXML){var set;if(!expr)return[];for(var i=0,
l=Expr.order.length;i<l;i++){var match,type=Expr.order[i];if(match=Expr.leftMatch[type].exec(expr)){var left=match[1];match.splice(1,1);if(left.substr(left.length-1)!=="\\"){match[1]=(match[1]||"").replace(rBackslash,"");set=Expr.find[type](match,context,isXML);if(set!=null){expr=expr.replace(Expr.match[type],"");break}}}}if(!set)set=typeof context.getElementsByTagName!=="undefined"?context.getElementsByTagName("*"):[];return{set:set,expr:expr}};Sizzle.filter=function(expr,set,inplace,not){var match,
anyFound,old=expr,result=[],curLoop=set,isXMLFilter=set&&set[0]&&Sizzle.isXML(set[0]);while(expr&&set.length){for(var type in Expr.filter)if((match=Expr.leftMatch[type].exec(expr))!=null&&match[2]){var found,item,filter=Expr.filter[type],left=match[1];anyFound=false;match.splice(1,1);if(left.substr(left.length-1)==="\\")continue;if(curLoop===result)result=[];if(Expr.preFilter[type]){match=Expr.preFilter[type](match,curLoop,inplace,result,not,isXMLFilter);if(!match)anyFound=found=true;else if(match===
true)continue}if(match)for(var i=0;(item=curLoop[i])!=null;i++)if(item){found=filter(item,match,i,curLoop);var pass=not^!!found;if(inplace&&found!=null)if(pass)anyFound=true;else curLoop[i]=false;else if(pass){result.push(item);anyFound=true}}if(found!==undefined){if(!inplace)curLoop=result;expr=expr.replace(Expr.match[type],"");if(!anyFound)return[];break}}if(expr===old)if(anyFound==null)Sizzle.error(expr);else break;old=expr}return curLoop};Sizzle.error=function(msg){throw"Syntax error, unrecognized expression: "+
msg;};var Expr=Sizzle.selectors={order:["ID","NAME","TAG"],match:{ID:/#((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF\-]|\\.)+)/,NAME:/\[name=['"]*((?:[\w\u00c0-\uFFFF\-]|\\.)+)['"]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF\-]|\\.)+)\s*(?:(\S?=)\s*(?:(['"])(.*?)\3|(#?(?:[\w\u00c0-\uFFFF\-]|\\.)*)|)|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*\-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\(\s*(even|odd|(?:[+\-]?\d+|(?:[+\-]?\d*)?n\s*(?:[+\-]\s*\d+)?))\s*\))?/,POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^\-]|$)/,
PSEUDO:/:((?:[\w\u00c0-\uFFFF\-]|\\.)+)(?:\((['"]?)((?:\([^\)]+\)|[^\(\)]*)+)\2\))?/},leftMatch:{},attrMap:{"class":"className","for":"htmlFor"},attrHandle:{href:function(elem){return elem.getAttribute("href")},type:function(elem){return elem.getAttribute("type")}},relative:{"+":function(checkSet,part){var isPartStr=typeof part==="string",isTag=isPartStr&&!rNonWord.test(part),isPartStrNotTag=isPartStr&&!isTag;if(isTag)part=part.toLowerCase();for(var i=0,l=checkSet.length,elem;i<l;i++)if(elem=checkSet[i]){while((elem=
elem.previousSibling)&&elem.nodeType!==1);checkSet[i]=isPartStrNotTag||elem&&elem.nodeName.toLowerCase()===part?elem||false:elem===part}if(isPartStrNotTag)Sizzle.filter(part,checkSet,true)},">":function(checkSet,part){var elem,isPartStr=typeof part==="string",i=0,l=checkSet.length;if(isPartStr&&!rNonWord.test(part)){part=part.toLowerCase();for(;i<l;i++){elem=checkSet[i];if(elem){var parent=elem.parentNode;checkSet[i]=parent.nodeName.toLowerCase()===part?parent:false}}}else{for(;i<l;i++){elem=checkSet[i];
if(elem)checkSet[i]=isPartStr?elem.parentNode:elem.parentNode===part}if(isPartStr)Sizzle.filter(part,checkSet,true)}},"":function(checkSet,part,isXML){var nodeCheck,doneName=done++,checkFn=dirCheck;if(typeof part==="string"&&!rNonWord.test(part)){part=part.toLowerCase();nodeCheck=part;checkFn=dirNodeCheck}checkFn("parentNode",part,doneName,checkSet,nodeCheck,isXML)},"~":function(checkSet,part,isXML){var nodeCheck,doneName=done++,checkFn=dirCheck;if(typeof part==="string"&&!rNonWord.test(part)){part=
part.toLowerCase();nodeCheck=part;checkFn=dirNodeCheck}checkFn("previousSibling",part,doneName,checkSet,nodeCheck,isXML)}},find:{ID:function(match,context,isXML){if(typeof context.getElementById!=="undefined"&&!isXML){var m=context.getElementById(match[1]);return m&&m.parentNode?[m]:[]}},NAME:function(match,context){if(typeof context.getElementsByName!=="undefined"){var ret=[],results=context.getElementsByName(match[1]);for(var i=0,l=results.length;i<l;i++)if(results[i].getAttribute("name")===match[1])ret.push(results[i]);
return ret.length===0?null:ret}},TAG:function(match,context){if(typeof context.getElementsByTagName!=="undefined")return context.getElementsByTagName(match[1])}},preFilter:{CLASS:function(match,curLoop,inplace,result,not,isXML){match=" "+match[1].replace(rBackslash,"")+" ";if(isXML)return match;for(var i=0,elem;(elem=curLoop[i])!=null;i++)if(elem)if(not^(elem.className&&(" "+elem.className+" ").replace(/[\t\n\r]/g," ").indexOf(match)>=0)){if(!inplace)result.push(elem)}else if(inplace)curLoop[i]=false;
return false},ID:function(match){return match[1].replace(rBackslash,"")},TAG:function(match,curLoop){return match[1].replace(rBackslash,"").toLowerCase()},CHILD:function(match){if(match[1]==="nth"){if(!match[2])Sizzle.error(match[0]);match[2]=match[2].replace(/^\+|\s*/g,"");var test=/(-?)(\d*)(?:n([+\-]?\d*))?/.exec(match[2]==="even"&&"2n"||match[2]==="odd"&&"2n+1"||!/\D/.test(match[2])&&"0n+"+match[2]||match[2]);match[2]=test[1]+(test[2]||1)-0;match[3]=test[3]-0}else if(match[2])Sizzle.error(match[0]);
match[0]=done++;return match},ATTR:function(match,curLoop,inplace,result,not,isXML){var name=match[1]=match[1].replace(rBackslash,"");if(!isXML&&Expr.attrMap[name])match[1]=Expr.attrMap[name];match[4]=(match[4]||match[5]||"").replace(rBackslash,"");if(match[2]==="~=")match[4]=" "+match[4]+" ";return match},PSEUDO:function(match,curLoop,inplace,result,not){if(match[1]==="not")if((chunker.exec(match[3])||"").length>1||/^\w/.test(match[3]))match[3]=Sizzle(match[3],null,null,curLoop);else{var ret=Sizzle.filter(match[3],
curLoop,inplace,true^not);if(!inplace)result.push.apply(result,ret);return false}else if(Expr.match.POS.test(match[0])||Expr.match.CHILD.test(match[0]))return true;return match},POS:function(match){match.unshift(true);return match}},filters:{enabled:function(elem){return elem.disabled===false&&elem.type!=="hidden"},disabled:function(elem){return elem.disabled===true},checked:function(elem){return elem.checked===true},selected:function(elem){if(elem.parentNode)elem.parentNode.selectedIndex;return elem.selected===
true},parent:function(elem){return!!elem.firstChild},empty:function(elem){return!elem.firstChild},has:function(elem,i,match){return!!Sizzle(match[3],elem).length},header:function(elem){return/h\d/i.test(elem.nodeName)},text:function(elem){var attr=elem.getAttribute("type"),type=elem.type;return elem.nodeName.toLowerCase()==="input"&&"text"===type&&(attr===type||attr===null)},radio:function(elem){return elem.nodeName.toLowerCase()==="input"&&"radio"===elem.type},checkbox:function(elem){return elem.nodeName.toLowerCase()===
"input"&&"checkbox"===elem.type},file:function(elem){return elem.nodeName.toLowerCase()==="input"&&"file"===elem.type},password:function(elem){return elem.nodeName.toLowerCase()==="input"&&"password"===elem.type},submit:function(elem){var name=elem.nodeName.toLowerCase();return(name==="input"||name==="button")&&"submit"===elem.type},image:function(elem){return elem.nodeName.toLowerCase()==="input"&&"image"===elem.type},reset:function(elem){var name=elem.nodeName.toLowerCase();return(name==="input"||
name==="button")&&"reset"===elem.type},button:function(elem){var name=elem.nodeName.toLowerCase();return name==="input"&&"button"===elem.type||name==="button"},input:function(elem){return/input|select|textarea|button/i.test(elem.nodeName)},focus:function(elem){return elem===elem.ownerDocument.activeElement}},setFilters:{first:function(elem,i){return i===0},last:function(elem,i,match,array){return i===array.length-1},even:function(elem,i){return i%2===0},odd:function(elem,i){return i%2===1},lt:function(elem,
i,match){return i<match[3]-0},gt:function(elem,i,match){return i>match[3]-0},nth:function(elem,i,match){return match[3]-0===i},eq:function(elem,i,match){return match[3]-0===i}},filter:{PSEUDO:function(elem,match,i,array){var name=match[1],filter=Expr.filters[name];if(filter)return filter(elem,i,match,array);else if(name==="contains")return(elem.textContent||elem.innerText||Sizzle.getText([elem])||"").indexOf(match[3])>=0;else if(name==="not"){var not=match[3];for(var j=0,l=not.length;j<l;j++)if(not[j]===
elem)return false;return true}else Sizzle.error(name)},CHILD:function(elem,match){var type=match[1],node=elem;switch(type){case "only":case "first":while(node=node.previousSibling)if(node.nodeType===1)return false;if(type==="first")return true;node=elem;case "last":while(node=node.nextSibling)if(node.nodeType===1)return false;return true;case "nth":var first=match[2],last=match[3];if(first===1&&last===0)return true;var doneName=match[0],parent=elem.parentNode;if(parent&&(parent.sizcache!==doneName||
!elem.nodeIndex)){var count=0;for(node=parent.firstChild;node;node=node.nextSibling)if(node.nodeType===1)node.nodeIndex=++count;parent.sizcache=doneName}var diff=elem.nodeIndex-last;if(first===0)return diff===0;else return diff%first===0&&diff/first>=0}},ID:function(elem,match){return elem.nodeType===1&&elem.getAttribute("id")===match},TAG:function(elem,match){return match==="*"&&elem.nodeType===1||elem.nodeName.toLowerCase()===match},CLASS:function(elem,match){return(" "+(elem.className||elem.getAttribute("class"))+
" ").indexOf(match)>-1},ATTR:function(elem,match){var name=match[1],result=Expr.attrHandle[name]?Expr.attrHandle[name](elem):elem[name]!=null?elem[name]:elem.getAttribute(name),value=result+"",type=match[2],check=match[4];return result==null?type==="!=":type==="="?value===check:type==="*="?value.indexOf(check)>=0:type==="~="?(" "+value+" ").indexOf(check)>=0:!check?value&&result!==false:type==="!="?value!==check:type==="^="?value.indexOf(check)===0:type==="$="?value.substr(value.length-check.length)===
check:type==="|="?value===check||value.substr(0,check.length+1)===check+"-":false},POS:function(elem,match,i,array){var name=match[2],filter=Expr.setFilters[name];if(filter)return filter(elem,i,match,array)}}};var origPOS=Expr.match.POS,fescape=function(all,num){return"\\"+(num-0+1)};for(var type in Expr.match){Expr.match[type]=new RegExp(Expr.match[type].source+/(?![^\[]*\])(?![^\(]*\))/.source);Expr.leftMatch[type]=new RegExp(/(^(?:.|\r|\n)*?)/.source+Expr.match[type].source.replace(/\\(\d+)/g,
fescape))}var makeArray=function(array,results){array=Array.prototype.slice.call(array,0);if(results){results.push.apply(results,array);return results}return array};try{Array.prototype.slice.call(document.documentElement.childNodes,0)[0].nodeType}catch(e){makeArray=function(array,results){var i=0,ret=results||[];if(toString.call(array)==="[object Array]")Array.prototype.push.apply(ret,array);else if(typeof array.length==="number")for(var l=array.length;i<l;i++)ret.push(array[i]);else for(;array[i];i++)ret.push(array[i]);
return ret}}var sortOrder,siblingCheck;if(document.documentElement.compareDocumentPosition)sortOrder=function(a,b){if(a===b){hasDuplicate=true;return 0}if(!a.compareDocumentPosition||!b.compareDocumentPosition)return a.compareDocumentPosition?-1:1;return a.compareDocumentPosition(b)&4?-1:1};else{sortOrder=function(a,b){if(a===b){hasDuplicate=true;return 0}else if(a.sourceIndex&&b.sourceIndex)return a.sourceIndex-b.sourceIndex;var al,bl,ap=[],bp=[],aup=a.parentNode,bup=b.parentNode,cur=aup;if(aup===
bup)return siblingCheck(a,b);else if(!aup)return-1;else if(!bup)return 1;while(cur){ap.unshift(cur);cur=cur.parentNode}cur=bup;while(cur){bp.unshift(cur);cur=cur.parentNode}al=ap.length;bl=bp.length;for(var i=0;i<al&&i<bl;i++)if(ap[i]!==bp[i])return siblingCheck(ap[i],bp[i]);return i===al?siblingCheck(a,bp[i],-1):siblingCheck(ap[i],b,1)};siblingCheck=function(a,b,ret){if(a===b)return ret;var cur=a.nextSibling;while(cur){if(cur===b)return-1;cur=cur.nextSibling}return 1}}Sizzle.getText=function(elems){var ret=
"",elem;for(var i=0;elems[i];i++){elem=elems[i];if(elem.nodeType===3||elem.nodeType===4)ret+=elem.nodeValue;else if(elem.nodeType!==8)ret+=Sizzle.getText(elem.childNodes)}return ret};(function(){var form=document.createElement("div"),id="script"+(new Date).getTime(),root=document.documentElement;form.innerHTML="<a name='"+id+"'/>";root.insertBefore(form,root.firstChild);if(document.getElementById(id)){Expr.find.ID=function(match,context,isXML){if(typeof context.getElementById!=="undefined"&&!isXML){var m=
context.getElementById(match[1]);return m?m.id===match[1]||typeof m.getAttributeNode!=="undefined"&&m.getAttributeNode("id").nodeValue===match[1]?[m]:undefined:[]}};Expr.filter.ID=function(elem,match){var node=typeof elem.getAttributeNode!=="undefined"&&elem.getAttributeNode("id");return elem.nodeType===1&&node&&node.nodeValue===match}}root.removeChild(form);root=form=null})();(function(){var div=document.createElement("div");div.appendChild(document.createComment(""));if(div.getElementsByTagName("*").length>
0)Expr.find.TAG=function(match,context){var results=context.getElementsByTagName(match[1]);if(match[1]==="*"){var tmp=[];for(var i=0;results[i];i++)if(results[i].nodeType===1)tmp.push(results[i]);results=tmp}return results};div.innerHTML="<a href='#'></a>";if(div.firstChild&&typeof div.firstChild.getAttribute!=="undefined"&&div.firstChild.getAttribute("href")!=="#")Expr.attrHandle.href=function(elem){return elem.getAttribute("href",2)};div=null})();if(document.querySelectorAll)(function(){var oldSizzle=
Sizzle,div=document.createElement("div"),id="__sizzle__";div.innerHTML="<p class='TEST'></p>";if(div.querySelectorAll&&div.querySelectorAll(".TEST").length===0)return;Sizzle=function(query,context,extra,seed){context=context||document;if(!seed&&!Sizzle.isXML(context)){var match=/^(\w+$)|^\.([\w\-]+$)|^#([\w\-]+$)/.exec(query);if(match&&(context.nodeType===1||context.nodeType===9))if(match[1])return makeArray(context.getElementsByTagName(query),extra);else if(match[2]&&Expr.find.CLASS&&context.getElementsByClassName)return makeArray(context.getElementsByClassName(match[2]),
extra);if(context.nodeType===9){if(query==="body"&&context.body)return makeArray([context.body],extra);else if(match&&match[3]){var elem=context.getElementById(match[3]);if(elem&&elem.parentNode){if(elem.id===match[3])return makeArray([elem],extra)}else return makeArray([],extra)}try{return makeArray(context.querySelectorAll(query),extra)}catch(qsaError){}}else if(context.nodeType===1&&context.nodeName.toLowerCase()!=="object"){var oldContext=context,old=context.getAttribute("id"),nid=old||id,hasParent=
context.parentNode,relativeHierarchySelector=/^\s*[+~]/.test(query);if(!old)context.setAttribute("id",nid);else nid=nid.replace(/'/g,"\\$&");if(relativeHierarchySelector&&hasParent)context=context.parentNode;try{if(!relativeHierarchySelector||hasParent)return makeArray(context.querySelectorAll("[id='"+nid+"'] "+query),extra)}catch(pseudoError){}finally{if(!old)oldContext.removeAttribute("id")}}}return oldSizzle(query,context,extra,seed)};for(var prop in oldSizzle)Sizzle[prop]=oldSizzle[prop];div=
null})();(function(){var html=document.documentElement,matches=html.matchesSelector||html.mozMatchesSelector||html.webkitMatchesSelector||html.msMatchesSelector;if(matches){var disconnectedMatch=!matches.call(document.createElement("div"),"div"),pseudoWorks=false;try{matches.call(document.documentElement,"[test!='']:sizzle")}catch(pseudoError){pseudoWorks=true}Sizzle.matchesSelector=function(node,expr){expr=expr.replace(/\=\s*([^'"\]]*)\s*\]/g,"='$1']");if(!Sizzle.isXML(node))try{if(pseudoWorks||
!Expr.match.PSEUDO.test(expr)&&!/!=/.test(expr)){var ret=matches.call(node,expr);if(ret||!disconnectedMatch||node.document&&node.document.nodeType!==11)return ret}}catch(e){}return Sizzle(expr,null,null,[node]).length>0}}})();(function(){var div=document.createElement("div");div.innerHTML="<div class='test e'></div><div class='test'></div>";if(!div.getElementsByClassName||div.getElementsByClassName("e").length===0)return;div.lastChild.className="e";if(div.getElementsByClassName("e").length===1)return;
Expr.order.splice(1,0,"CLASS");Expr.find.CLASS=function(match,context,isXML){if(typeof context.getElementsByClassName!=="undefined"&&!isXML)return context.getElementsByClassName(match[1])};div=null})();function dirNodeCheck(dir,cur,doneName,checkSet,nodeCheck,isXML){for(var i=0,l=checkSet.length;i<l;i++){var elem=checkSet[i];if(elem){var match=false;elem=elem[dir];while(elem){if(elem.sizcache===doneName){match=checkSet[elem.sizset];break}if(elem.nodeType===1&&!isXML){elem.sizcache=doneName;elem.sizset=
i}if(elem.nodeName.toLowerCase()===cur){match=elem;break}elem=elem[dir]}checkSet[i]=match}}}function dirCheck(dir,cur,doneName,checkSet,nodeCheck,isXML){for(var i=0,l=checkSet.length;i<l;i++){var elem=checkSet[i];if(elem){var match=false;elem=elem[dir];while(elem){if(elem.sizcache===doneName){match=checkSet[elem.sizset];break}if(elem.nodeType===1){if(!isXML){elem.sizcache=doneName;elem.sizset=i}if(typeof cur!=="string"){if(elem===cur){match=true;break}}else if(Sizzle.filter(cur,[elem]).length>0){match=
elem;break}}elem=elem[dir]}checkSet[i]=match}}}if(document.documentElement.contains)Sizzle.contains=function(a,b){return a!==b&&(a.contains?a.contains(b):true)};else if(document.documentElement.compareDocumentPosition)Sizzle.contains=function(a,b){return!!(a.compareDocumentPosition(b)&16)};else Sizzle.contains=function(){return false};Sizzle.isXML=function(elem){var documentElement=(elem?elem.ownerDocument||elem:0).documentElement;return documentElement?documentElement.nodeName!=="HTML":false};var posProcess=
function(selector,context){var match,tmpSet=[],later="",root=context.nodeType?[context]:context;while(match=Expr.match.PSEUDO.exec(selector)){later+=match[0];selector=selector.replace(Expr.match.PSEUDO,"")}selector=Expr.relative[selector]?selector+"*":selector;for(var i=0,l=root.length;i<l;i++)Sizzle(selector,root[i],tmpSet);return Sizzle.filter(later,tmpSet)};jQuery.find=Sizzle;jQuery.expr=Sizzle.selectors;jQuery.expr[":"]=jQuery.expr.filters;jQuery.unique=Sizzle.uniqueSort;jQuery.text=Sizzle.getText;
jQuery.isXMLDoc=Sizzle.isXML;jQuery.contains=Sizzle.contains})();var runtil=/Until$/,rparentsprev=/^(?:parents|prevUntil|prevAll)/,rmultiselector=/,/,isSimple=/^.[^:#\[\.,]*$/,slice=Array.prototype.slice,POS=jQuery.expr.match.POS,guaranteedUnique={children:true,contents:true,next:true,prev:true};jQuery.fn.extend({find:function(selector){var self=this,i,l;if(typeof selector!=="string")return jQuery(selector).filter(function(){for(i=0,l=self.length;i<l;i++)if(jQuery.contains(self[i],this))return true});
var ret=this.pushStack("","find",selector),length,n,r;for(i=0,l=this.length;i<l;i++){length=ret.length;jQuery.find(selector,this[i],ret);if(i>0)for(n=length;n<ret.length;n++)for(r=0;r<length;r++)if(ret[r]===ret[n]){ret.splice(n--,1);break}}return ret},has:function(target){var targets=jQuery(target);return this.filter(function(){for(var i=0,l=targets.length;i<l;i++)if(jQuery.contains(this,targets[i]))return true})},not:function(selector){return this.pushStack(winnow(this,selector,false),"not",selector)},
filter:function(selector){return this.pushStack(winnow(this,selector,true),"filter",selector)},is:function(selector){return!!selector&&(typeof selector==="string"?jQuery.filter(selector,this).length>0:this.filter(selector).length>0)},closest:function(selectors,context){var ret=[],i,l,cur=this[0];if(jQuery.isArray(selectors)){var match,selector,matches={},level=1;if(cur&&selectors.length){for(i=0,l=selectors.length;i<l;i++){selector=selectors[i];if(!matches[selector])matches[selector]=POS.test(selector)?
jQuery(selector,context||this.context):selector}while(cur&&cur.ownerDocument&&cur!==context){for(selector in matches){match=matches[selector];if(match.jquery?match.index(cur)>-1:jQuery(cur).is(match))ret.push({selector:selector,elem:cur,level:level})}cur=cur.parentNode;level++}}return ret}var pos=POS.test(selectors)||typeof selectors!=="string"?jQuery(selectors,context||this.context):0;for(i=0,l=this.length;i<l;i++){cur=this[i];while(cur)if(pos?pos.index(cur)>-1:jQuery.find.matchesSelector(cur,selectors)){ret.push(cur);
break}else{cur=cur.parentNode;if(!cur||!cur.ownerDocument||cur===context||cur.nodeType===11)break}}ret=ret.length>1?jQuery.unique(ret):ret;return this.pushStack(ret,"closest",selectors)},index:function(elem){if(!elem||typeof elem==="string")return jQuery.inArray(this[0],elem?jQuery(elem):this.parent().children());return jQuery.inArray(elem.jquery?elem[0]:elem,this)},add:function(selector,context){var set=typeof selector==="string"?jQuery(selector,context):jQuery.makeArray(selector&&selector.nodeType?
[selector]:selector),all=jQuery.merge(this.get(),set);return this.pushStack(isDisconnected(set[0])||isDisconnected(all[0])?all:jQuery.unique(all))},andSelf:function(){return this.add(this.prevObject)}});function isDisconnected(node){return!node||!node.parentNode||node.parentNode.nodeType===11}jQuery.each({parent:function(elem){var parent=elem.parentNode;return parent&&parent.nodeType!==11?parent:null},parents:function(elem){return jQuery.dir(elem,"parentNode")},parentsUntil:function(elem,i,until){return jQuery.dir(elem,
"parentNode",until)},next:function(elem){return jQuery.nth(elem,2,"nextSibling")},prev:function(elem){return jQuery.nth(elem,2,"previousSibling")},nextAll:function(elem){return jQuery.dir(elem,"nextSibling")},prevAll:function(elem){return jQuery.dir(elem,"previousSibling")},nextUntil:function(elem,i,until){return jQuery.dir(elem,"nextSibling",until)},prevUntil:function(elem,i,until){return jQuery.dir(elem,"previousSibling",until)},siblings:function(elem){return jQuery.sibling(elem.parentNode.firstChild,
elem)},children:function(elem){return jQuery.sibling(elem.firstChild)},contents:function(elem){return jQuery.nodeName(elem,"iframe")?elem.contentDocument||elem.contentWindow.document:jQuery.makeArray(elem.childNodes)}},function(name,fn){jQuery.fn[name]=function(until,selector){var ret=jQuery.map(this,fn,until),args=slice.call(arguments);if(!runtil.test(name))selector=until;if(selector&&typeof selector==="string")ret=jQuery.filter(selector,ret);ret=this.length>1&&!guaranteedUnique[name]?jQuery.unique(ret):
ret;if((this.length>1||rmultiselector.test(selector))&&rparentsprev.test(name))ret=ret.reverse();return this.pushStack(ret,name,args.join(","))}});jQuery.extend({filter:function(expr,elems,not){if(not)expr=":not("+expr+")";return elems.length===1?jQuery.find.matchesSelector(elems[0],expr)?[elems[0]]:[]:jQuery.find.matches(expr,elems)},dir:function(elem,dir,until){var matched=[],cur=elem[dir];while(cur&&cur.nodeType!==9&&(until===undefined||cur.nodeType!==1||!jQuery(cur).is(until))){if(cur.nodeType===
1)matched.push(cur);cur=cur[dir]}return matched},nth:function(cur,result,dir,elem){result=result||1;var num=0;for(;cur;cur=cur[dir])if(cur.nodeType===1&&++num===result)break;return cur},sibling:function(n,elem){var r=[];for(;n;n=n.nextSibling)if(n.nodeType===1&&n!==elem)r.push(n);return r}});function winnow(elements,qualifier,keep){qualifier=qualifier||0;if(jQuery.isFunction(qualifier))return jQuery.grep(elements,function(elem,i){var retVal=!!qualifier.call(elem,i,elem);return retVal===keep});else if(qualifier.nodeType)return jQuery.grep(elements,
function(elem,i){return elem===qualifier===keep});else if(typeof qualifier==="string"){var filtered=jQuery.grep(elements,function(elem){return elem.nodeType===1});if(isSimple.test(qualifier))return jQuery.filter(qualifier,filtered,!keep);else qualifier=jQuery.filter(qualifier,filtered)}return jQuery.grep(elements,function(elem,i){return jQuery.inArray(elem,qualifier)>=0===keep})}var rinlinejQuery=/ jQuery\d+="(?:\d+|null)"/g,rleadingWhitespace=/^\s+/,rxhtmlTag=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/ig,
rtagName=/<([\w:]+)/,rtbody=/<tbody/i,rhtml=/<|&#?\w+;/,rnocache=/<(?:script|object|embed|option|style)/i,rchecked=/checked\s*(?:[^=]|=\s*.checked.)/i,rscriptType=/\/(java|ecma)script/i,rcleanScript=/^\s*<!(?:\[CDATA\[|\-\-)/,wrapMap={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],
area:[1,"<map>","</map>"],_default:[0,"",""]};wrapMap.optgroup=wrapMap.option;wrapMap.tbody=wrapMap.tfoot=wrapMap.colgroup=wrapMap.caption=wrapMap.thead;wrapMap.th=wrapMap.td;if(!jQuery.support.htmlSerialize)wrapMap._default=[1,"div<div>","</div>"];jQuery.fn.extend({text:function(text){if(jQuery.isFunction(text))return this.each(function(i){var self=jQuery(this);self.text(text.call(this,i,self.text()))});if(typeof text!=="object"&&text!==undefined)return this.empty().append((this[0]&&this[0].ownerDocument||
document).createTextNode(text));return jQuery.text(this)},wrapAll:function(html){if(jQuery.isFunction(html))return this.each(function(i){jQuery(this).wrapAll(html.call(this,i))});if(this[0]){var wrap=jQuery(html,this[0].ownerDocument).eq(0).clone(true);if(this[0].parentNode)wrap.insertBefore(this[0]);wrap.map(function(){var elem=this;while(elem.firstChild&&elem.firstChild.nodeType===1)elem=elem.firstChild;return elem}).append(this)}return this},wrapInner:function(html){if(jQuery.isFunction(html))return this.each(function(i){jQuery(this).wrapInner(html.call(this,
i))});return this.each(function(){var self=jQuery(this),contents=self.contents();if(contents.length)contents.wrapAll(html);else self.append(html)})},wrap:function(html){return this.each(function(){jQuery(this).wrapAll(html)})},unwrap:function(){return this.parent().each(function(){if(!jQuery.nodeName(this,"body"))jQuery(this).replaceWith(this.childNodes)}).end()},append:function(){return this.domManip(arguments,true,function(elem){if(this.nodeType===1)this.appendChild(elem)})},prepend:function(){return this.domManip(arguments,
true,function(elem){if(this.nodeType===1)this.insertBefore(elem,this.firstChild)})},before:function(){if(this[0]&&this[0].parentNode)return this.domManip(arguments,false,function(elem){this.parentNode.insertBefore(elem,this)});else if(arguments.length){var set=jQuery(arguments[0]);set.push.apply(set,this.toArray());return this.pushStack(set,"before",arguments)}},after:function(){if(this[0]&&this[0].parentNode)return this.domManip(arguments,false,function(elem){this.parentNode.insertBefore(elem,this.nextSibling)});
else if(arguments.length){var set=this.pushStack(this,"after",arguments);set.push.apply(set,jQuery(arguments[0]).toArray());return set}},remove:function(selector,keepData){for(var i=0,elem;(elem=this[i])!=null;i++)if(!selector||jQuery.filter(selector,[elem]).length){if(!keepData&&elem.nodeType===1){jQuery.cleanData(elem.getElementsByTagName("*"));jQuery.cleanData([elem])}if(elem.parentNode)elem.parentNode.removeChild(elem)}return this},empty:function(){for(var i=0,elem;(elem=this[i])!=null;i++){if(elem.nodeType===
1)jQuery.cleanData(elem.getElementsByTagName("*"));while(elem.firstChild)elem.removeChild(elem.firstChild)}return this},clone:function(dataAndEvents,deepDataAndEvents){dataAndEvents=dataAndEvents==null?false:dataAndEvents;deepDataAndEvents=deepDataAndEvents==null?dataAndEvents:deepDataAndEvents;return this.map(function(){return jQuery.clone(this,dataAndEvents,deepDataAndEvents)})},html:function(value){if(value===undefined)return this[0]&&this[0].nodeType===1?this[0].innerHTML.replace(rinlinejQuery,
""):null;else if(typeof value==="string"&&!rnocache.test(value)&&(jQuery.support.leadingWhitespace||!rleadingWhitespace.test(value))&&!wrapMap[(rtagName.exec(value)||["",""])[1].toLowerCase()]){value=value.replace(rxhtmlTag,"<$1></$2>");try{for(var i=0,l=this.length;i<l;i++)if(this[i].nodeType===1){jQuery.cleanData(this[i].getElementsByTagName("*"));this[i].innerHTML=value}}catch(e){this.empty().append(value)}}else if(jQuery.isFunction(value))this.each(function(i){var self=jQuery(this);self.html(value.call(this,
i,self.html()))});else this.empty().append(value);return this},replaceWith:function(value){if(this[0]&&this[0].parentNode){if(jQuery.isFunction(value))return this.each(function(i){var self=jQuery(this),old=self.html();self.replaceWith(value.call(this,i,old))});if(typeof value!=="string")value=jQuery(value).detach();return this.each(function(){var next=this.nextSibling,parent=this.parentNode;jQuery(this).remove();if(next)jQuery(next).before(value);else jQuery(parent).append(value)})}else return this.length?
this.pushStack(jQuery(jQuery.isFunction(value)?value():value),"replaceWith",value):this},detach:function(selector){return this.remove(selector,true)},domManip:function(args,table,callback){var results,first,fragment,parent,value=args[0],scripts=[];if(!jQuery.support.checkClone&&arguments.length===3&&typeof value==="string"&&rchecked.test(value))return this.each(function(){jQuery(this).domManip(args,table,callback,true)});if(jQuery.isFunction(value))return this.each(function(i){var self=jQuery(this);
args[0]=value.call(this,i,table?self.html():undefined);self.domManip(args,table,callback)});if(this[0]){parent=value&&value.parentNode;if(jQuery.support.parentNode&&parent&&parent.nodeType===11&&parent.childNodes.length===this.length)results={fragment:parent};else results=jQuery.buildFragment(args,this,scripts);fragment=results.fragment;if(fragment.childNodes.length===1)first=fragment=fragment.firstChild;else first=fragment.firstChild;if(first){table=table&&jQuery.nodeName(first,"tr");for(var i=0,
l=this.length,lastIndex=l-1;i<l;i++)callback.call(table?root(this[i],first):this[i],results.cacheable||l>1&&i<lastIndex?jQuery.clone(fragment,true,true):fragment)}if(scripts.length)jQuery.each(scripts,evalScript)}return this}});function root(elem,cur){return jQuery.nodeName(elem,"table")?elem.getElementsByTagName("tbody")[0]||elem.appendChild(elem.ownerDocument.createElement("tbody")):elem}function cloneCopyEvent(src,dest){if(dest.nodeType!==1||!jQuery.hasData(src))return;var internalKey=jQuery.expando,
oldData=jQuery.data(src),curData=jQuery.data(dest,oldData);if(oldData=oldData[internalKey]){var events=oldData.events;curData=curData[internalKey]=jQuery.extend({},oldData);if(events){delete curData.handle;curData.events={};for(var type in events)for(var i=0,l=events[type].length;i<l;i++)jQuery.event.add(dest,type+(events[type][i].namespace?".":"")+events[type][i].namespace,events[type][i],events[type][i].data)}}}function cloneFixAttributes(src,dest){var nodeName;if(dest.nodeType!==1)return;if(dest.clearAttributes)dest.clearAttributes();
if(dest.mergeAttributes)dest.mergeAttributes(src);nodeName=dest.nodeName.toLowerCase();if(nodeName==="object")dest.outerHTML=src.outerHTML;else if(nodeName==="input"&&(src.type==="checkbox"||src.type==="radio")){if(src.checked)dest.defaultChecked=dest.checked=src.checked;if(dest.value!==src.value)dest.value=src.value}else if(nodeName==="option")dest.selected=src.defaultSelected;else if(nodeName==="input"||nodeName==="textarea")dest.defaultValue=src.defaultValue;dest.removeAttribute(jQuery.expando)}
jQuery.buildFragment=function(args,nodes,scripts){var fragment,cacheable,cacheresults,doc;if(nodes&&nodes[0])doc=nodes[0].ownerDocument||nodes[0];if(!doc.createDocumentFragment)doc=document;if(args.length===1&&typeof args[0]==="string"&&args[0].length<512&&doc===document&&args[0].charAt(0)==="<"&&!rnocache.test(args[0])&&(jQuery.support.checkClone||!rchecked.test(args[0]))){cacheable=true;cacheresults=jQuery.fragments[args[0]];if(cacheresults&&cacheresults!==1)fragment=cacheresults}if(!fragment){fragment=
doc.createDocumentFragment();jQuery.clean(args,doc,fragment,scripts)}if(cacheable)jQuery.fragments[args[0]]=cacheresults?fragment:1;return{fragment:fragment,cacheable:cacheable}};jQuery.fragments={};jQuery.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(name,original){jQuery.fn[name]=function(selector){var ret=[],insert=jQuery(selector),parent=this.length===1&&this[0].parentNode;if(parent&&parent.nodeType===11&&parent.childNodes.length===
1&&insert.length===1){insert[original](this[0]);return this}else{for(var i=0,l=insert.length;i<l;i++){var elems=(i>0?this.clone(true):this).get();jQuery(insert[i])[original](elems);ret=ret.concat(elems)}return this.pushStack(ret,name,insert.selector)}}});function getAll(elem){if("getElementsByTagName"in elem)return elem.getElementsByTagName("*");else if("querySelectorAll"in elem)return elem.querySelectorAll("*");else return[]}function fixDefaultChecked(elem){if(elem.type==="checkbox"||elem.type===
"radio")elem.defaultChecked=elem.checked}function findInputs(elem){if(jQuery.nodeName(elem,"input"))fixDefaultChecked(elem);else if("getElementsByTagName"in elem)jQuery.grep(elem.getElementsByTagName("input"),fixDefaultChecked)}jQuery.extend({clone:function(elem,dataAndEvents,deepDataAndEvents){var clone=elem.cloneNode(true),srcElements,destElements,i;if((!jQuery.support.noCloneEvent||!jQuery.support.noCloneChecked)&&(elem.nodeType===1||elem.nodeType===11)&&!jQuery.isXMLDoc(elem)){cloneFixAttributes(elem,
clone);srcElements=getAll(elem);destElements=getAll(clone);for(i=0;srcElements[i];++i)cloneFixAttributes(srcElements[i],destElements[i])}if(dataAndEvents){cloneCopyEvent(elem,clone);if(deepDataAndEvents){srcElements=getAll(elem);destElements=getAll(clone);for(i=0;srcElements[i];++i)cloneCopyEvent(srcElements[i],destElements[i])}}srcElements=destElements=null;return clone},clean:function(elems,context,fragment,scripts){var checkScriptType;context=context||document;if(typeof context.createElement===
"undefined")context=context.ownerDocument||context[0]&&context[0].ownerDocument||document;var ret=[],j;for(var i=0,elem;(elem=elems[i])!=null;i++){if(typeof elem==="number")elem+="";if(!elem)continue;if(typeof elem==="string")if(!rhtml.test(elem))elem=context.createTextNode(elem);else{elem=elem.replace(rxhtmlTag,"<$1></$2>");var tag=(rtagName.exec(elem)||["",""])[1].toLowerCase(),wrap=wrapMap[tag]||wrapMap._default,depth=wrap[0],div=context.createElement("div");div.innerHTML=wrap[1]+elem+wrap[2];
while(depth--)div=div.lastChild;if(!jQuery.support.tbody){var hasBody=rtbody.test(elem),tbody=tag==="table"&&!hasBody?div.firstChild&&div.firstChild.childNodes:wrap[1]==="<table>"&&!hasBody?div.childNodes:[];for(j=tbody.length-1;j>=0;--j)if(jQuery.nodeName(tbody[j],"tbody")&&!tbody[j].childNodes.length)tbody[j].parentNode.removeChild(tbody[j])}if(!jQuery.support.leadingWhitespace&&rleadingWhitespace.test(elem))div.insertBefore(context.createTextNode(rleadingWhitespace.exec(elem)[0]),div.firstChild);
elem=div.childNodes}var len;if(!jQuery.support.appendChecked)if(elem[0]&&typeof(len=elem.length)==="number")for(j=0;j<len;j++)findInputs(elem[j]);else findInputs(elem);if(elem.nodeType)ret.push(elem);else ret=jQuery.merge(ret,elem)}if(fragment){checkScriptType=function(elem){return!elem.type||rscriptType.test(elem.type)};for(i=0;ret[i];i++)if(scripts&&jQuery.nodeName(ret[i],"script")&&(!ret[i].type||ret[i].type.toLowerCase()==="text/javascript"))scripts.push(ret[i].parentNode?ret[i].parentNode.removeChild(ret[i]):
ret[i]);else{if(ret[i].nodeType===1){var jsTags=jQuery.grep(ret[i].getElementsByTagName("script"),checkScriptType);ret.splice.apply(ret,[i+1,0].concat(jsTags))}fragment.appendChild(ret[i])}}return ret},cleanData:function(elems){var data,id,cache=jQuery.cache,internalKey=jQuery.expando,special=jQuery.event.special,deleteExpando=jQuery.support.deleteExpando;for(var i=0,elem;(elem=elems[i])!=null;i++){if(elem.nodeName&&jQuery.noData[elem.nodeName.toLowerCase()])continue;id=elem[jQuery.expando];if(id){data=
cache[id]&&cache[id][internalKey];if(data&&data.events){for(var type in data.events)if(special[type])jQuery.event.remove(elem,type);else jQuery.removeEvent(elem,type,data.handle);if(data.handle)data.handle.elem=null}if(deleteExpando)delete elem[jQuery.expando];else if(elem.removeAttribute)elem.removeAttribute(jQuery.expando);delete cache[id]}}}});function evalScript(i,elem){if(elem.src)jQuery.ajax({url:elem.src,async:false,dataType:"script"});else jQuery.globalEval((elem.text||elem.textContent||elem.innerHTML||
"").replace(rcleanScript,"/*$0*/"));if(elem.parentNode)elem.parentNode.removeChild(elem)}var ralpha=/alpha\([^)]*\)/i,ropacity=/opacity=([^)]*)/,rupper=/([A-Z]|^ms)/g,rnumpx=/^-?\d+(?:px)?$/i,rnum=/^-?\d/,rrelNum=/^[+\-]=/,rrelNumFilter=/[^+\-\.\de]+/g,cssShow={position:"absolute",visibility:"hidden",display:"block"},cssWidth=["Left","Right"],cssHeight=["Top","Bottom"],curCSS,getComputedStyle,currentStyle;jQuery.fn.css=function(name,value){if(arguments.length===2&&value===undefined)return this;return jQuery.access(this,
name,value,true,function(elem,name,value){return value!==undefined?jQuery.style(elem,name,value):jQuery.css(elem,name)})};jQuery.extend({cssHooks:{opacity:{get:function(elem,computed){if(computed){var ret=curCSS(elem,"opacity","opacity");return ret===""?"1":ret}else return elem.style.opacity}}},cssNumber:{"fillOpacity":true,"fontWeight":true,"lineHeight":true,"opacity":true,"orphans":true,"widows":true,"zIndex":true,"zoom":true},cssProps:{"float":jQuery.support.cssFloat?"cssFloat":"styleFloat"},style:function(elem,
name,value,extra){if(!elem||elem.nodeType===3||elem.nodeType===8||!elem.style)return;var ret,type,origName=jQuery.camelCase(name),style=elem.style,hooks=jQuery.cssHooks[origName];name=jQuery.cssProps[origName]||origName;if(value!==undefined){type=typeof value;if(type==="number"&&isNaN(value)||value==null)return;if(type==="string"&&rrelNum.test(value)){value=+value.replace(rrelNumFilter,"")+parseFloat(jQuery.css(elem,name));type="number"}if(type==="number"&&!jQuery.cssNumber[origName])value+="px";
if(!hooks||!("set"in hooks)||(value=hooks.set(elem,value))!==undefined)try{style[name]=value}catch(e){}}else{if(hooks&&"get"in hooks&&(ret=hooks.get(elem,false,extra))!==undefined)return ret;return style[name]}},css:function(elem,name,extra){var ret,hooks;name=jQuery.camelCase(name);hooks=jQuery.cssHooks[name];name=jQuery.cssProps[name]||name;if(name==="cssFloat")name="float";if(hooks&&"get"in hooks&&(ret=hooks.get(elem,true,extra))!==undefined)return ret;else if(curCSS)return curCSS(elem,name)},
swap:function(elem,options,callback){var old={};for(var name in options){old[name]=elem.style[name];elem.style[name]=options[name]}callback.call(elem);for(name in options)elem.style[name]=old[name]}});jQuery.curCSS=jQuery.css;jQuery.each(["height","width"],function(i,name){jQuery.cssHooks[name]={get:function(elem,computed,extra){var val;if(computed){if(elem.offsetWidth!==0)return getWH(elem,name,extra);else jQuery.swap(elem,cssShow,function(){val=getWH(elem,name,extra)});return val}},set:function(elem,
value){if(rnumpx.test(value)){value=parseFloat(value);if(value>=0)return value+"px"}else return value}}});if(!jQuery.support.opacity)jQuery.cssHooks.opacity={get:function(elem,computed){return ropacity.test((computed&&elem.currentStyle?elem.currentStyle.filter:elem.style.filter)||"")?parseFloat(RegExp.$1)/100+"":computed?"1":""},set:function(elem,value){var style=elem.style,currentStyle=elem.currentStyle;style.zoom=1;var opacity=jQuery.isNaN(value)?"":"alpha(opacity="+value*100+")",filter=currentStyle&&
currentStyle.filter||style.filter||"";style.filter=ralpha.test(filter)?filter.replace(ralpha,opacity):filter+" "+opacity}};jQuery(function(){if(!jQuery.support.reliableMarginRight)jQuery.cssHooks.marginRight={get:function(elem,computed){var ret;jQuery.swap(elem,{"display":"inline-block"},function(){if(computed)ret=curCSS(elem,"margin-right","marginRight");else ret=elem.style.marginRight});return ret}}});if(document.defaultView&&document.defaultView.getComputedStyle)getComputedStyle=function(elem,
name){var ret,defaultView,computedStyle;name=name.replace(rupper,"-$1").toLowerCase();if(!(defaultView=elem.ownerDocument.defaultView))return undefined;if(computedStyle=defaultView.getComputedStyle(elem,null)){ret=computedStyle.getPropertyValue(name);if(ret===""&&!jQuery.contains(elem.ownerDocument.documentElement,elem))ret=jQuery.style(elem,name)}return ret};if(document.documentElement.currentStyle)currentStyle=function(elem,name){var left,ret=elem.currentStyle&&elem.currentStyle[name],rsLeft=elem.runtimeStyle&&
elem.runtimeStyle[name],style=elem.style;if(!rnumpx.test(ret)&&rnum.test(ret)){left=style.left;if(rsLeft)elem.runtimeStyle.left=elem.currentStyle.left;style.left=name==="fontSize"?"1em":ret||0;ret=style.pixelLeft+"px";style.left=left;if(rsLeft)elem.runtimeStyle.left=rsLeft}return ret===""?"auto":ret};curCSS=getComputedStyle||currentStyle;function getWH(elem,name,extra){var val=name==="width"?elem.offsetWidth:elem.offsetHeight,which=name==="width"?cssWidth:cssHeight;if(val>0){if(extra!=="border")jQuery.each(which,
function(){if(!extra)val-=parseFloat(jQuery.css(elem,"padding"+this))||0;if(extra==="margin")val+=parseFloat(jQuery.css(elem,extra+this))||0;else val-=parseFloat(jQuery.css(elem,"border"+this+"Width"))||0});return val+"px"}val=curCSS(elem,name,name);if(val<0||val==null)val=elem.style[name]||0;val=parseFloat(val)||0;if(extra)jQuery.each(which,function(){val+=parseFloat(jQuery.css(elem,"padding"+this))||0;if(extra!=="padding")val+=parseFloat(jQuery.css(elem,"border"+this+"Width"))||0;if(extra==="margin")val+=
parseFloat(jQuery.css(elem,extra+this))||0});return val+"px"}if(jQuery.expr&&jQuery.expr.filters){jQuery.expr.filters.hidden=function(elem){var width=elem.offsetWidth,height=elem.offsetHeight;return width===0&&height===0||!jQuery.support.reliableHiddenOffsets&&(elem.style.display||jQuery.css(elem,"display"))==="none"};jQuery.expr.filters.visible=function(elem){return!jQuery.expr.filters.hidden(elem)}}var r20=/%20/g,rbracket=/\[\]$/,rCRLF=/\r?\n/g,rhash=/#.*$/,rheaders=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,
rinput=/^(?:color|date|datetime|email|hidden|month|number|password|range|search|tel|text|time|url|week)$/i,rlocalProtocol=/^(?:about|app|app\-storage|.+\-extension|file|widget):$/,rnoContent=/^(?:GET|HEAD)$/,rprotocol=/^\/\//,rquery=/\?/,rscript=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,rselectTextarea=/^(?:select|textarea)/i,rspacesAjax=/\s+/,rts=/([?&])_=[^&]*/,rurl=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/,_load=jQuery.fn.load,prefilters={},transports={},ajaxLocation,ajaxLocParts;
try{ajaxLocation=location.href}catch(e){ajaxLocation=document.createElement("a");ajaxLocation.href="";ajaxLocation=ajaxLocation.href}ajaxLocParts=rurl.exec(ajaxLocation.toLowerCase())||[];function addToPrefiltersOrTransports(structure){return function(dataTypeExpression,func){if(typeof dataTypeExpression!=="string"){func=dataTypeExpression;dataTypeExpression="*"}if(jQuery.isFunction(func)){var dataTypes=dataTypeExpression.toLowerCase().split(rspacesAjax),i=0,length=dataTypes.length,dataType,list,
placeBefore;for(;i<length;i++){dataType=dataTypes[i];placeBefore=/^\+/.test(dataType);if(placeBefore)dataType=dataType.substr(1)||"*";list=structure[dataType]=structure[dataType]||[];list[placeBefore?"unshift":"push"](func)}}}}function inspectPrefiltersOrTransports(structure,options,originalOptions,jqXHR,dataType,inspected){dataType=dataType||options.dataTypes[0];inspected=inspected||{};inspected[dataType]=true;var list=structure[dataType],i=0,length=list?list.length:0,executeOnly=structure===prefilters,
selection;for(;i<length&&(executeOnly||!selection);i++){selection=list[i](options,originalOptions,jqXHR);if(typeof selection==="string")if(!executeOnly||inspected[selection])selection=undefined;else{options.dataTypes.unshift(selection);selection=inspectPrefiltersOrTransports(structure,options,originalOptions,jqXHR,selection,inspected)}}if((executeOnly||!selection)&&!inspected["*"])selection=inspectPrefiltersOrTransports(structure,options,originalOptions,jqXHR,"*",inspected);return selection}jQuery.fn.extend({load:function(url,
params,callback){if(typeof url!=="string"&&_load)return _load.apply(this,arguments);else if(!this.length)return this;var off=url.indexOf(" ");if(off>=0){var selector=url.slice(off,url.length);url=url.slice(0,off)}var type="GET";if(params)if(jQuery.isFunction(params)){callback=params;params=undefined}else if(typeof params==="object"){params=jQuery.param(params,jQuery.ajaxSettings.traditional);type="POST"}var self=this;jQuery.ajax({url:url,type:type,dataType:"html",data:params,complete:function(jqXHR,
status,responseText){responseText=jqXHR.responseText;if(jqXHR.isResolved()){jqXHR.done(function(r){responseText=r});self.html(selector?jQuery("<div>").append(responseText.replace(rscript,"")).find(selector):responseText)}if(callback)self.each(callback,[responseText,status,jqXHR])}});return this},serialize:function(){return jQuery.param(this.serializeArray())},serializeArray:function(){return this.map(function(){return this.elements?jQuery.makeArray(this.elements):this}).filter(function(){return this.name&&
!this.disabled&&(this.checked||rselectTextarea.test(this.nodeName)||rinput.test(this.type))}).map(function(i,elem){var val=jQuery(this).val();return val==null?null:jQuery.isArray(val)?jQuery.map(val,function(val,i){return{name:elem.name,value:val.replace(rCRLF,"\r\n")}}):{name:elem.name,value:val.replace(rCRLF,"\r\n")}}).get()}});jQuery.each("ajaxStart ajaxStop ajaxComplete ajaxError ajaxSuccess ajaxSend".split(" "),function(i,o){jQuery.fn[o]=function(f){return this.bind(o,f)}});jQuery.each(["get",
"post"],function(i,method){jQuery[method]=function(url,data,callback,type){if(jQuery.isFunction(data)){type=type||callback;callback=data;data=undefined}return jQuery.ajax({type:method,url:url,data:data,success:callback,dataType:type})}});jQuery.extend({getScript:function(url,callback){return jQuery.get(url,undefined,callback,"script")},getJSON:function(url,data,callback){return jQuery.get(url,data,callback,"json")},ajaxSetup:function(target,settings){if(!settings){settings=target;target=jQuery.extend(true,
jQuery.ajaxSettings,settings)}else jQuery.extend(true,target,jQuery.ajaxSettings,settings);for(var field in{context:1,url:1})if(field in settings)target[field]=settings[field];else if(field in jQuery.ajaxSettings)target[field]=jQuery.ajaxSettings[field];return target},ajaxSettings:{url:ajaxLocation,isLocal:rlocalProtocol.test(ajaxLocParts[1]),global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,accepts:{xml:"application/xml, text/xml",html:"text/html",
text:"text/plain",json:"application/json, text/javascript","*":"*/*"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText"},converters:{"* text":window.String,"text html":true,"text json":jQuery.parseJSON,"text xml":jQuery.parseXML}},ajaxPrefilter:addToPrefiltersOrTransports(prefilters),ajaxTransport:addToPrefiltersOrTransports(transports),ajax:function(url,options){if(typeof url==="object"){options=url;url=undefined}options=options||{};var s=jQuery.ajaxSetup({},
options),callbackContext=s.context||s,globalEventContext=callbackContext!==s&&(callbackContext.nodeType||callbackContext instanceof jQuery)?jQuery(callbackContext):jQuery.event,deferred=jQuery.Deferred(),completeDeferred=jQuery._Deferred(),statusCode=s.statusCode||{},ifModifiedKey,requestHeaders={},requestHeadersNames={},responseHeadersString,responseHeaders,transport,timeoutTimer,parts,state=0,fireGlobals,i,jqXHR={readyState:0,setRequestHeader:function(name,value){if(!state){var lname=name.toLowerCase();
name=requestHeadersNames[lname]=requestHeadersNames[lname]||name;requestHeaders[name]=value}return this},getAllResponseHeaders:function(){return state===2?responseHeadersString:null},getResponseHeader:function(key){var match;if(state===2){if(!responseHeaders){responseHeaders={};while(match=rheaders.exec(responseHeadersString))responseHeaders[match[1].toLowerCase()]=match[2]}match=responseHeaders[key.toLowerCase()]}return match===undefined?null:match},overrideMimeType:function(type){if(!state)s.mimeType=
type;return this},abort:function(statusText){statusText=statusText||"abort";if(transport)transport.abort(statusText);done(0,statusText);return this}};function done(status,statusText,responses,headers){if(state===2)return;state=2;if(timeoutTimer)clearTimeout(timeoutTimer);transport=undefined;responseHeadersString=headers||"";jqXHR.readyState=status?4:0;var isSuccess,success,error,response=responses?ajaxHandleResponses(s,jqXHR,responses):undefined,lastModified,etag;if(status>=200&&status<300||status===
304){if(s.ifModified){if(lastModified=jqXHR.getResponseHeader("Last-Modified"))jQuery.lastModified[ifModifiedKey]=lastModified;if(etag=jqXHR.getResponseHeader("Etag"))jQuery.etag[ifModifiedKey]=etag}if(status===304){statusText="notmodified";isSuccess=true}else try{success=ajaxConvert(s,response);statusText="success";isSuccess=true}catch(e){statusText="parsererror";error=e}}else{error=statusText;if(!statusText||status){statusText="error";if(status<0)status=0}}jqXHR.status=status;jqXHR.statusText=statusText;
if(isSuccess)deferred.resolveWith(callbackContext,[success,statusText,jqXHR]);else deferred.rejectWith(callbackContext,[jqXHR,statusText,error]);jqXHR.statusCode(statusCode);statusCode=undefined;if(fireGlobals)globalEventContext.trigger("ajax"+(isSuccess?"Success":"Error"),[jqXHR,s,isSuccess?success:error]);completeDeferred.resolveWith(callbackContext,[jqXHR,statusText]);if(fireGlobals){globalEventContext.trigger("ajaxComplete",[jqXHR,s]);if(!--jQuery.active)jQuery.event.trigger("ajaxStop")}}deferred.promise(jqXHR);
jqXHR.success=jqXHR.done;jqXHR.error=jqXHR.fail;jqXHR.complete=completeDeferred.done;jqXHR.statusCode=function(map){if(map){var tmp;if(state<2)for(tmp in map)statusCode[tmp]=[statusCode[tmp],map[tmp]];else{tmp=map[jqXHR.status];jqXHR.then(tmp,tmp)}}return this};s.url=((url||s.url)+"").replace(rhash,"").replace(rprotocol,ajaxLocParts[1]+"//");s.dataTypes=jQuery.trim(s.dataType||"*").toLowerCase().split(rspacesAjax);if(s.crossDomain==null){parts=rurl.exec(s.url.toLowerCase());s.crossDomain=!!(parts&&
(parts[1]!=ajaxLocParts[1]||parts[2]!=ajaxLocParts[2]||(parts[3]||(parts[1]==="http:"?80:443))!=(ajaxLocParts[3]||(ajaxLocParts[1]==="http:"?80:443))))}if(s.data&&s.processData&&typeof s.data!=="string")s.data=jQuery.param(s.data,s.traditional);inspectPrefiltersOrTransports(prefilters,s,options,jqXHR);if(state===2)return false;fireGlobals=s.global;s.type=s.type.toUpperCase();s.hasContent=!rnoContent.test(s.type);if(fireGlobals&&jQuery.active++===0)jQuery.event.trigger("ajaxStart");if(!s.hasContent){if(s.data)s.url+=
(rquery.test(s.url)?"&":"?")+s.data;ifModifiedKey=s.url;if(s.cache===false){var ts=jQuery.now(),ret=s.url.replace(rts,"$1_="+ts);s.url=ret+(ret===s.url?(rquery.test(s.url)?"&":"?")+"_="+ts:"")}}if(s.data&&s.hasContent&&s.contentType!==false||options.contentType)jqXHR.setRequestHeader("Content-Type",s.contentType);if(s.ifModified){ifModifiedKey=ifModifiedKey||s.url;if(jQuery.lastModified[ifModifiedKey])jqXHR.setRequestHeader("If-Modified-Since",jQuery.lastModified[ifModifiedKey]);if(jQuery.etag[ifModifiedKey])jqXHR.setRequestHeader("If-None-Match",
jQuery.etag[ifModifiedKey])}jqXHR.setRequestHeader("Accept",s.dataTypes[0]&&s.accepts[s.dataTypes[0]]?s.accepts[s.dataTypes[0]]+(s.dataTypes[0]!=="*"?", */*; q=0.01":""):s.accepts["*"]);for(i in s.headers)jqXHR.setRequestHeader(i,s.headers[i]);if(s.beforeSend&&(s.beforeSend.call(callbackContext,jqXHR,s)===false||state===2)){jqXHR.abort();return false}for(i in{success:1,error:1,complete:1})jqXHR[i](s[i]);transport=inspectPrefiltersOrTransports(transports,s,options,jqXHR);if(!transport)done(-1,"No Transport");
else{jqXHR.readyState=1;if(fireGlobals)globalEventContext.trigger("ajaxSend",[jqXHR,s]);if(s.async&&s.timeout>0)timeoutTimer=setTimeout(function(){jqXHR.abort("timeout")},s.timeout);try{state=1;transport.send(requestHeaders,done)}catch(e){if(status<2)done(-1,e);else jQuery.error(e)}}return jqXHR},param:function(a,traditional){var s=[],add=function(key,value){value=jQuery.isFunction(value)?value():value;s[s.length]=encodeURIComponent(key)+"="+encodeURIComponent(value)};if(traditional===undefined)traditional=
jQuery.ajaxSettings.traditional;if(jQuery.isArray(a)||a.jquery&&!jQuery.isPlainObject(a))jQuery.each(a,function(){add(this.name,this.value)});else for(var prefix in a)buildParams(prefix,a[prefix],traditional,add);return s.join("&").replace(r20,"+")}});function buildParams(prefix,obj,traditional,add){if(jQuery.isArray(obj))jQuery.each(obj,function(i,v){if(traditional||rbracket.test(prefix))add(prefix,v);else buildParams(prefix+"["+(typeof v==="object"||jQuery.isArray(v)?i:"")+"]",v,traditional,add)});
else if(!traditional&&obj!=null&&typeof obj==="object")for(var name in obj)buildParams(prefix+"["+name+"]",obj[name],traditional,add);else add(prefix,obj)}jQuery.extend({active:0,lastModified:{},etag:{}});function ajaxHandleResponses(s,jqXHR,responses){var contents=s.contents,dataTypes=s.dataTypes,responseFields=s.responseFields,ct,type,finalDataType,firstDataType;for(type in responseFields)if(type in responses)jqXHR[responseFields[type]]=responses[type];while(dataTypes[0]==="*"){dataTypes.shift();
if(ct===undefined)ct=s.mimeType||jqXHR.getResponseHeader("content-type")}if(ct)for(type in contents)if(contents[type]&&contents[type].test(ct)){dataTypes.unshift(type);break}if(dataTypes[0]in responses)finalDataType=dataTypes[0];else{for(type in responses){if(!dataTypes[0]||s.converters[type+" "+dataTypes[0]]){finalDataType=type;break}if(!firstDataType)firstDataType=type}finalDataType=finalDataType||firstDataType}if(finalDataType){if(finalDataType!==dataTypes[0])dataTypes.unshift(finalDataType);return responses[finalDataType]}}
function ajaxConvert(s,response){if(s.dataFilter)response=s.dataFilter(response,s.dataType);var dataTypes=s.dataTypes,converters={},i,key,length=dataTypes.length,tmp,current=dataTypes[0],prev,conversion,conv,conv1,conv2;for(i=1;i<length;i++){if(i===1)for(key in s.converters)if(typeof key==="string")converters[key.toLowerCase()]=s.converters[key];prev=current;current=dataTypes[i];if(current==="*")current=prev;else if(prev!=="*"&&prev!==current){conversion=prev+" "+current;conv=converters[conversion]||
converters["* "+current];if(!conv){conv2=undefined;for(conv1 in converters){tmp=conv1.split(" ");if(tmp[0]===prev||tmp[0]==="*"){conv2=converters[tmp[1]+" "+current];if(conv2){conv1=converters[conv1];if(conv1===true)conv=conv2;else if(conv2===true)conv=conv1;break}}}}if(!(conv||conv2))jQuery.error("No conversion from "+conversion.replace(" "," to "));if(conv!==true)response=conv?conv(response):conv2(conv1(response))}}return response}var jsc=jQuery.now(),jsre=/(\=)\?(&|$)|\?\?/i;jQuery.ajaxSetup({jsonp:"callback",
jsonpCallback:function(){return jQuery.expando+"_"+jsc++}});jQuery.ajaxPrefilter("json jsonp",function(s,originalSettings,jqXHR){var inspectData=s.contentType==="application/x-www-form-urlencoded"&&typeof s.data==="string";if(s.dataTypes[0]==="jsonp"||s.jsonp!==false&&(jsre.test(s.url)||inspectData&&jsre.test(s.data))){var responseContainer,jsonpCallback=s.jsonpCallback=jQuery.isFunction(s.jsonpCallback)?s.jsonpCallback():s.jsonpCallback,previous=window[jsonpCallback],url=s.url,data=s.data,replace=
"$1"+jsonpCallback+"$2";if(s.jsonp!==false){url=url.replace(jsre,replace);if(s.url===url){if(inspectData)data=data.replace(jsre,replace);if(s.data===data)url+=(/\?/.test(url)?"&":"?")+s.jsonp+"="+jsonpCallback}}s.url=url;s.data=data;window[jsonpCallback]=function(response){responseContainer=[response]};jqXHR.always(function(){window[jsonpCallback]=previous;if(responseContainer&&jQuery.isFunction(previous))window[jsonpCallback](responseContainer[0])});s.converters["script json"]=function(){if(!responseContainer)jQuery.error(jsonpCallback+
" was not called");return responseContainer[0]};s.dataTypes[0]="json";return"script"}});jQuery.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/javascript|ecmascript/},converters:{"text script":function(text){jQuery.globalEval(text);return text}}});jQuery.ajaxPrefilter("script",function(s){if(s.cache===undefined)s.cache=false;if(s.crossDomain){s.type="GET";s.global=false}});jQuery.ajaxTransport("script",function(s){if(s.crossDomain){var script,
head=document.head||document.getElementsByTagName("head")[0]||document.documentElement;return{send:function(_,callback){script=document.createElement("script");script.async="async";if(s.scriptCharset)script.charset=s.scriptCharset;script.src=s.url;script.onload=script.onreadystatechange=function(_,isAbort){if(isAbort||!script.readyState||/loaded|complete/.test(script.readyState)){script.onload=script.onreadystatechange=null;if(head&&script.parentNode)head.removeChild(script);script=undefined;if(!isAbort)callback(200,
"success")}};head.insertBefore(script,head.firstChild)},abort:function(){if(script)script.onload(0,1)}}}});var xhrOnUnloadAbort=window.ActiveXObject?function(){for(var key in xhrCallbacks)xhrCallbacks[key](0,1)}:false,xhrId=0,xhrCallbacks;function createStandardXHR(){try{return new window.XMLHttpRequest}catch(e){}}function createActiveXHR(){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}jQuery.ajaxSettings.xhr=window.ActiveXObject?function(){return!this.isLocal&&createStandardXHR()||
createActiveXHR()}:createStandardXHR;(function(xhr){jQuery.extend(jQuery.support,{ajax:!!xhr,cors:!!xhr&&"withCredentials"in xhr})})(jQuery.ajaxSettings.xhr());if(jQuery.support.ajax)jQuery.ajaxTransport(function(s){if(!s.crossDomain||jQuery.support.cors){var callback;return{send:function(headers,complete){var xhr=s.xhr(),handle,i;if(s.username)xhr.open(s.type,s.url,s.async,s.username,s.password);else xhr.open(s.type,s.url,s.async);if(s.xhrFields)for(i in s.xhrFields)xhr[i]=s.xhrFields[i];if(s.mimeType&&
xhr.overrideMimeType)xhr.overrideMimeType(s.mimeType);if(!s.crossDomain&&!headers["X-Requested-With"])headers["X-Requested-With"]="XMLHttpRequest";try{for(i in headers)xhr.setRequestHeader(i,headers[i])}catch(_){}xhr.send(s.hasContent&&s.data||null);callback=function(_,isAbort){var status,statusText,responseHeaders,responses,xml;try{if(callback&&(isAbort||xhr.readyState===4)){callback=undefined;if(handle){xhr.onreadystatechange=jQuery.noop;if(xhrOnUnloadAbort)delete xhrCallbacks[handle]}if(isAbort){if(xhr.readyState!==
4)xhr.abort()}else{status=xhr.status;responseHeaders=xhr.getAllResponseHeaders();responses={};xml=xhr.responseXML;if(xml&&xml.documentElement)responses.xml=xml;responses.text=xhr.responseText;try{statusText=xhr.statusText}catch(e){statusText=""}if(!status&&s.isLocal&&!s.crossDomain)status=responses.text?200:404;else if(status===1223)status=204}}}catch(firefoxAccessException){if(!isAbort)complete(-1,firefoxAccessException)}if(responses)complete(status,statusText,responses,responseHeaders)};if(!s.async||
xhr.readyState===4)callback();else{handle=++xhrId;if(xhrOnUnloadAbort){if(!xhrCallbacks){xhrCallbacks={};jQuery(window).unload(xhrOnUnloadAbort)}xhrCallbacks[handle]=callback}xhr.onreadystatechange=callback}},abort:function(){if(callback)callback(0,1)}}}});var elemdisplay={},iframe,iframeDoc,rfxtypes=/^(?:toggle|show|hide)$/,rfxnum=/^([+\-]=)?([\d+.\-]+)([a-z%]*)$/i,timerId,fxAttrs=[["height","marginTop","marginBottom","paddingTop","paddingBottom"],["width","marginLeft","marginRight","paddingLeft",
"paddingRight"],["opacity"]],fxNow,requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame;jQuery.fn.extend({show:function(speed,easing,callback){var elem,display;if(speed||speed===0)return this.animate(genFx("show",3),speed,easing,callback);else{for(var i=0,j=this.length;i<j;i++){elem=this[i];if(elem.style){display=elem.style.display;if(!jQuery._data(elem,"olddisplay")&&display==="none")display=elem.style.display="";if(display===""&&
jQuery.css(elem,"display")==="none")jQuery._data(elem,"olddisplay",defaultDisplay(elem.nodeName))}}for(i=0;i<j;i++){elem=this[i];if(elem.style){display=elem.style.display;if(display===""||display==="none")elem.style.display=jQuery._data(elem,"olddisplay")||""}}return this}},hide:function(speed,easing,callback){if(speed||speed===0)return this.animate(genFx("hide",3),speed,easing,callback);else{for(var i=0,j=this.length;i<j;i++)if(this[i].style){var display=jQuery.css(this[i],"display");if(display!==
"none"&&!jQuery._data(this[i],"olddisplay"))jQuery._data(this[i],"olddisplay",display)}for(i=0;i<j;i++)if(this[i].style)this[i].style.display="none";return this}},_toggle:jQuery.fn.toggle,toggle:function(fn,fn2,callback){var bool=typeof fn==="boolean";if(jQuery.isFunction(fn)&&jQuery.isFunction(fn2))this._toggle.apply(this,arguments);else if(fn==null||bool)this.each(function(){var state=bool?fn:jQuery(this).is(":hidden");jQuery(this)[state?"show":"hide"]()});else this.animate(genFx("toggle",3),fn,
fn2,callback);return this},fadeTo:function(speed,to,easing,callback){return this.filter(":hidden").css("opacity",0).show().end().animate({opacity:to},speed,easing,callback)},animate:function(prop,speed,easing,callback){var optall=jQuery.speed(speed,easing,callback);if(jQuery.isEmptyObject(prop))return this.each(optall.complete,[false]);prop=jQuery.extend({},prop);return this[optall.queue===false?"each":"queue"](function(){if(optall.queue===false)jQuery._mark(this);var opt=jQuery.extend({},optall),
isElement=this.nodeType===1,hidden=isElement&&jQuery(this).is(":hidden"),name,val,p,display,e,parts,start,end,unit;opt.animatedProperties={};for(p in prop){name=jQuery.camelCase(p);if(p!==name){prop[name]=prop[p];delete prop[p]}val=prop[name];if(jQuery.isArray(val)){opt.animatedProperties[name]=val[1];val=prop[name]=val[0]}else opt.animatedProperties[name]=opt.specialEasing&&opt.specialEasing[name]||opt.easing||"swing";if(val==="hide"&&hidden||val==="show"&&!hidden)return opt.complete.call(this);
if(isElement&&(name==="height"||name==="width")){opt.overflow=[this.style.overflow,this.style.overflowX,this.style.overflowY];if(jQuery.css(this,"display")==="inline"&&jQuery.css(this,"float")==="none")if(!jQuery.support.inlineBlockNeedsLayout)this.style.display="inline-block";else{display=defaultDisplay(this.nodeName);if(display==="inline")this.style.display="inline-block";else{this.style.display="inline";this.style.zoom=1}}}}if(opt.overflow!=null)this.style.overflow="hidden";for(p in prop){e=new jQuery.fx(this,
opt,p);val=prop[p];if(rfxtypes.test(val))e[val==="toggle"?hidden?"show":"hide":val]();else{parts=rfxnum.exec(val);start=e.cur();if(parts){end=parseFloat(parts[2]);unit=parts[3]||(jQuery.cssNumber[p]?"":"px");if(unit!=="px"){jQuery.style(this,p,(end||1)+unit);start=(end||1)/e.cur()*start;jQuery.style(this,p,start+unit)}if(parts[1])end=(parts[1]==="-="?-1:1)*end+start;e.custom(start,end,unit)}else e.custom(start,val,"")}}return true})},stop:function(clearQueue,gotoEnd){if(clearQueue)this.queue([]);
this.each(function(){var timers=jQuery.timers,i=timers.length;if(!gotoEnd)jQuery._unmark(true,this);while(i--)if(timers[i].elem===this){if(gotoEnd)timers[i](true);timers.splice(i,1)}});if(!gotoEnd)this.dequeue();return this}});function createFxNow(){setTimeout(clearFxNow,0);return fxNow=jQuery.now()}function clearFxNow(){fxNow=undefined}function genFx(type,num){var obj={};jQuery.each(fxAttrs.concat.apply([],fxAttrs.slice(0,num)),function(){obj[this]=type});return obj}jQuery.each({slideDown:genFx("show",
1),slideUp:genFx("hide",1),slideToggle:genFx("toggle",1),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(name,props){jQuery.fn[name]=function(speed,easing,callback){return this.animate(props,speed,easing,callback)}});jQuery.extend({speed:function(speed,easing,fn){var opt=speed&&typeof speed==="object"?jQuery.extend({},speed):{complete:fn||!fn&&easing||jQuery.isFunction(speed)&&speed,duration:speed,easing:fn&&easing||easing&&!jQuery.isFunction(easing)&&easing};
opt.duration=jQuery.fx.off?0:typeof opt.duration==="number"?opt.duration:opt.duration in jQuery.fx.speeds?jQuery.fx.speeds[opt.duration]:jQuery.fx.speeds._default;opt.old=opt.complete;opt.complete=function(noUnmark){if(jQuery.isFunction(opt.old))opt.old.call(this);if(opt.queue!==false)jQuery.dequeue(this);else if(noUnmark!==false)jQuery._unmark(this)};return opt},easing:{linear:function(p,n,firstNum,diff){return firstNum+diff*p},swing:function(p,n,firstNum,diff){return(-Math.cos(p*Math.PI)/2+0.5)*
diff+firstNum}},timers:[],fx:function(elem,options,prop){this.options=options;this.elem=elem;this.prop=prop;options.orig=options.orig||{}}});jQuery.fx.prototype={update:function(){if(this.options.step)this.options.step.call(this.elem,this.now,this);(jQuery.fx.step[this.prop]||jQuery.fx.step._default)(this)},cur:function(){if(this.elem[this.prop]!=null&&(!this.elem.style||this.elem.style[this.prop]==null))return this.elem[this.prop];var parsed,r=jQuery.css(this.elem,this.prop);return isNaN(parsed=
parseFloat(r))?!r||r==="auto"?0:r:parsed},custom:function(from,to,unit){var self=this,fx=jQuery.fx,raf;this.startTime=fxNow||createFxNow();this.start=from;this.end=to;this.unit=unit||this.unit||(jQuery.cssNumber[this.prop]?"":"px");this.now=this.start;this.pos=this.state=0;function t(gotoEnd){return self.step(gotoEnd)}t.elem=this.elem;if(t()&&jQuery.timers.push(t)&&!timerId)if(requestAnimationFrame){timerId=true;raf=function(){if(timerId){requestAnimationFrame(raf);fx.tick()}};requestAnimationFrame(raf)}else timerId=
setInterval(fx.tick,fx.interval)},show:function(){this.options.orig[this.prop]=jQuery.style(this.elem,this.prop);this.options.show=true;this.custom(this.prop==="width"||this.prop==="height"?1:0,this.cur());jQuery(this.elem).show()},hide:function(){this.options.orig[this.prop]=jQuery.style(this.elem,this.prop);this.options.hide=true;this.custom(this.cur(),0)},step:function(gotoEnd){var t=fxNow||createFxNow(),done=true,elem=this.elem,options=this.options,i,n;if(gotoEnd||t>=options.duration+this.startTime){this.now=
this.end;this.pos=this.state=1;this.update();options.animatedProperties[this.prop]=true;for(i in options.animatedProperties)if(options.animatedProperties[i]!==true)done=false;if(done){if(options.overflow!=null&&!jQuery.support.shrinkWrapBlocks)jQuery.each(["","X","Y"],function(index,value){elem.style["overflow"+value]=options.overflow[index]});if(options.hide)jQuery(elem).hide();if(options.hide||options.show)for(var p in options.animatedProperties)jQuery.style(elem,p,options.orig[p]);options.complete.call(elem)}return false}else{if(options.duration==
Infinity)this.now=t;else{n=t-this.startTime;this.state=n/options.duration;this.pos=jQuery.easing[options.animatedProperties[this.prop]](this.state,n,0,1,options.duration);this.now=this.start+(this.end-this.start)*this.pos}this.update()}return true}};jQuery.extend(jQuery.fx,{tick:function(){for(var timers=jQuery.timers,i=0;i<timers.length;++i)if(!timers[i]())timers.splice(i--,1);if(!timers.length)jQuery.fx.stop()},interval:13,stop:function(){clearInterval(timerId);timerId=null},speeds:{slow:600,fast:200,
_default:400},step:{opacity:function(fx){jQuery.style(fx.elem,"opacity",fx.now)},_default:function(fx){if(fx.elem.style&&fx.elem.style[fx.prop]!=null)fx.elem.style[fx.prop]=(fx.prop==="width"||fx.prop==="height"?Math.max(0,fx.now):fx.now)+fx.unit;else fx.elem[fx.prop]=fx.now}}});if(jQuery.expr&&jQuery.expr.filters)jQuery.expr.filters.animated=function(elem){return jQuery.grep(jQuery.timers,function(fn){return elem===fn.elem}).length};function defaultDisplay(nodeName){if(!elemdisplay[nodeName]){var body=
document.body,elem=jQuery("<"+nodeName+">").appendTo(body),display=elem.css("display");elem.remove();if(display==="none"||display===""){if(!iframe){iframe=document.createElement("iframe");iframe.frameBorder=iframe.width=iframe.height=0}body.appendChild(iframe);if(!iframeDoc||!iframe.createElement){iframeDoc=(iframe.contentWindow||iframe.contentDocument).document;iframeDoc.write((document.compatMode==="CSS1Compat"?"<!doctype html>":"")+"<html><body>");iframeDoc.close()}elem=iframeDoc.createElement(nodeName);
iframeDoc.body.appendChild(elem);display=jQuery.css(elem,"display");body.removeChild(iframe)}elemdisplay[nodeName]=display}return elemdisplay[nodeName]}var rtable=/^t(?:able|d|h)$/i,rroot=/^(?:body|html)$/i;if("getBoundingClientRect"in document.documentElement)jQuery.fn.offset=function(options){var elem=this[0],box;if(options)return this.each(function(i){jQuery.offset.setOffset(this,options,i)});if(!elem||!elem.ownerDocument)return null;if(elem===elem.ownerDocument.body)return jQuery.offset.bodyOffset(elem);
try{box=elem.getBoundingClientRect()}catch(e){}var doc=elem.ownerDocument,docElem=doc.documentElement;if(!box||!jQuery.contains(docElem,elem))return box?{top:box.top,left:box.left}:{top:0,left:0};var body=doc.body,win=getWindow(doc),clientTop=docElem.clientTop||body.clientTop||0,clientLeft=docElem.clientLeft||body.clientLeft||0,scrollTop=win.pageYOffset||jQuery.support.boxModel&&docElem.scrollTop||body.scrollTop,scrollLeft=win.pageXOffset||jQuery.support.boxModel&&docElem.scrollLeft||body.scrollLeft,
top=box.top+scrollTop-clientTop,left=box.left+scrollLeft-clientLeft;return{top:top,left:left}};else jQuery.fn.offset=function(options){var elem=this[0];if(options)return this.each(function(i){jQuery.offset.setOffset(this,options,i)});if(!elem||!elem.ownerDocument)return null;if(elem===elem.ownerDocument.body)return jQuery.offset.bodyOffset(elem);jQuery.offset.initialize();var computedStyle,offsetParent=elem.offsetParent,prevOffsetParent=elem,doc=elem.ownerDocument,docElem=doc.documentElement,body=
doc.body,defaultView=doc.defaultView,prevComputedStyle=defaultView?defaultView.getComputedStyle(elem,null):elem.currentStyle,top=elem.offsetTop,left=elem.offsetLeft;while((elem=elem.parentNode)&&elem!==body&&elem!==docElem){if(jQuery.offset.supportsFixedPosition&&prevComputedStyle.position==="fixed")break;computedStyle=defaultView?defaultView.getComputedStyle(elem,null):elem.currentStyle;top-=elem.scrollTop;left-=elem.scrollLeft;if(elem===offsetParent){top+=elem.offsetTop;left+=elem.offsetLeft;if(jQuery.offset.doesNotAddBorder&&
!(jQuery.offset.doesAddBorderForTableAndCells&&rtable.test(elem.nodeName))){top+=parseFloat(computedStyle.borderTopWidth)||0;left+=parseFloat(computedStyle.borderLeftWidth)||0}prevOffsetParent=offsetParent;offsetParent=elem.offsetParent}if(jQuery.offset.subtractsBorderForOverflowNotVisible&&computedStyle.overflow!=="visible"){top+=parseFloat(computedStyle.borderTopWidth)||0;left+=parseFloat(computedStyle.borderLeftWidth)||0}prevComputedStyle=computedStyle}if(prevComputedStyle.position==="relative"||
prevComputedStyle.position==="static"){top+=body.offsetTop;left+=body.offsetLeft}if(jQuery.offset.supportsFixedPosition&&prevComputedStyle.position==="fixed"){top+=Math.max(docElem.scrollTop,body.scrollTop);left+=Math.max(docElem.scrollLeft,body.scrollLeft)}return{top:top,left:left}};jQuery.offset={initialize:function(){var body=document.body,container=document.createElement("div"),innerDiv,checkDiv,table,td,bodyMarginTop=parseFloat(jQuery.css(body,"marginTop"))||0,html="<div style='position:absolute;top:0;left:0;margin:0;border:5px solid #000;padding:0;width:1px;height:1px;'><div></div></div><table style='position:absolute;top:0;left:0;margin:0;border:5px solid #000;padding:0;width:1px;height:1px;' cellpadding='0' cellspacing='0'><tr><td></td></tr></table>";
jQuery.extend(container.style,{position:"absolute",top:0,left:0,margin:0,border:0,width:"1px",height:"1px",visibility:"hidden"});container.innerHTML=html;body.insertBefore(container,body.firstChild);innerDiv=container.firstChild;checkDiv=innerDiv.firstChild;td=innerDiv.nextSibling.firstChild.firstChild;this.doesNotAddBorder=checkDiv.offsetTop!==5;this.doesAddBorderForTableAndCells=td.offsetTop===5;checkDiv.style.position="fixed";checkDiv.style.top="20px";this.supportsFixedPosition=checkDiv.offsetTop===
20||checkDiv.offsetTop===15;checkDiv.style.position=checkDiv.style.top="";innerDiv.style.overflow="hidden";innerDiv.style.position="relative";this.subtractsBorderForOverflowNotVisible=checkDiv.offsetTop===-5;this.doesNotIncludeMarginInBodyOffset=body.offsetTop!==bodyMarginTop;body.removeChild(container);jQuery.offset.initialize=jQuery.noop},bodyOffset:function(body){var top=body.offsetTop,left=body.offsetLeft;jQuery.offset.initialize();if(jQuery.offset.doesNotIncludeMarginInBodyOffset){top+=parseFloat(jQuery.css(body,
"marginTop"))||0;left+=parseFloat(jQuery.css(body,"marginLeft"))||0}return{top:top,left:left}},setOffset:function(elem,options,i){var position=jQuery.css(elem,"position");if(position==="static")elem.style.position="relative";var curElem=jQuery(elem),curOffset=curElem.offset(),curCSSTop=jQuery.css(elem,"top"),curCSSLeft=jQuery.css(elem,"left"),calculatePosition=(position==="absolute"||position==="fixed")&&jQuery.inArray("auto",[curCSSTop,curCSSLeft])>-1,props={},curPosition={},curTop,curLeft;if(calculatePosition){curPosition=
curElem.position();curTop=curPosition.top;curLeft=curPosition.left}else{curTop=parseFloat(curCSSTop)||0;curLeft=parseFloat(curCSSLeft)||0}if(jQuery.isFunction(options))options=options.call(elem,i,curOffset);if(options.top!=null)props.top=options.top-curOffset.top+curTop;if(options.left!=null)props.left=options.left-curOffset.left+curLeft;if("using"in options)options.using.call(elem,props);else curElem.css(props)}};jQuery.fn.extend({position:function(){if(!this[0])return null;var elem=this[0],offsetParent=
this.offsetParent(),offset=this.offset(),parentOffset=rroot.test(offsetParent[0].nodeName)?{top:0,left:0}:offsetParent.offset();offset.top-=parseFloat(jQuery.css(elem,"marginTop"))||0;offset.left-=parseFloat(jQuery.css(elem,"marginLeft"))||0;parentOffset.top+=parseFloat(jQuery.css(offsetParent[0],"borderTopWidth"))||0;parentOffset.left+=parseFloat(jQuery.css(offsetParent[0],"borderLeftWidth"))||0;return{top:offset.top-parentOffset.top,left:offset.left-parentOffset.left}},offsetParent:function(){return this.map(function(){var offsetParent=
this.offsetParent||document.body;while(offsetParent&&!rroot.test(offsetParent.nodeName)&&jQuery.css(offsetParent,"position")==="static")offsetParent=offsetParent.offsetParent;return offsetParent})}});jQuery.each(["Left","Top"],function(i,name){var method="scroll"+name;jQuery.fn[method]=function(val){var elem,win;if(val===undefined){elem=this[0];if(!elem)return null;win=getWindow(elem);return win?"pageXOffset"in win?win[i?"pageYOffset":"pageXOffset"]:jQuery.support.boxModel&&win.document.documentElement[method]||
win.document.body[method]:elem[method]}return this.each(function(){win=getWindow(this);if(win)win.scrollTo(!i?val:jQuery(win).scrollLeft(),i?val:jQuery(win).scrollTop());else this[method]=val})}});function getWindow(elem){return jQuery.isWindow(elem)?elem:elem.nodeType===9?elem.defaultView||elem.parentWindow:false}jQuery.each(["Height","Width"],function(i,name){var type=name.toLowerCase();jQuery.fn["inner"+name]=function(){var elem=this[0];return elem&&elem.style?parseFloat(jQuery.css(elem,type,"padding")):
null};jQuery.fn["outer"+name]=function(margin){var elem=this[0];return elem&&elem.style?parseFloat(jQuery.css(elem,type,margin?"margin":"border")):null};jQuery.fn[type]=function(size){var elem=this[0];if(!elem)return size==null?null:this;if(jQuery.isFunction(size))return this.each(function(i){var self=jQuery(this);self[type](size.call(this,i,self[type]()))});if(jQuery.isWindow(elem)){var docElemProp=elem.document.documentElement["client"+name];return elem.document.compatMode==="CSS1Compat"&&docElemProp||
elem.document.body["client"+name]||docElemProp}else if(elem.nodeType===9)return Math.max(elem.documentElement["client"+name],elem.body["scroll"+name],elem.documentElement["scroll"+name],elem.body["offset"+name],elem.documentElement["offset"+name]);else if(size===undefined){var orig=jQuery.css(elem,type),ret=parseFloat(orig);return jQuery.isNaN(ret)?orig:ret}else return this.css(type,typeof size==="string"?size:size+"px")}});window.jQuery=window.$=jQuery})(window);Console={};Console.puts=function(str,no_newline){var console;var text;console=$("#bs-console");if(console[0]){text=_.escapeHTML(str+(no_newline?"":"\n"));var span=$("<span>");span.html(text.replace(/\n/g,"<br>").replace(/ /g,"&nbsp;"));console.append(span)}};Console.p=function(){Console.puts("p> "+_.map(_.toArray(arguments),BiwaScheme.inspect).join(" "))};with(BiwaScheme)BiwaScheme.Dumper=BiwaScheme.Class.create({initialize:function(dumparea){this.dumparea=dumparea||$("#dumparea")[0]||null;this.reset()},reset:function(){if(this.dumparea)$(this.dumparea).empty();this.n_folds=0;this.closures=[];this.n_dumps=0;this.cur=-1;this.is_folded=true},is_opc:function(obj){return obj instanceof Array&&typeof obj[0]=="string"},dump_pad:"&nbsp;&nbsp;&nbsp;",dump_opc:function(obj,level){var s="";var pad1="",pad2="";var level=level||0;_.times(level,_.bind(function(){pad1+=
this.dump_pad},this));_.times(level+1,_.bind(function(){pad2+=this.dump_pad},this));s+=pad1+'[<span class="dump_opecode">'+obj[0]+"</span>";var i=1;while(!(obj[i]instanceof Array)&&i<obj.length){if(obj[0]=="constant")s+="&nbsp;<span class='dump_constant'>"+this.dump_obj(obj[i])+"</span>";else s+="&nbsp;"+this.dump_obj(obj[i]);i++}if(i<obj.length)s+="<br>\n";for(;i<obj.length;i++){if(this.is_opc(obj[i]))s+=this.dump_opc(obj[i],i==obj.length-1?level:level+1);else{s+=i==obj.length-1?pad1:pad2;s+=this.dump_obj(obj[i])}if(i!=
obj.length-1)s+="<br>\n"}s+="]";return level==0?this.add_fold(s):s},fold_limit:20,add_fold:function(s){var lines=s.split(/<br>/gmi);if(lines.length>this.fold_limit){var fold_btn=" <span style='text-decoration:underline; color:blue; cursor:pointer;'"+"onclick='BiwaScheme.Dumper.toggle_fold("+this.n_folds+")'>more</span>";var fold_start="<div style='display:none' id='fold"+this.n_folds+"'>";var fold_end="</div>";this.n_folds++;return[lines.slice(0,this.fold_limit).join("<br>"),fold_btn,fold_start,lines.slice(this.fold_limit+
1).join("<br>"),fold_end].join("")}else return s},stack_max_len:80,dump_stack:function(stk,size){if(stk===null||stk===undefined)return BiwaScheme.inspect(stk);var s="<table>";if(stk.length==0)s+="<tr><td class='dump_dead'>(stack is empty)</td></tr>";else if(size<stk.length){var l=stk.length-1;s+="<tr><td class='dump_dead'>["+l+"]</td>"+"<td class='dump_dead'>"+_.truncate(this.dump_obj(stk[l]),this.stack_max_len)+"</td></tr>"}for(var i=size-1;i>=0;i--)s+="<tr><td class='dump_stknum'>["+i+"]</td>"+
"<td>"+_.truncate(this.dump_obj(stk[i]),this.stack_max_len)+"</td></tr>";return s+"</table>"},dump_object:function(obj){var a=[];for(var k in obj)a.push(k.toString());return"#<Object{"+a.join(",")+"}>"},dump_closure:function(cls){if(cls.length==0)return"[]";var cls_num=null;for(var i=0;i<this.closures.length;i++)if(this.closures[i]==cls)cls_num=i;if(cls_num==null){cls_num=this.closures.length;this.closures.push(cls)}var c=_.clone(cls);var body=c.shift();return["c",cls_num," <span class='dump_closure'>free vars :</span> ",
this.dump_obj(c)," <span class='dump_closure'>body :</span> ",_.truncate(this.dump_obj(body),100)].join("")},dump_obj:function(obj){if(obj&&typeof obj.to_html=="function")return obj.to_html();else{var s=write_ss(obj,true);if(s=="[object Object]")s=this.dump_object(obj);return _.escapeHTML(s)}},dump:function(obj){var s="";if(obj instanceof Object){s+="<table>";s+="<tr><td colspan='4'>"+"<a href='#' id='dump_"+this.n_dumps+"_header'>"+"#"+this.n_dumps+"</a></td></tr>";_.each(_.keys(obj),_.bind(function(key){var value=
obj[key];if(key!="x"&&key!="stack"){value=key=="c"?this.dump_closure(value):this.dump_obj(value);s+="<tr><td>"+key+": </td>"+"<td colspan='3'>"+value+"</td></tr>"}},this));s+="<tr><td>x:</td><td>"+(this.is_opc(obj["x"])?this.dump_opc(obj["x"]):this.dump_obj(obj["x"]))+"</td>";s+="<td style='border-left: 1px solid black'>stack:</td><td>"+this.dump_stack(obj["stack"],obj["s"])+"</td></tr>";s+="</table>"}else s=_.escapeHTML(BiwaScheme.inspect(obj))+"<br>\n";var dumpitem=$("<div/>",{id:"dump"+this.n_dumps});
dumpitem.html(s);$(this.dumparea).append(dumpitem);_.bind(function(n){$("#dump_"+this.n_dumps+"_header").click(_.bind(function(){this.dump_move_to(n);this.dump_fold()},this))},this)(this.n_dumps);dumpitem.hide();this.n_dumps++},dump_move_to:function(n){if(0<=n&&n<=this.n_dumps){$("#dump"+this.cur).hide();this.cur=n;$("#dump"+this.cur).show()}},dump_move:function(dir){if(0<=this.cur&&this.cur<this.n_dumps)$("#dump"+this.cur).hide();if(0<=this.cur+dir&&this.cur+dir<this.n_dumps)this.cur+=dir;$("#dump"+
this.cur).show()},dump_fold:function(){for(var i=0;i<this.n_dumps;i++)if(i!=this.cur)$("#dump"+i).hide();this.is_folded=true},dump_unfold:function(){for(var i=0;i<this.n_dumps;i++)$("#dump"+i).show();this.is_folded=false},dump_toggle_fold:function(){if(this.is_folded)this.dump_unfold();else this.dump_fold()}});BiwaScheme.Dumper.toggle_fold=function(n){$("#fold"+n).toggle()};
